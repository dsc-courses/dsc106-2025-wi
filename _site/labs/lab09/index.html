<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><title>Lab 9: Animation &amp; Scrollytelling | DSC 106</title><meta name="generator" content="Jekyll v3.9.0" /><meta property="og:title" content="Lab 9: Animation &amp; Scrollytelling" /><meta name="author" content="Sam Lau" /><meta property="og:locale" content="en_US" /><meta name="description" content="DSC 106, Winter 2025 at UC San Diego" /><meta property="og:description" content="DSC 106, Winter 2025 at UC San Diego" /><link rel="canonical" href="http://localhost:4000/labs/lab09/" /><meta property="og:url" content="http://localhost:4000/labs/lab09/" /><meta property="og:site_name" content="DSC 106" /><meta property="og:type" content="website" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Lab 9: Animation &amp; Scrollytelling" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Sam Lau"},"description":"DSC 106, Winter 2025 at UC San Diego","headline":"Lab 9: Animation &amp; Scrollytelling","url":"http://localhost:4000/labs/lab09/"}</script><body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> </svg><div class="side-bar"><div class="site-header"> <a href="/" class="site-title lh-tight"> DSC 106 </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a></div><nav aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">üè† Home</a><li class="nav-list-item"><a href="/syllabus/" class="nav-list-link">üìñ Syllabus</a><li class="nav-list-item"><a href="/calendar/" class="nav-list-link">üìÜ Calendar</a><li class="nav-list-item"><a href="/tech_support/" class="nav-list-link">üôã‚Äç‚ôÇÔ∏è Tech Support</a><li class="nav-list-item"><a href="/resources/" class="nav-list-link">üìö Resources</a><li class="nav-list-item"><a href="/staff/" class="nav-list-link">üë©‚Äçüè´ Staff</a><li class="nav-list-item active"><a href="#" class="nav-list-expander" aria-label="toggle links in üë©‚Äçüî¨ Programming Labs category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/labs/" class="nav-list-link">üë©‚Äçüî¨ Programming Labs</a><ul class="nav-list "><li class="nav-list-item "><a href="/labs/debugging/" class="nav-list-link">Help Us Help You: Things to try before asking for help</a><li class="nav-list-item "><a href="/labs/lab00/" class="nav-list-link">Lab 0: Setup</a><li class="nav-list-item "><a href="/labs/lab01/" class="nav-list-link">Lab 1: Introduction to the Web platform</a><li class="nav-list-item "><a href="/labs/lab02/" class="nav-list-link">Lab 2: Styling with CSS</a><li class="nav-list-item "><a href="/labs/lab03/" class="nav-list-link">Lab 3: Introduction to JS</a><li class="nav-list-item "><a href="/labs/lab04/" class="nav-list-link">Lab 4: Svelte (Templating & Control Flow)</a><li class="nav-list-item "><a href="/labs/lab05/" class="nav-list-link">Lab 5: Svelte II (Loading Data & Reactivity)</a><li class="nav-list-item "><a href="/labs/lab06/" class="nav-list-link">Lab 6: Visualizing categorical data with D3</a><li class="nav-list-item "><a href="/labs/lab07/" class="nav-list-link">Lab 7: Visualizing quantitative data with D3</a><li class="nav-list-item "><a href="/labs/lab08/" class="nav-list-link">Lab 8: Geospatial Visualizations</a><li class="nav-list-item active"><a href="/labs/lab09/" class="nav-list-link active">Lab 9: Animation & Scrollytelling</a></ul><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in üìù Projects category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/projects/" class="nav-list-link">üìù Projects</a><ul class="nav-list "><li class="nav-list-item "><a href="/projects/final_project/" class="nav-list-link">Final Project</a><li class="nav-list-item "><a href="/projects/project1/" class="nav-list-link">Project 1: Expository Visualization</a><li class="nav-list-item "><a href="/projects/project2/" class="nav-list-link">Project 2: Deceptive Visualization</a><li class="nav-list-item "><a href="/projects/project2peer/" class="nav-list-link">Project 2: Deceptive Visualization - Peer Grading</a><li class="nav-list-item "><a href="/projects/project3/" class="nav-list-link">Project 3: Interactive Visualization</a><li class="nav-list-item "><a href="/projects/project3peer/" class="nav-list-link">Project 3: Interactive Visualization - Peer Grading</a></ul><li class="nav-list-item"><a href="/labs/lab09/todo/" class="nav-list-link">For next year</a><li class="nav-list-item"><a href="/labs/lab07/old/" class="nav-list-link">Old content, ignore</a><li class="nav-list-item"><a href="/labs/lab09/playtesting/" class="nav-list-link">Playtesting</a><li class="nav-list-item"><a href="/labs/lab05/playtesting/" class="nav-list-link">Playtesting</a><li class="nav-list-item"><a href="/labs/lab06/playtesting/" class="nav-list-link">Playtesting</a><li class="nav-list-item"><a href="/labs/lab07/playtesting/" class="nav-list-link">Playtesting</a><li class="nav-list-item"><a href="/labs/lab08/playtesting/" class="nav-list-link">Playtesting</a><li class="nav-list-item"><a href="/labs/lab02/playtesting/" class="nav-list-link">Playtesting Lab 2</a><li class="nav-list-item"><a href="/labs/lab04/playtesting/enrique/" class="nav-list-link">create-svelte</a><li class="nav-list-item"><a href="/labs/lab04/playtesting/" class="nav-list-link">create-svelte</a></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search DSC 106" aria-label="Search DSC 106" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="" class="site-button" > üíª GitHub </a><li class="aux-nav-list-item"> <a href="" class="site-button" > üôã Ed </a><li class="aux-nav-list-item"> <a href="" class="site-button" > üíØ Gradescope </a></ul></nav></div><div id="main-content-wrap" class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="/labs/">üë©‚Äçüî¨ Programming Labs</a><li class="breadcrumb-nav-list-item"><span>Lab 9: Animation & Scrollytelling</span></ol></nav><div id="main-content" class="main-content" role="main"><h1 id="lab-9-animation"> <a href="#lab-9-animation" class="anchor-heading" aria-labelledby="lab-9-animation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Lab 9: Animation</h1><blockquote class="no_toc summary"><p>In this lab, we will learn:</p><ul><li>What different methods do we have to transition and animate elements and when to use each?<li>What considerations should we take into account for using animations effectively?</ul></blockquote><details open=""> <summary class="text-delta"> Table of contents </summary><ul id="markdown-toc"><li><a href="#lab-9-animation" id="markdown-toc-lab-9-animation">Lab 9: Animation</a><ul><li><a href="#check-off" id="markdown-toc-check-off">Check-off</a><li><a href="#slides" id="markdown-toc-slides">Slides</a><li><a href="#what-will-we-make" id="markdown-toc-what-will-we-make">What will we make?</a><li><a href="#step-0-preparation" id="markdown-toc-step-0-preparation">Step 0: Preparation</a><ul><li><a href="#step-01-making-commits-clickable" id="markdown-toc-step-01-making-commits-clickable">Step 0.1: Making commits clickable</a><li><a href="#step-02-iterating-over-data-not-arcs" id="markdown-toc-step-02-iterating-over-data-not-arcs">Step 0.2: Iterating over data, not arcs</a><li><a href="#step-03-moving-all-info-to-the-same-data-structure" id="markdown-toc-step-03-moving-all-info-to-the-same-data-structure">Step 0.3: Moving all info to the same data structure</a></ul><li><a href="#step-1-evolution-visualization" id="markdown-toc-step-1-evolution-visualization">Step 1: Evolution visualization</a><ul><li><a href="#step-11-creating-the-filtering-ui" id="markdown-toc-step-11-creating-the-filtering-ui">Step 1.1: Creating the filtering UI</a><li><a href="#step-12-filtering-by-commitmaxtime" id="markdown-toc-step-12-filtering-by-commitmaxtime">Step 1.2: Filtering by <code class="language-plaintext highlighter-rouge">commitMaxTime</code></a><li><a href="#step-13-making-the-circles-stable" id="markdown-toc-step-13-making-the-circles-stable">Step 1.3: Making the circles stable</a><li><a href="#step-14-entry-transitions-with-css" id="markdown-toc-step-14-entry-transitions-with-css">Step 1.4: Entry transitions with CSS</a><li><a href="#step-15-moving-the-scatterplot-into-a-separate-component-optional-but-recommended" id="markdown-toc-step-15-moving-the-scatterplot-into-a-separate-component-optional-but-recommended">Step 1.5: Moving the scatterplot into a separate component <em>(optional, but recommended)</em></a></ul><li><a href="#step-2-the-race-for-the-biggest-file" id="markdown-toc-step-2-the-race-for-the-biggest-file">Step 2: The race for the biggest file!</a><ul><li><a href="#step-21-creating-a-component-for-the-unit-visualization" id="markdown-toc-step-21-creating-a-component-for-the-unit-visualization">Step 2.1: Creating a component for the unit visualization</a><li><a href="#step-22-making-it-look-like-an-actual-unit-visualization" id="markdown-toc-step-22-making-it-look-like-an-actual-unit-visualization">Step 2.2: Making it look like an actual unit visualization</a><li><a href="#step-23-sorting-files-by-number-of-lines" id="markdown-toc-step-23-sorting-files-by-number-of-lines">Step 2.3: Sorting files by number of lines</a><li><a href="#step-24-varying-the-color-of-the-dots-by-technology" id="markdown-toc-step-24-varying-the-color-of-the-dots-by-technology">Step 2.4: Varying the color of the dots by technology</a><li><a href="#step-25-dot-transitions" id="markdown-toc-step-25-dot-transitions">Step 2.5: Dot transitions</a><li><a href="#step-26-consistent-colors-across-visualizations" id="markdown-toc-step-26-consistent-colors-across-visualizations">Step 2.6: Consistent colors across visualizations</a><li><a href="#step-27-animated-race" id="markdown-toc-step-27-animated-race">Step 2.7: Animated race</a></ul><li><a href="#step-3-pie-chart-transition" id="markdown-toc-step-3-pie-chart-transition">Step 3: Pie chart transition</a><ul><li><a href="#step-31-use-consistent-ordering" id="markdown-toc-step-31-use-consistent-ordering">Step 3.1: Use consistent ordering</a><li><a href="#step-32-eliminate-flashing-by-using-a-keyed-each-block" id="markdown-toc-step-32-eliminate-flashing-by-using-a-keyed-each-block">Step 3.2: Eliminate flashing by using a keyed <code class="language-plaintext highlighter-rouge">each</code> block</a><li><a href="#step-33-fixing-the-shape-transition-using-d3transition" id="markdown-toc-step-33-fixing-the-shape-transition-using-d3transition">Step 3.3: Fixing the shape transition using <code class="language-plaintext highlighter-rouge">d3.transition()</code></a><ul><li><a href="#how-to-get-a-reference-to-the-dom-elements-we-are-transitioning" id="markdown-toc-how-to-get-a-reference-to-the-dom-elements-we-are-transitioning">How to get a reference to the DOM elements we are transitioning?</a><li><a href="#when-to-call-d3transition" id="markdown-toc-when-to-call-d3transition">When to call <code class="language-plaintext highlighter-rouge">d3.transition()</code>?</a><li><a href="#how-to-read-the-previous-state" id="markdown-toc-how-to-read-the-previous-state">How to read the previous state?</a></ul><li><a href="#step-34-transitioning-between-pies-with-different-technologies" id="markdown-toc-step-34-transitioning-between-pies-with-different-technologies">Step 3.4: Transitioning between pies with different technologies</a><li><a href="#step-35-harmonizing-easing-across-the-d3-and-svelte-transitions" id="markdown-toc-step-35-harmonizing-easing-across-the-d3-and-svelte-transitions">Step 3.5: Harmonizing easing across the D3 and Svelte transitions</a></ul><li><a href="#step-4-scrollytelling-part-1-commits-over-time" id="markdown-toc-step-4-scrollytelling-part-1-commits-over-time">Step 4: Scrollytelling Part 1 (commits over time)</a><ul><li><a href="#step-40-making-our-page-a-bit-wider-if-there-is-space" id="markdown-toc-step-40-making-our-page-a-bit-wider-if-there-is-space">Step 4.0: Making our page a bit wider, if there is space</a><li><a href="#step-41-using-a-scrolly" id="markdown-toc-step-41-using-a-scrolly">Step 4.1: Using a scrolly</a><li><a href="#step-42-creating-a-dummy-narrative" id="markdown-toc-step-42-creating-a-dummy-narrative">Step 4.2: Creating a dummy narrative</a><li><a href="#step-43-creating-a-scroller-for-our-commits-over-time" id="markdown-toc-step-43-creating-a-scroller-for-our-commits-over-time">Step 4.3: Creating a scroller for our commits over time</a></ul><li><a href="#step-5-scrollytelling-part-2-file-sizes" id="markdown-toc-step-5-scrollytelling-part-2-file-sizes">Step 5: Scrollytelling Part 2 (file sizes)</a><ul><li><a href="#step-51-adding-another-scrolly" id="markdown-toc-step-51-adding-another-scrolly">Step 5.1: Adding another scrolly</a><li><a href="#step-52-limit-number-of-updates" id="markdown-toc-step-52-limit-number-of-updates">Step 5.2: Limit number of updates</a></ul><li><a href="#resources" id="markdown-toc-resources">Resources</a><ul><li><a href="#transitions--animations" id="markdown-toc-transitions--animations">Transitions &amp; Animations</a><li><a href="#scrollytelling" id="markdown-toc-scrollytelling">Scrollytelling</a></ul></ul></ul></details><hr /><h2 id="check-off"> <a href="#check-off" class="anchor-heading" aria-labelledby="check-off"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Check-off</h2><p><strong>You need to come to TA Office Hours to get checked off for this lab</strong> (any of them, no appointment needed). Please fill in <a href="checkoff">the check-off form at <code class="language-plaintext highlighter-rouge">labs/9/checkoff</code></a> <em>before</em> your check-off. Ideally you should fill in the form <em>right before</em> your check-off, but it‚Äôs ok if you fill it out in advance.</p><p class="warning">Filling out the form is a necessary but not sufficient condition to get checked-off. <strong>You still need to come to office hours in person for your check-off to be processed.</strong></p><p>You could even fill it out before you finish the lab, since we won‚Äôt look at it until your check-off, but the closer to the end of the lab you fill it out, the more meaningful your feedback will be.</p><h2 id="slides"> <a href="#slides" class="anchor-heading" aria-labelledby="slides"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a href="./slides/">Slides</a></h2><ul><li><a href="./slides/#technologies">Relevant technologies (summary slide)</a></ul><h2 id="what-will-we-make"> <a href="#what-will-we-make" class="anchor-heading" aria-labelledby="what-will-we-make"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> What will we make?</h2><p>In this lab, we will go back to the Meta page of our portfolio, and convert it to an interactive narrative visualization that shows the progress of our codebase over time.</p><video src="videos/final.mp4" loading="lazy" muted="" autoplay="" loop="" class="browser"></video><h2 id="step-0-preparation"> <a href="#step-0-preparation" class="anchor-heading" aria-labelledby="step-0-preparation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 0: Preparation</h2><p>To make this lab a little easier, we will follow a few prepratory steps in this section.</p><h3 id="step-01-making-commits-clickable"> <a href="#step-01-making-commits-clickable" class="anchor-heading" aria-labelledby="step-01-making-commits-clickable"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 0.1: Making commits clickable</h3><p class="files"><code class="language-plaintext highlighter-rouge">src/meta/+page.svelte</code></p><p>Currently, the only way to select commits is by brushing the pie chart. While this is great for selecting multiple commits and seeing stats about the whole group, it is not very user-friendly for selecting individual commits.</p><p>Furthermore, you will need to alternate between selections a lot to debug your work in Step 1, so it pays off to make this easier.</p><p>Before we can add the right event handling to make click selections possible, we need to make a few changes to our code. Our <code class="language-plaintext highlighter-rouge">selectedCommits</code> variable is currently reactive, and depends on <code class="language-plaintext highlighter-rouge">brushSelection</code>:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">:</span> <span class="nx">selectedCommits</span> <span class="o">=</span> <span class="nx">brushSelection</span> <span class="p">?</span> <span class="nx">commits</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">isCommitSelected</span><span class="p">)</span> <span class="p">:</span> <span class="p">[];</span>
</code></pre></div></div><p>We also have an <code class="language-plaintext highlighter-rouge">isCommitSelected()</code> function, which checks of a commit is within the <code class="language-plaintext highlighter-rouge">brushSelection</code> and looks like this:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">isCommitSelected</span><span class="p">(</span><span class="nx">commit</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">brushSelection</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">manualSelection</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">manualSelection</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">commit</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">let</span> <span class="nx">min</span> <span class="o">=</span> <span class="p">{</span> <span class="na">x</span><span class="p">:</span> <span class="nx">brushSelection</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="na">y</span><span class="p">:</span> <span class="nx">brushSelection</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">};</span>
  <span class="kd">let</span> <span class="nx">max</span> <span class="o">=</span> <span class="p">{</span> <span class="na">x</span><span class="p">:</span> <span class="nx">brushSelection</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="na">y</span><span class="p">:</span> <span class="nx">brushSelection</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">};</span>
  <span class="kd">let</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">xScale</span><span class="p">(</span><span class="nx">commit</span><span class="p">.</span><span class="nx">date</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">yScale</span><span class="p">(</span><span class="nx">commit</span><span class="p">.</span><span class="nx">hourFrac</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">x</span> <span class="o">&gt;=</span> <span class="nx">min</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">x</span> <span class="o">&lt;=</span> <span class="nx">max</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">y</span> <span class="o">&gt;=</span> <span class="nx">min</span><span class="p">.</span><span class="nx">y</span> <span class="o">&amp;&amp;</span> <span class="nx">y</span> <span class="o">&lt;=</span> <span class="nx">max</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>However, <code class="language-plaintext highlighter-rouge">brushSelection</code> is actually only updated in one place: the <code class="language-plaintext highlighter-rouge">brushed()</code> function. We don‚Äôt really need to keep it around once we‚Äôve converted it to selected commits. Let‚Äôs update the <code class="language-plaintext highlighter-rouge">brushed()</code> function to update <code class="language-plaintext highlighter-rouge">selectedCommits</code> directly:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">brushed</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">brushSelection</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">selection</span><span class="p">;</span>
  <span class="nx">selectedCommits</span> <span class="o">=</span> <span class="o">!</span><span class="nx">brushSelection</span>
    <span class="p">?</span> <span class="p">[]</span>
    <span class="p">:</span> <span class="nx">commits</span><span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">commit</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">min</span> <span class="o">=</span> <span class="p">{</span> <span class="na">x</span><span class="p">:</span> <span class="nx">brushSelection</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="na">y</span><span class="p">:</span> <span class="nx">brushSelection</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">};</span>
        <span class="kd">let</span> <span class="nx">max</span> <span class="o">=</span> <span class="p">{</span> <span class="na">x</span><span class="p">:</span> <span class="nx">brushSelection</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="na">y</span><span class="p">:</span> <span class="nx">brushSelection</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">};</span>
        <span class="kd">let</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">xScale</span><span class="p">(</span><span class="nx">commit</span><span class="p">.</span><span class="nx">date</span><span class="p">);</span>
        <span class="kd">let</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">yScale</span><span class="p">(</span><span class="nx">commit</span><span class="p">.</span><span class="nx">hourFrac</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">x</span> <span class="o">&gt;=</span> <span class="nx">min</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">x</span> <span class="o">&lt;=</span> <span class="nx">max</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">y</span> <span class="o">&gt;=</span> <span class="nx">min</span><span class="p">.</span><span class="nx">y</span> <span class="o">&amp;&amp;</span> <span class="nx">y</span> <span class="o">&lt;=</span> <span class="nx">max</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
      <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div><p>Then <code class="language-plaintext highlighter-rouge">isCommitSelected()</code> can be much simpler:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">isCommitSelected</span><span class="p">(</span><span class="nx">commit</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">selectedCommits</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">commit</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>And <code class="language-plaintext highlighter-rouge">selectedCommits</code> no longer needs to be reactive, it can become a plain variable:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">selectedCommits</span> <span class="o">=</span> <span class="p">[];</span>
</code></pre></div></div><p>We can also remove the reference to <code class="language-plaintext highlighter-rouge">brushSelection</code> in the <code class="language-plaintext highlighter-rouge">hasSelection</code> function, as <code class="language-plaintext highlighter-rouge">selectedCommits</code> is updated in <code class="language-plaintext highlighter-rouge">brushed</code>.</p><p class="tip">You can now remove the top-level <code class="language-plaintext highlighter-rouge">brushSelection</code> variable, as it‚Äôs not used anywhere.</p><p>Now, let‚Äôs add some event listeners to allow for clicking on commits. If you have not done the optional <a href="https://vis-society.github.io/labs/7/#step-35-bulletproof-positioning-optional">Step 3.5 of Lab 7</a>, do the part about creating a <code class="language-plaintext highlighter-rouge">dotInteraction()</code> function now.</p><p>Then, we just add two more listeners that call <code class="language-plaintext highlighter-rouge">dotInteraction()</code> on the dots: <code class="language-plaintext highlighter-rouge">on:click</code> and <code class="language-plaintext highlighter-rouge">on:keyup</code>, and pass the same parameters as the other listeners (<code class="language-plaintext highlighter-rouge">evt</code> and <code class="language-plaintext highlighter-rouge">index</code>).</p><p>Then, in the <code class="language-plaintext highlighter-rouge">dotInteraction()</code> function, add a new <code class="language-plaintext highlighter-rouge">else if</code> branch case that checks if either <code class="language-plaintext highlighter-rouge">evt.type</code> is <code class="language-plaintext highlighter-rouge">"click"</code> OR <code class="language-plaintext highlighter-rouge">evt.type</code> is <code class="language-plaintext highlighter-rouge">keyup</code> AND <code class="language-plaintext highlighter-rouge">evt.key</code> is <code class="language-plaintext highlighter-rouge">"Enter"</code>. All this branch should do is overwrite <code class="language-plaintext highlighter-rouge">selectedCommits</code> with an array containing only the commit at <code class="language-plaintext highlighter-rouge">index</code> (<code class="language-plaintext highlighter-rouge">commits[index]</code>).</p><p>If you try it out now, clicking should work!</p><video src="videos/clickable.mp4" loading="lazy" muted="" autoplay="" loop=""></video><h3 id="step-02-iterating-over-data-not-arcs"> <a href="#step-02-iterating-over-data-not-arcs" class="anchor-heading" aria-labelledby="step-02-iterating-over-data-not-arcs"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 0.2: Iterating over data, not arcs</h3><p class="files"><code class="language-plaintext highlighter-rouge">lib/Pie.svelte</code></p><p>Play a little bit with selecting different colors in the pie chart. What do you notice? <strong>The same technologies are drawn with different colors across selections!</strong> You can see this in the video above as well.</p><p>This is because the technologies can appear in any order in the data we are passing, and we are using the index of the data to get the color (<code class="language-plaintext highlighter-rouge">color(index)</code>). However, ordinal scales are much more useful when we pass in the actual data value (in this case, the technology name) instead of an index, as they give us a consistent color.</p><p>However, if we look at our current code in <code class="language-plaintext highlighter-rouge">lib/Pie.svelte</code>, we are currently iterating over <code class="language-plaintext highlighter-rouge">arcs</code> to draw the pie wedges:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{#each arcs as arc, index}
<span class="c">&lt;!-- Other attributes omitted for brevity --&gt;</span>
<span class="nt">&lt;path</span> <span class="na">d=</span><span class="s">"{arc}"</span> <span class="na">fill=</span><span class="s">"{"</span> <span class="na">colors</span><span class="err">(</span><span class="na">index</span><span class="err">)</span> <span class="err">}</span><span class="nt">&gt;</span> {/each}<span class="nt">&lt;/path&gt;</span>
</code></pre></div></div><p>This makes it awkward to get any data associated with the pie wedge, such as the label. We <em>could</em> use <code class="language-plaintext highlighter-rouge">data[index]</code>, but it‚Äôs better to just iterate over the data itself:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{#each data as d, index}
<span class="nt">&lt;path</span> <span class="na">d=</span><span class="s">"{arcs[index]}"</span> <span class="na">fill=</span><span class="s">"{"</span> <span class="na">colors</span><span class="err">(</span><span class="na">index</span><span class="err">)</span> <span class="err">}</span><span class="nt">&gt;</span> {/each}<span class="nt">&lt;/path&gt;</span>
</code></pre></div></div><p>We can now pass <code class="language-plaintext highlighter-rouge">d.label</code> to the color scale instead of just the index:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{#each data as d, index}
<span class="nt">&lt;path</span> <span class="na">d=</span><span class="s">"{arcs[index]}"</span> <span class="na">fill=</span><span class="s">"{"</span> <span class="na">colors</span><span class="err">(</span><span class="na">d.label</span><span class="err">)</span> <span class="err">}</span><span class="nt">&gt;</span> {/each}<span class="nt">&lt;/path&gt;</span>
</code></pre></div></div><p>Try it again: now the colors should be consistent across selections!</p><h3 id="step-03-moving-all-info-to-the-same-data-structure"> <a href="#step-03-moving-all-info-to-the-same-data-structure" class="anchor-heading" aria-labelledby="step-03-moving-all-info-to-the-same-data-structure"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 0.3: Moving all info to the same data structure</h3><p class="files"><code class="language-plaintext highlighter-rouge">lib/Pie.svelte</code></p><p>It <em>is</em> a little awkward that we need to read several different variables to get all the information we need about a pie chart wedge. However, as a design principle, we don‚Äôt want to be adding internal data like <code class="language-plaintext highlighter-rouge">startAngle</code> on a data structure we were passed as input, it‚Äôs not good form. Let‚Äôs create a copy of the data and add everything we need to it. We will use a reactive block instead of a reactive statement, since we want to run multiple lines of code. First, to copy the data:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">pieData</span><span class="p">;</span>
<span class="nl">$</span><span class="p">:</span> <span class="p">{</span>
  <span class="nx">pieData</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="p">...</span><span class="nx">d</span> <span class="p">}));</span>
<span class="p">}</span>
</code></pre></div></div><p class="fyi">The <code class="language-plaintext highlighter-rouge">{...d}</code> syntax is a shorthand for creating a new object with all the properties of <code class="language-plaintext highlighter-rouge">d</code>.</p><p>You can now replace all other mentions of <code class="language-plaintext highlighter-rouge">data</code> in the component with <code class="language-plaintext highlighter-rouge">pieData</code> (except for the <code class="language-plaintext highlighter-rouge">data</code> prop itself).</p><p>Then, move the <code class="language-plaintext highlighter-rouge">arcData</code> and <code class="language-plaintext highlighter-rouge">arcs</code> definitions into local variables within the reactive block, and combine them with <code class="language-plaintext highlighter-rouge">pieData</code> like this:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">pieData</span> <span class="o">=</span> <span class="nx">pieData</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="p">...</span><span class="nx">d</span><span class="p">,</span> <span class="p">...</span><span class="nx">arcData</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="na">arc</span><span class="p">:</span> <span class="nx">arcs</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">}));</span>
</code></pre></div></div><p>This will give us objects with <code class="language-plaintext highlighter-rouge">startAngle</code>, <code class="language-plaintext highlighter-rouge">endAngle</code>, and <code class="language-plaintext highlighter-rouge">arc</code> properties, in addition to <code class="language-plaintext highlighter-rouge">value</code> and <code class="language-plaintext highlighter-rouge">label</code>. Replace all references to <code class="language-plaintext highlighter-rouge">arcData</code> and <code class="language-plaintext highlighter-rouge">arcs</code> to just read from <code class="language-plaintext highlighter-rouge">pieData</code> (e.g. <code class="language-plaintext highlighter-rouge">arcs[index]</code> would become <code class="language-plaintext highlighter-rouge">d.arc</code>).</p><h2 id="step-1-evolution-visualization"> <a href="#step-1-evolution-visualization" class="anchor-heading" aria-labelledby="step-1-evolution-visualization"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1: Evolution visualization</h2><p class="files"><code class="language-plaintext highlighter-rouge">src/meta/+page.svelte</code></p><p>In this step, we will create an interactive timeline visualization that shows the evolution of our repo by allowing us to move a slider to change the date range of the commits we are looking at.</p><h3 id="step-11-creating-the-filtering-ui"> <a href="#step-11-creating-the-filtering-ui" class="anchor-heading" aria-labelledby="step-11-creating-the-filtering-ui"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1.1: Creating the filtering UI</h3><p>In this step we will create a slider, bind its value to a variable, and display the date and time it corresponds to. It‚Äôs very familiar to what we did in <a href="../8/">the previous lab</a>, except we don‚Äôt need to worry about a ‚Äúno filter‚Äù state.</p><p>First, let‚Äôs create a new variable, <code class="language-plaintext highlighter-rouge">commitProgress</code>, that will represent the maximum time we want to show as a percentage of the total time:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">commitProgress</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
</code></pre></div></div><p>To map this percentage to a date, we will need a new <a href="https://d3js.org/d3-scale/time">time scale</a>, just like we did in <a href="../7/#step-21-drawing-the-dots">Lab 7</a> that will map <code class="language-plaintext highlighter-rouge">commit.datetime</code> values to the <code class="language-plaintext highlighter-rouge">[0, 100]</code> range.</p><p>Once we have our scale, we can easily get from the 0-100 number to a date:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">:</span> <span class="nx">commitMaxTime</span> <span class="o">=</span> <span class="nx">timeScale</span><span class="p">.</span><span class="nx">invert</span><span class="p">(</span><span class="nx">commitProgress</span><span class="p">);</span>
</code></pre></div></div><p>We are now ready to add our filtering UI.</p><ol><li>Create a new <code class="language-plaintext highlighter-rouge">&lt;label&gt;</code> element with a slider input and a <code class="language-plaintext highlighter-rouge">&lt;time&gt;</code> element that will display the date and time corresponding to the slider value.<li>Add some CSS to make the slider maximum width (<code class="language-plaintext highlighter-rouge">flex: 1</code> in Flexbox, <code class="language-plaintext highlighter-rouge">1fr</code> column width in Grid) and to place the time element underneath the slider (otherwise differences in output value length will move the slider, which is very jarring).<li>Bind the slider value to <code class="language-plaintext highlighter-rouge">commitProgress</code><li>Output the selected time in the <code class="language-plaintext highlighter-rouge">&lt;time&gt;</code> element using <code class="language-plaintext highlighter-rouge">commitMaxTime.toLocaleString()</code> similarly to how we did in <a href="../7/">Lab 7</a> and <a href="../8/">Lab 8</a>. This time we need to display <em>both</em> the date and the time.</ol><p class="tip">Feel free to use any settings you like. In the screencasts below, I use <code class="language-plaintext highlighter-rouge">dateStyle: "long"</code> and <code class="language-plaintext highlighter-rouge">timeStyle: "short"</code>.</p><p>If everything went well, your slider should now be working!</p><p><img src="/labs/lab09/videos/slider.gif" alt="" /></p><h3 id="step-12-filtering-by-commitmaxtime"> <a href="#step-12-filtering-by-commitmaxtime" class="anchor-heading" aria-labelledby="step-12-filtering-by-commitmaxtime"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1.2: Filtering by <code class="language-plaintext highlighter-rouge">commitMaxTime</code></h3><p>Let‚Äôs now ceate a new <code class="language-plaintext highlighter-rouge">filteredCommits</code> variable that will reactively <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/filter">filter</a> <code class="language-plaintext highlighter-rouge">commits</code> by comparing <code class="language-plaintext highlighter-rouge">commit.datetime</code> with <code class="language-plaintext highlighter-rouge">commitMaxTime</code>.</p><p>Similarly, create a <code class="language-plaintext highlighter-rouge">filteredLines</code> variable that filters <code class="language-plaintext highlighter-rouge">data</code> in the same way.</p><p>We can now replace <code class="language-plaintext highlighter-rouge">commits</code> with <code class="language-plaintext highlighter-rouge">filteredCommits</code> and <code class="language-plaintext highlighter-rouge">data</code> with <code class="language-plaintext highlighter-rouge">filteredLines</code> in several places:</p><ul><li>The <code class="language-plaintext highlighter-rouge">xScale</code> domain<li>The <code class="language-plaintext highlighter-rouge">brushed()</code> function that updates the <code class="language-plaintext highlighter-rouge">selectedCommits</code> variable<li>The <code class="language-plaintext highlighter-rouge">{#each}</code> block that draws the circles<li>The <code class="language-plaintext highlighter-rouge">hoveredCommit</code> variable<li>Your summary stats</ul><p>Try moving the slider and see what happens!</p><video src="videos/filtering-unstable.mp4" loading="lazy" muted="" autoplay="" loop="" class="outline"></video><h3 id="step-13-making-the-circles-stable"> <a href="#step-13-making-the-circles-stable" class="anchor-heading" aria-labelledby="step-13-making-the-circles-stable"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1.3: Making the circles stable</h3><p>CSS transitions are already applied to our circles since Lab 7. However, notice that when we move the slider, the circles are jumping around a lot.</p><p>This is because Svelte doesn‚Äôt know which data items correspond to which previous data items, so it does not necessarily reuse the right <code class="language-plaintext highlighter-rouge">&lt;circle&gt;</code> element for the same commit. To tell Svelte which data items correspond to which previous data items, we can use <a href="https://svelte.dev/docs/logic-blocks#each">a <em>keyed <code class="language-plaintext highlighter-rouge">each</code> block</em></a>, with a value that uniquely identifies the data item. A good candidate for that in this case would be the commit id:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{#each commits as commit, index (commit.id) }
</code></pre></div></div><p>Just this small addition fixes the issue completely!</p><video src="videos/filtering-stable.mp4" loading="lazy" muted="" autoplay="" loop="" class="browser"></video><h3 id="step-14-entry-transitions-with-css"> <a href="#step-14-entry-transitions-with-css" class="anchor-heading" aria-labelledby="step-14-entry-transitions-with-css"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1.4: Entry transitions with CSS</h3><p>Notice that even though we are now getting a nice transition when an existing commit changes radius, there is no transition when a new commit appears.</p><video src="videos/filtering-no-intro.mp4" loading="lazy" muted="" autoplay="" loop="" class="browser"></video><p>This is because CSS transitions fire for state changes where both the start and end changes are described by CSS. A new element being added does not have a start state, so it doesn‚Äôt transition. We <em>could</em> use <a href="https://svelte.dev/docs/element-directives#transition-fn">Svelte transitions</a> for this, but we don‚Äôt need to. We can actually use CSS transitions, we just need to explicitly tell the browser what the start state should be. That‚Äôs what the <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/@starting-style"><code class="language-plaintext highlighter-rouge">@starting-style</code></a> rule is for!</p><p>Inside the <code class="language-plaintext highlighter-rouge">circle</code> CSS rule, add a <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/@starting-style"><code class="language-plaintext highlighter-rouge">@starting-style</code></a> rule (and ignore Svelte‚Äôs ‚ÄúUnknown at rule‚Äù warning):</p><div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@starting-style</span> <span class="p">{</span>
  <span class="py">r</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>If you preview again, you should notice that that‚Äôs all it took, new circles are now being animated as well!</p><video src="videos/filtering-intro.mp4" loading="lazy" muted="" autoplay="" loop="" class="browser"></video><blockquote class="further"><p>You might notice that the largest circles and the smallest circles are <em>both</em> transitioning with the same <em>duration</em>, which means dramatically different <em>speeds</em>. We may decide that this is desirable: it means all circles are appearing at once. However, if you want to instead keep speed constant, you can set an <code class="language-plaintext highlighter-rouge">--r</code> CSS variable on each <code class="language-plaintext highlighter-rouge">circle</code> element with its radius, and then set the transition duration to e.g. <code class="language-plaintext highlighter-rouge">calc(var(--r) / 100ms)</code>. You can do that only for <code class="language-plaintext highlighter-rouge">r</code> transitions like so:</p><div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">transition</span><span class="o">:</span> <span class="nt">all</span> <span class="err">200</span><span class="nt">ms</span><span class="o">,</span> <span class="nt">r</span> <span class="nt">calc</span><span class="o">(</span><span class="nt">var</span><span class="o">(</span><span class="nt">--r</span><span class="o">)</span> <span class="o">*</span> <span class="err">100</span><span class="nt">ms</span><span class="o">);</span>
</code></pre></div></div></blockquote><h3 id="step-15-moving-the-scatterplot-into-a-separate-component-optional-but-recommended"> <a href="#step-15-moving-the-scatterplot-into-a-separate-component-optional-but-recommended" class="anchor-heading" aria-labelledby="step-15-moving-the-scatterplot-into-a-separate-component-optional-but-recommended"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1.5: Moving the scatterplot into a separate component <em>(optional, but recommended)</em></h3><p class="files"><code class="language-plaintext highlighter-rouge">src/routes/meta/+page.svelte</code>, <code class="language-plaintext highlighter-rouge">src/routes/meta/Scatterplot.svelte</code></p><p><code class="language-plaintext highlighter-rouge">src/routes/meta/+page.svelte</code> has begun to grow quite a lot, and it‚Äôs only about to get bigger. It will really help make your code more manageable to start moving reusable functionality to components. One good candidate is the commit scatterplot.</p><p>Create a new file, <code class="language-plaintext highlighter-rouge">src/routes/meta/Scatterplot.svelte</code>, and move the scatterplot code there. This includes:</p><ul><li>The <code class="language-plaintext highlighter-rouge">&lt;svg&gt;</code> element<li>The commit tooltip<li>Any CSS styling elements in those<li>The JS dealing with dimensions, margins, scales, axes, brushing, user interaction with dots, commit selection, etc.</ul><p>It should have two props:</p><ul><li><code class="language-plaintext highlighter-rouge">commits</code> (an array of commits)<li><code class="language-plaintext highlighter-rouge">selectedCommits</code> (mostly used as output, but could be used as input as well)</ul><p>We name the variable <code class="language-plaintext highlighter-rouge">commits</code> in order to make the scatterplot a bit more generalizable. As such, make sure to change any mentions of <code class="language-plaintext highlighter-rouge">filteredCommits</code> in your new file back to <code class="language-plaintext highlighter-rouge">commits</code>. VS Code allows you to do that safely in one go, by placing the text caret on the variable name, then pressing F2 (or right clicking and selecting ‚ÄúRename Symbol‚Äù)</p><p>The final result should allow us to replace our entire <code class="language-plaintext highlighter-rouge">&lt;svg&gt;</code> and commit tooltip in <code class="language-plaintext highlighter-rouge">src/routes/meta/+page.svelte</code> with just:</p><div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nc">CommitScatterplot</span>
  <span class="na">commits</span><span class="p">=</span><span class="si">{</span><span class="nx">filteredCommits</span><span class="si">}</span>
  <span class="na">bind</span><span class="err">:</span><span class="na">selectedCommits</span><span class="p">=</span><span class="si">{</span><span class="nx">selectedCommits</span><span class="si">}</span>
<span class="p">/&gt;</span>
</code></pre></div></div><p class="caveat">Don‚Äôt forget to also move the necessary imports! I find it helpful to just copy all of them, then remove the ones VS Code highlights as unused.</p><h2 id="step-2-the-race-for-the-biggest-file"> <a href="#step-2-the-race-for-the-biggest-file" class="anchor-heading" aria-labelledby="step-2-the-race-for-the-biggest-file"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2: The race for the biggest file!</h2><p>In this step we will create a unit visualization that shows the relative size of each file in the codebase in lines of code, as well as the type and age of each line.</p><h3 id="step-21-creating-a-component-for-the-unit-visualization"> <a href="#step-21-creating-a-component-for-the-unit-visualization" class="anchor-heading" aria-labelledby="step-21-creating-a-component-for-the-unit-visualization"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2.1: Creating a component for the unit visualization</h3><p class="files"><code class="language-plaintext highlighter-rouge">src/routes/meta/FileLines.svelte</code>, <code class="language-plaintext highlighter-rouge">src/routes/meta/+page.svelte</code></p><p>To avoid bloating <code class="language-plaintext highlighter-rouge">src/routes/meta/+page.svelte</code> even more, let‚Äôs create a new component, <code class="language-plaintext highlighter-rouge">src/routes/meta/FileLines.svelte</code>, that will contain the unit visualization.</p><p>The component should take a <code class="language-plaintext highlighter-rouge">lines</code> prop, and will group lines of code into files internally. This means that from the outside, we‚Äôd just use it like this:</p><div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nc">FileLines</span> <span class="na">lines</span><span class="p">=</span><span class="si">{</span><span class="nx">filteredLines</span><span class="si">}</span> <span class="p">/&gt;</span>
</code></pre></div></div><p>Eventually we want this to go after the scatterplot &amp; pie chart, but for now let‚Äôs add it right after our filtering UI as that makes development faster.</p><p>Then, within the component we will group the lines by file and convert the groups to an array of <code class="language-plaintext highlighter-rouge">{name, lines}</code> objects like this:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">files</span> <span class="o">=</span> <span class="p">[];</span>
<span class="nl">$</span><span class="p">:</span> <span class="p">{</span>
  <span class="nx">files</span> <span class="o">=</span> <span class="nx">d3</span>
    <span class="p">.</span><span class="nx">groups</span><span class="p">(</span><span class="nx">lines</span><span class="p">,</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">file</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">map</span><span class="p">(([</span><span class="nx">name</span><span class="p">,</span> <span class="nx">lines</span><span class="p">])</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">{</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">lines</span> <span class="p">};</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div><p>Now that we have our files, let‚Äôs output them. While we <em>can</em> use D3 and generate an SVG for this, unit visualizations are one of the few cases where it can actually be easier to just use HTML and CSS, as we need to do a lot less work to manage the position of each element.</p><p>We will use a <code class="language-plaintext highlighter-rouge">&lt;dl&gt;</code> element (but feel free to make different choices, there are many structures that would be appropriate here) Let‚Äôs start simple, by just outputting filenames and number of lines:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dl</span> <span class="na">class=</span><span class="s">"files"</span><span class="nt">&gt;</span>
  {#each files as file (file.name) }
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;dt&gt;</span>
      <span class="nt">&lt;code&gt;</span>{file.name}<span class="nt">&lt;/code&gt;</span>
    <span class="nt">&lt;/dt&gt;</span>
    <span class="nt">&lt;dd&gt;</span>{file.lines.length} lines<span class="nt">&lt;/dd&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  {/each}
<span class="nt">&lt;/dl&gt;</span>
</code></pre></div></div><p>Note that we used a <em>keyed <code class="language-plaintext highlighter-rouge">each</code> block</em> from the get go here. It‚Äôs generally a good practice to do this by default, especially when iterating over data that we expect to change, as it avoids a lot of the issues we saw earlier.</p><p>We should style the <code class="language-plaintext highlighter-rouge">&lt;dl&gt;</code> as a grid so that the filenames and line counts are aligned. The only thing that is a bit different now is that we have a <code class="language-plaintext highlighter-rouge">&lt;div&gt;</code> around each <code class="language-plaintext highlighter-rouge">&lt;dt&gt;</code> and <code class="language-plaintext highlighter-rouge">&lt;dd&gt;</code>. To prevent that from interfering with the grid we should use <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_grid_layout/Subgrid">Subgrid</a>:</p><div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&amp;</span> <span class="o">&gt;</span> <span class="nt">div</span> <span class="p">{</span>
  <span class="nl">grid-column</span><span class="p">:</span> <span class="m">1</span> <span class="p">/</span> <span class="m">-1</span><span class="p">;</span>
  <span class="nl">display</span><span class="p">:</span> <span class="n">grid</span><span class="p">;</span>
  <span class="py">grid-template-columns</span><span class="p">:</span> <span class="n">subgrid</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>Then we can just apply <code class="language-plaintext highlighter-rouge">grid-column: 1</code> to the <code class="language-plaintext highlighter-rouge">&lt;dt&gt;</code>s and <code class="language-plaintext highlighter-rouge">grid-column: 2</code> to the <code class="language-plaintext highlighter-rouge">&lt;dd&gt;</code> as usual.</p><p>At this point, our ‚Äúvisualization‚Äù is rather spartan, but if you move the slider, you should already see the number of lines changing!</p><video src="videos/file-lines-basic.mp4" loading="lazy" muted="" autoplay="" loop="" class="outline"></video><h3 id="step-22-making-it-look-like-an-actual-unit-visualization"> <a href="#step-22-making-it-look-like-an-actual-unit-visualization" class="anchor-heading" aria-labelledby="step-22-making-it-look-like-an-actual-unit-visualization"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2.2: Making it look like an actual unit visualization</h3><p>For a unit visualization, we want to draw an element per data point (in this case, per line), so let‚Äôs do that. All we need to do is replace the contents of the <code class="language-plaintext highlighter-rouge">&lt;dd&gt;</code> element with another <code class="language-plaintext highlighter-rouge">{#each}</code> block that outputs a <code class="language-plaintext highlighter-rouge">&lt;div&gt;</code> for each line:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{#each file.lines as line (line.line) }
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"line"</span><span class="nt">&gt;&lt;/div&gt;</span>
{/each}
</code></pre></div></div><p class="tip">Seeing the total number of lines per file is still useful, so you may want to add it in the <code class="language-plaintext highlighter-rouge">&lt;dt&gt;</code>. I used a <code class="language-plaintext highlighter-rouge">&lt;small&gt;</code> element, gave it <code class="language-plaintext highlighter-rouge">display: block</code> so that it‚Äôs on its own line, and styled it smaller and less opaque.</p><p>And then add some CSS to make it look like a unit visualization:</p><div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">.line</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="n">flex</span><span class="p">;</span>
  <span class="nl">width</span><span class="p">:</span> <span class="m">0.5em</span><span class="p">;</span>
  <span class="py">aspect-ratio</span><span class="p">:</span> <span class="m">1</span><span class="p">;</span>
  <span class="nl">background</span><span class="p">:</span> <span class="no">steelblue</span><span class="p">;</span>
  <span class="nl">border-radius</span><span class="p">:</span> <span class="m">50%</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>Last, we want to make sure these dots wrap and are tightly packed, so we need to add some CSS for the <code class="language-plaintext highlighter-rouge">&lt;dd&gt;</code> elements to allow this:</p><div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">dd</span> <span class="p">{</span>
  <span class="nl">grid-column</span><span class="p">:</span> <span class="m">2</span><span class="p">;</span>
  <span class="nl">display</span><span class="p">:</span> <span class="n">flex</span><span class="p">;</span>
  <span class="nl">flex-wrap</span><span class="p">:</span> <span class="n">wrap</span><span class="p">;</span>
  <span class="nl">align-items</span><span class="p">:</span> <span class="n">start</span><span class="p">;</span>
  <span class="nl">align-content</span><span class="p">:</span> <span class="n">start</span><span class="p">;</span>
  <span class="py">gap</span><span class="p">:</span> <span class="m">0.15em</span><span class="p">;</span>
  <span class="nl">padding-top</span><span class="p">:</span> <span class="m">0.6em</span><span class="p">;</span>
  <span class="nl">margin-left</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>At this point, we should have an actual unit visualization!</p><p>It should look something like this:</p><video src="videos/file-lines-unit.mp4" loading="lazy" muted="" autoplay="" loop="" class="outline"></video><h3 id="step-23-sorting-files-by-number-of-lines"> <a href="#step-23-sorting-files-by-number-of-lines" class="anchor-heading" aria-labelledby="step-23-sorting-files-by-number-of-lines"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2.3: Sorting files by number of lines</h3><p>Our visualization is not really much of a race right now, since the order of files seems random. We need to sort the files by the number of lines they contain in descending order. We can do that in the same reactive block where we calculate <code class="language-plaintext highlighter-rouge">files</code>:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">files</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">files</span><span class="p">,</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="nx">d</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
</code></pre></div></div><h3 id="step-24-varying-the-color-of-the-dots-by-technology"> <a href="#step-24-varying-the-color-of-the-dots-by-technology" class="anchor-heading" aria-labelledby="step-24-varying-the-color-of-the-dots-by-technology"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2.4: Varying the color of the dots by technology</h3><p>Our visualization shows us the size of the files, but not all files are created equal. We can use color to differentiate the lines withn each file by technology.</p><p>Let‚Äôs create an ordinal scale that maps technology ids to colors:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">colors</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scaleOrdinal</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">schemeTableau10</span><span class="p">);</span>
</code></pre></div></div><p>Then, we can use this scale to color the dots:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"line"</span> <span class="na">style=</span><span class="s">"--color: { colors(line.type) }"</span><span class="nt">&gt;&lt;/div&gt;</span>
</code></pre></div></div><p>Much better now!</p><video src="videos/file-lines-colored.mp4" loading="lazy" muted="" autoplay="" loop="" class="outline"></video><h3 id="step-25-dot-transitions"> <a href="#step-25-dot-transitions" class="anchor-heading" aria-labelledby="step-25-dot-transitions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2.5: Dot transitions</h3><p>Notice that it‚Äôs a little hard to compare which lines of each file have been added as we move the slider. If we make new elements appear with a transition, it will be much easier to see what is happening. We can use one of the <a href="https://svelte.dev/docs/svelte-transition">Svelte predefined transitions</a> for this. I picked <code class="language-plaintext highlighter-rouge">scale</code> as that makes dots appear to grow from a single point.</p><p>If you don‚Äôt need to customize the duration etc, all it takes is adding <code class="language-plaintext highlighter-rouge">in:scale</code> to the <code class="language-plaintext highlighter-rouge">&lt;div&gt;</code> element!</p><video src="videos/file-lines-dottransitions.mp4" loading="lazy" muted="" autoplay="" loop="" class="outline"></video><h3 id="step-26-consistent-colors-across-visualizations"> <a href="#step-26-consistent-colors-across-visualizations" class="anchor-heading" aria-labelledby="step-26-consistent-colors-across-visualizations"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2.6: Consistent colors across visualizations</h3><p>Notice that we have two visualizations that use colors to represent technologies, but they use different colors for the same technologies!</p><p>To fix this, we need to allow our components (<code class="language-plaintext highlighter-rouge">Pie.svelte</code> and <code class="language-plaintext highlighter-rouge">FileLines.svelte</code>) to accept a color scale as a prop, by prepending their <code class="language-plaintext highlighter-rouge">colors</code> declarations with <code class="language-plaintext highlighter-rouge">export</code>:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">let</span> <span class="nx">colors</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scaleOrdinal</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">schemeTableau10</span><span class="p">);</span>
</code></pre></div></div><p>Then we create the color scale on the parent page and pass it to each of them. For example, <code class="language-plaintext highlighter-rouge">&lt;FileLines /&gt;</code> would become <code class="language-plaintext highlighter-rouge">&lt;FileLines colors={colors} /&gt;</code>.</p><p>That by itself is not enough. To get consistent colors each component needs to be looking up the color for a technology in the same way. Currently, <code class="language-plaintext highlighter-rouge">&lt;Pie&gt;</code> uses technology labels, while <code class="language-plaintext highlighter-rouge">&lt;FileLines&gt;</code> uses the raw ids from the data. We can make sure the data we pass to <code class="language-plaintext highlighter-rouge">&lt;Pie&gt;</code> include an <code class="language-plaintext highlighter-rouge">id</code> property with the raw id and then use that to look up the color. To make the component more flexible, we could even use both:</p><div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="err">!--</span> <span class="na">Rest</span> <span class="na">of</span> <span class="na">attributes</span> <span class="na">omitted</span> <span class="err">--</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">path</span> <span class="na">fill</span><span class="p">=</span><span class="si">{</span> <span class="nx">colors</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">id</span> <span class="p">??</span> <span class="nx">d</span><span class="p">.</span><span class="nx">label</span><span class="p">)</span> <span class="p">}</span><span class="o">&gt;</span>
</code></pre></div></div><p>Our visualization is now <em>way</em> more informative!</p><p><img src="images/consistent-colors-pie-unit.png" class="outline" alt="" /></p><h3 id="step-27-animated-race"> <a href="#step-27-animated-race" class="anchor-heading" aria-labelledby="step-27-animated-race"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2.7: Animated race</h3><p>We can now use the <a href="https://svelte.dev/docs/element-directives#animate-fn"><code class="language-plaintext highlighter-rouge">animate:fn</code> directive</a> to animate the files when they move to a new position. Svelte provides a built-in animation called <code class="language-plaintext highlighter-rouge">flip</code>, which sounds perfect for this use case.</p><p>We import it at the top of our component:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">flip</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">svelte/animate</span><span class="dl">'</span><span class="p">;</span>
</code></pre></div></div><p>And then we apply it to the <code class="language-plaintext highlighter-rouge">&lt;div&gt;</code> that contains each file. If we are happy with its defaults, it can be as simple as this:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">animate:flip</span><span class="nt">&gt;&lt;/div&gt;</span>
</code></pre></div></div><p>However, if we preview the animation we get the result is ‚Ä¶less than great:</p><video src="videos/flip-wrong.mp4" loading="lazy" muted="" autoplay="" loop="" class="outline"></video><p>We can add a long duration (3000) and a delay (1000) (`animate:flip={{delay: 1000, duration: 3000}}) to more clearly see what is happening:</p><video src="videos/flip-wrong-slow.mp4" loading="lazy" muted="" autoplay="" loop="" class="outline"></video><p>From some further investigation, it appears that Svelte is prematurely caching the geometry of the elements (before and after), which is causing the animation to be incorrect.</p><p>But we can use a workaround! The part after the <code class="language-plaintext highlighter-rouge">animate:</code> is just referring to a function. There is nothing special about <code class="language-plaintext highlighter-rouge">flip</code>, it‚Äôs just a function we import. In fact, if we alt + click on it in the import statement, VS Code will take us to the Svelte module that defines it. Instead of using it wholesale, we can import with a different name:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">flip</span> <span class="k">as</span> <span class="nx">originalFlip</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">svelte/animate</span><span class="dl">'</span><span class="p">;</span>
</code></pre></div></div><p>We can use a reactive statement to <em>force</em> <code class="language-plaintext highlighter-rouge">flip</code> to update whenever we need it to, e.g. whenever <code class="language-plaintext highlighter-rouge">files</code> changes:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">getFlip</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">originalFlip</span><span class="p">;</span>
<span class="p">}</span>
<span class="nl">$</span><span class="p">:</span> <span class="nx">flip</span> <span class="o">=</span> <span class="nx">getFlip</span><span class="p">(</span><span class="nx">files</span><span class="p">);</span>
</code></pre></div></div><p>This tricks Svelte into thinking <code class="language-plaintext highlighter-rouge">flip</code> depends on <code class="language-plaintext highlighter-rouge">files</code>, so it will re-run whenever <code class="language-plaintext highlighter-rouge">files</code> changes.</p><p>If you try it now (with a reasonable duration and no delay), you will see that the animation is now correct!</p><video src="videos/flip-correct.mp4" loading="lazy" muted="" autoplay="" loop="" class="outline"></video><p>For the final result, you‚Äôd likely want to either specify a duration as a function (which depends on the distance travelled) or remove the parameters (since that is the default).</p><blockquote class="tip"><p>Don‚Äôt like the appearance of the items when they overlap? You can apply a semi-transparent white background and a glow with the same color to the <code class="language-plaintext highlighter-rouge">&lt;div&gt;</code> via something like:</p><div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&amp;</span> <span class="o">&gt;</span> <span class="nt">div</span> <span class="p">{</span>
  <span class="nl">background</span><span class="p">:</span> <span class="n">hsl</span><span class="p">(</span><span class="m">0</span> <span class="m">0%</span> <span class="m">100%</span> <span class="p">/</span> <span class="m">90%</span><span class="p">);</span>
  <span class="nl">box-shadow</span><span class="p">:</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0.2em</span> <span class="m">0.2em</span> <span class="n">hsl</span><span class="p">(</span><span class="m">0</span> <span class="m">0%</span> <span class="m">100%</span> <span class="p">/</span> <span class="m">90%</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div></blockquote><h2 id="step-3-pie-chart-transition"> <a href="#step-3-pie-chart-transition" class="anchor-heading" aria-labelledby="step-3-pie-chart-transition"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 3: Pie chart transition</h2><p class="files"><code class="language-plaintext highlighter-rouge">lib/Pie.svelte</code></p><p>In lab 6, we created a pie chart that shows the distribution of edited lines per technology, and responds to filtering. We even <a href="https://vis-society.github.io/labs/6/#step-51-highlighting-hovered-wedge">added a <code class="language-plaintext highlighter-rouge">transition: 300ms</code></a> to our pie chart wedges, which interpolates any property the browser can interpolate. This is useful when we select a wedge, but produces rather strange results when the pie data changes as you have no doubt noticed by now.</p><p>Let‚Äôs fix it!</p><p class="tip">It will help debugging to apply <code class="language-plaintext highlighter-rouge">fill-opacity</code> to the pie wedges, so you can see when they overlap. Ideally, we don‚Äôt want to have gaps or overlapping wedges during the transition. In the screenshots/screencasts below, I have applied <code class="language-plaintext highlighter-rouge">fill-opacity: 75%;</code> to the <code class="language-plaintext highlighter-rouge">&lt;path&gt;</code> elements. You may also want to use a more distinctive color palette at this point, like <code class="language-plaintext highlighter-rouge">schemeCategory10</code> or <code class="language-plaintext highlighter-rouge">schemeTableau10</code>. The screenshots in this lab will use <code class="language-plaintext highlighter-rouge">schemeTableau10</code>.</p><h3 id="step-31-use-consistent-ordering"> <a href="#step-31-use-consistent-ordering" class="anchor-heading" aria-labelledby="step-31-use-consistent-ordering"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 3.1: Use consistent ordering</h3><p>The first step is to make sure that the pie chart uses a consistent ordering of technologies, which also makes it easier to compare results across different sets of commits. By default, <code class="language-plaintext highlighter-rouge">d3.pie()</code> sorts the wedges by descending value, which in dynamic pie charts, is almost always undesirable. Instead, let‚Äôs sort by the data labels. This way, as long as the data labels remain consistent, the order of the pie wedges will also remain consistent.</p><p>You may notice that there is a <a href="https://d3js.org/d3-shape/pie#pie_sort"><code class="language-plaintext highlighter-rouge">pie.sort()</code></a> function. Can‚Äôt we just use that to sort by labels? No! If we do that, the arcs would be out of sync with our data! Instead, we will <em>disable</em> sorting in the pie by adding <code class="language-plaintext highlighter-rouge">.sort(null)</code> after the call to <code class="language-plaintext highlighter-rouge">d3.pie()</code>:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">sliceGenerator</span> <span class="o">=</span> <span class="nx">d3</span>
  <span class="p">.</span><span class="nx">pie</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">value</span><span class="p">((</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
</code></pre></div></div><p>and then we will sort <code class="language-plaintext highlighter-rouge">pieData</code> itself:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">:</span> <span class="p">{</span>
  <span class="nx">pieData</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">label</span><span class="p">);</span>
  <span class="c1">// ... calculate arcData and arcs as before ...</span>
  <span class="nx">pieData</span> <span class="o">=</span> <span class="nx">pieData</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span> <span class="p">...</span><span class="nx">d</span><span class="p">,</span> <span class="p">...</span><span class="nx">arcData</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="na">arc</span><span class="p">:</span> <span class="nx">arcs</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">}));</span>
<span class="p">}</span>
</code></pre></div></div><p class="caveat">It is important to sort the data <em>before</em> we calculate <code class="language-plaintext highlighter-rouge">arcData</code> and <code class="language-plaintext highlighter-rouge">arcs</code>, otherwise they will be out of sync!</p><p>If you try it now, the order should already be correct, though the transition is still suboptimal:</p><video src="videos/sorted.mp4" loading="lazy" muted="" autoplay="" loop=""></video><h3 id="step-32-eliminate-flashing-by-using-a-keyed-each-block"> <a href="#step-32-eliminate-flashing-by-using-a-keyed-each-block" class="anchor-heading" aria-labelledby="step-32-eliminate-flashing-by-using-a-keyed-each-block"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 3.2: Eliminate flashing by using a keyed <code class="language-plaintext highlighter-rouge">each</code> block</h3><p>Our technologies are now sorted, but this made the transition involve a lot of flashing. Why is that? The pie wedges are always in the same order, so nothing should be changing color!</p><p>This is because Svelte doesn‚Äôt know which data items correspond to which previous data items, so it does not necessarily reuse the same <code class="language-plaintext highlighter-rouge">&lt;path&gt;</code> element for the same data item in the new data. To tell Svelte which data items correspond to which previous data items, we can use <a href="https://svelte.dev/docs/logic-blocks#each">a <em>keyed <code class="language-plaintext highlighter-rouge">each</code> block</em></a>, with a value that uniquely identifies the data item. A good candidate for that would be the label:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{#each pieData as d, index (d.label)}
</code></pre></div></div><p>Just this small addition fixes the issue completely!</p><video src="videos/keyed.mp4" loop="" muted="" autoplay=""></video><h3 id="step-33-fixing-the-shape-transition-using-d3transition"> <a href="#step-33-fixing-the-shape-transition-using-d3transition" class="anchor-heading" aria-labelledby="step-33-fixing-the-shape-transition-using-d3transition"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 3.3: Fixing the shape transition using <code class="language-plaintext highlighter-rouge">d3.transition()</code></h3><p>We may have fixed the issues discussed above but the transition is, how should we put it, ‚Ä¶suboptimal. Our shape transitions are still rather weird, especially when transitioning between pies that have different technologies. Change the transition duration to something longer (e.g. <code class="language-plaintext highlighter-rouge">3s</code>) so you can more clearly see what is happening:</p><video src="videos/arc-wrong.mp4" loop="" muted="" autoplay=""></video><p>This is because paths are interpolated na√Øvely, by just matching up path segments and interpolating their parameters as numbers. Especially when it comes to arcs, that is almost <em>never</em> what we want!</p><figure> <iframe loading="lazy" style="width: 100%; height: 1000px; max-height: 80vh; border: 0;" src="https://svelte.dev/repl/4258ae76ca5641138402d267686e1e7e?version=4.2.12"></iframe><figcaption>Play with this demo to better understand how the browser‚Äôs na√Øve interpolation works (or rather, doesn‚Äôt work) for arcs. <a href="https://svelte.dev/repl/4258ae76ca5641138402d267686e1e7e?version=4.2.12" target="_blank">Open in new window ‚ÜóÔ∏è</a></figcaption></figure><p class="fyi">This is actually a bug in how native CSS interpolation works, and there is an <a href="https://github.com/w3c/csswg-drafts/issues/10195">open issue</a> to fix it (opened by yours truly while authoring this very lab).</p><p>Unfortunately, there is no way to fix this with CSS transitions, and fixing it with CSS animations would require so many keyframes that it would be impractical. Instead, we will use the <a href="https://d3js.org/d3-transition"><code class="language-plaintext highlighter-rouge">d3-transition</code></a> module, which trades simplicity for control, by allowing us to compute the intermediate states ourselves, with JS.</p><p>The first step is to <em>disable</em> CSS transitions for <code class="language-plaintext highlighter-rouge">d</code>, so that they don‚Äôt interfere with our JS transitions. We can do this by restricting which properties the browser can auto-transition:</p><div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">transition</span><span class="o">:</span> <span class="err">300</span><span class="nt">ms</span><span class="o">;</span>
<span class="nt">transition-property</span><span class="o">:</span> <span class="nt">transform</span><span class="o">,</span> <span class="nt">opacity</span><span class="o">,</span> <span class="nt">fill</span><span class="o">;</span>
</code></pre></div></div><p>When using <a href="https://d3js.org/d3-transition"><code class="language-plaintext highlighter-rouge">d3-transition</code></a>, together with a reactive framework like Svelte, there are several questions to answer:</p><ul><li><strong>How</strong> do we get a reference to the DOM nodes for each element we are transitioning?<li><strong>When</strong> do we call <code class="language-plaintext highlighter-rouge">d3.transition()</code> on them?<li><strong>How</strong> do we read the previous state so we can transition between the old and new states?</ul><p>Let‚Äôs take them one by one.</p><h4 id="how-to-get-a-reference-to-the-dom-elements-we-are-transitioning"> <a href="#how-to-get-a-reference-to-the-dom-elements-we-are-transitioning" class="anchor-heading" aria-labelledby="how-to-get-a-reference-to-the-dom-elements-we-are-transitioning"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How to get a reference to the DOM elements we are transitioning?</h4><p>Because <a href="https://d3js.org/d3-transition"><code class="language-plaintext highlighter-rouge">d3-transition</code></a> works with DOM elements, we will need to obtain a reference to the DOM element for each path. As we know from previous labs, this is done with <code class="language-plaintext highlighter-rouge">bind:this</code>. The only thing that is different here is that we are binding elements inside an <code class="language-plaintext highlighter-rouge">{#each}</code> block, so instead of a single variable, we will need to use a data structure to store the references (array or object). The main consideration here is that we need to be able to go from <code class="language-plaintext highlighter-rouge">pieData</code> to the element reference and vice versa easily. Since both are uniquely identified by the data label, let‚Äôs use an object with the data label as the key and the element reference as the value:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">wedges</span> <span class="o">=</span> <span class="p">{};</span>
</code></pre></div></div><p>Then, on the <code class="language-plaintext highlighter-rouge">&lt;path&gt;</code> element, add <code class="language-plaintext highlighter-rouge">bind:this={ wedges[d.label] }</code>.</p><p class="tip">You can check that this is populated correctly by using a <code class="language-plaintext highlighter-rouge">$: console.log(wedges)</code> reactive statement.</p><h4 id="when-to-call-d3transition"> <a href="#when-to-call-d3transition" class="anchor-heading" aria-labelledby="when-to-call-d3transition"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> When to call <code class="language-plaintext highlighter-rouge">d3.transition()</code>?</h4><p>Now that we have the element references, how and when do we call <code class="language-plaintext highlighter-rouge">d3.transition()</code> on them? Because <a href="https://d3js.org/d3-transition"><code class="language-plaintext highlighter-rouge">d3-transition</code></a> is based on function calls, we need to pick the right time to call it ourselves.</p><p>Let‚Äôs create a new function, <code class="language-plaintext highlighter-rouge">transitionArcs()</code> that will take care of the transition for us:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">transitionArcs</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// TODO Transition all arcs</span>
<span class="p">}</span>
</code></pre></div></div><p>Then, in the reactive block that sets <code class="language-plaintext highlighter-rouge">pieData</code>, add a call to <code class="language-plaintext highlighter-rouge">transitionArcs()</code> at the very end, so that it runs whenever the data changes.</p><h4 id="how-to-read-the-previous-state"> <a href="#how-to-read-the-previous-state" class="anchor-heading" aria-labelledby="how-to-read-the-previous-state"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How to read the previous state?</h4><p>Finally, how do we read the previous state so we can transition between the old and new states? We will create a new variable to keep track of the <em>old</em> data, and we will update it every time the data changes.</p><p>First, we create a new root level variable:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">oldData</span> <span class="o">=</span> <span class="p">[];</span>
</code></pre></div></div><p>Then, in the same reactive block that we are setting <code class="language-plaintext highlighter-rouge">pieData</code>, we set <code class="language-plaintext highlighter-rouge">oldData = pieData</code> right <em>before</em> we update <code class="language-plaintext highlighter-rouge">pieData</code> (so that it stores the previous value).</p><hr /><p>Great! We now have all the pieces we need to transition the arcs.</p><p>The main idea is that instead of interpolating the arcs directly, we will interpolate the <em>angles</em> and generate new arcs from them. This is a variant of <em>dataspace interpolation</em> where data is interpolated rather than attribute or CSS property values.</p><p>It is recommended to prefer CSS properties for transitions when possible, so will use the <a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/d#using_d_as_a_css_property"><code class="language-plaintext highlighter-rouge">d</code> CSS property</a> to output the arc as a string. It may look a little weird because its name is only one letter long, but it works the same way as any other CSS property (except it only works on <code class="language-plaintext highlighter-rouge">&lt;path&gt;</code> elements). Unlike the attribute, its value is not just a series of path commands, but a <code class="language-plaintext highlighter-rouge">path()</code> function that a string argument with the path syntax, e.g. the CSS declaration <code class="language-plaintext highlighter-rouge">d: path("M 0 0 L 100 0 L 100 100 L 0 100 Z")</code> is the same as the attribute <code class="language-plaintext highlighter-rouge">d="M 0 0 L 100 0 L 100 100 L 0 100 Z"</code>.</p><p>You should also create a new top-level variable, <code class="language-plaintext highlighter-rouge">transitionDuration</code>, to control the duration of the transition. JS-based transition &amp; animation APIs typically expect durations in milliseconds. Set it to something large for now like e.g. <code class="language-plaintext highlighter-rouge">3000</code> (3 seconds), to make it easier to debug the transitions. You can also <code class="language-plaintext highlighter-rouge">export</code> it as a prop, so that users of the component can optionally override it.</p><p class="tip">Adding an <code class="language-plaintext highlighter-rouge">&lt;input type=number bind:value={transitionDuration}&gt;</code> to your HTML can be very useful for debugging. It allows you to override the transition at runtime (e.g. to make certain problematic transitions very slow so you can inspect what is happening without slowing everything down.</p><p>The general structure of our function will be:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">transitionArcs</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">wedgeElements</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">values</span><span class="p">(</span><span class="nx">wedges</span><span class="p">);</span>

  <span class="nx">d3</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="nx">wedgeElements</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">transition</span><span class="p">(</span><span class="dl">'</span><span class="s1">arc</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="nx">transitionDuration</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">styleTween</span><span class="p">(</span><span class="dl">'</span><span class="s1">d</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">wedge</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="c1">// Calculations that will only be done once per element go here</span>
      <span class="k">return</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// t is a number between 0 and 1 that represents the transition progress</span>
        <span class="c1">// TODO Interpolate the angles and return the path string that corresponds to t</span>
      <span class="p">};</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div><p>To calculate the arc, we need the angles. To calculate the angles, we need the data (old and new). To find the data, we need the wedge label. All we have is the index, but that‚Äôs all we need:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">label</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">wedges</span><span class="p">)[</span><span class="nx">index</span><span class="p">];</span>
</code></pre></div></div><p>Now that we have the label, we can we can find the corresponding data items in <code class="language-plaintext highlighter-rouge">oldData</code> and <code class="language-plaintext highlighter-rouge">pieData</code>:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">pieData</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">d</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">label</span> <span class="o">===</span> <span class="nx">label</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">d_old</span> <span class="o">=</span> <span class="c1">// ...</span>
</code></pre></div></div><p>Note that we may not have both. For now, let‚Äôs just not proceed in that case:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">d</span> <span class="o">||</span> <span class="o">!</span><span class="nx">d_old</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>We now have all four angles (start and end, old and new), and we can interpolate them. Rather than interpolating them separately, D3 actually allows us to interpolate the whole object:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Always clone objects first, see note in https://d3js.org/d3-interpolate/value#interpolateObject</span>
<span class="kd">let</span> <span class="k">from</span> <span class="o">=</span> <span class="p">{</span> <span class="p">...</span><span class="nx">d_old</span> <span class="p">};</span>
<span class="kd">let</span> <span class="nx">to</span> <span class="o">=</span> <span class="p">{</span> <span class="p">...</span><span class="nx">d</span> <span class="p">};</span>
<span class="kd">let</span> <span class="nx">angleInterpolator</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">interpolate</span><span class="p">(</span><span class="k">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">);</span>
</code></pre></div></div><p><code class="language-plaintext highlighter-rouge">d3.interpolate()</code> will return a function that takes a number between 0 and 1 and returns an object with the same properties as <code class="language-plaintext highlighter-rouge">from</code> and <code class="language-plaintext highlighter-rouge">to</code>, but with all properties interpolated (we only care about <code class="language-plaintext highlighter-rouge">startAngle</code> and <code class="language-plaintext highlighter-rouge">endAngle</code> but we can just ignore the rest). We can feed that object into a function that generates the path string:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">interpolator</span> <span class="o">=</span> <span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s2">`path("</span><span class="p">${</span><span class="nx">arcGenerator</span><span class="p">(</span><span class="nx">angleInterpolator</span><span class="p">(</span><span class="nx">t</span><span class="p">))}</span><span class="s2">")`</span><span class="p">;</span>
</code></pre></div></div><p>Finally, we can now replace the <code class="language-plaintext highlighter-rouge">return t =&gt; {...}</code> line with the interpolator:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="nx">interpolator</span><span class="p">;</span>
</code></pre></div></div><p>If we try it out, you‚Äôll see that it works, at least when transitioning between pies with the same technologies:</p><video src="videos/d3-transition.mp4" loading="lazy" muted="" autoplay="" loop=""></video><h3 id="step-34-transitioning-between-pies-with-different-technologies"> <a href="#step-34-transitioning-between-pies-with-different-technologies" class="anchor-heading" aria-labelledby="step-34-transitioning-between-pies-with-different-technologies"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 3.4: Transitioning between pies with different technologies</h3><p>If you try transitioning between pies with <em>different</em> technologies however, you will notice that it all breaks down:</p><video src="videos/d3-transition-inout.mp4" loading="lazy" muted="" autoplay="" loop=""></video><p>How can we fix this?</p><p>Right now, we simply exit the function if we can‚Äôt find both old and new data items for a wedge. What if we generated dummy objects with the right <code class="language-plaintext highlighter-rouge">startAngle</code> and <code class="language-plaintext highlighter-rouge">endAngle</code> that we want these wedges to transition from or to? We basically want an object where <code class="language-plaintext highlighter-rouge">obj.startAngle</code> and <code class="language-plaintext highlighter-rouge">obj.endAngle</code> are both equal to whatever wedge is drawn immediately before the place our wedge is appearing or disappearing from. The exact logic is a little tricky, so we‚Äôll just provide the code:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">getEmptyArc</span><span class="p">(</span><span class="nx">label</span><span class="p">,</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">pieData</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Union of old and new labels in the order they appear</span>
  <span class="kd">let</span> <span class="nx">labels</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="k">new</span> <span class="nb">Set</span><span class="p">([...</span><span class="nx">oldData</span><span class="p">,</span> <span class="p">...</span><span class="nx">pieData</span><span class="p">].</span><span class="nx">map</span><span class="p">((</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">label</span><span class="p">)));</span>
  <span class="kd">let</span> <span class="nx">labelIndex</span> <span class="o">=</span> <span class="nx">labels</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">label</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">sibling</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">labelIndex</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">sibling</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">find</span><span class="p">((</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">label</span> <span class="o">===</span> <span class="nx">labels</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">sibling</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">let</span> <span class="nx">angle</span> <span class="o">=</span> <span class="nx">sibling</span><span class="p">?.</span><span class="nx">endAngle</span> <span class="p">??</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">return</span> <span class="p">{</span> <span class="na">startAngle</span><span class="p">:</span> <span class="nx">angle</span><span class="p">,</span> <span class="na">endAngle</span><span class="p">:</span> <span class="nx">angle</span> <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div><p>Now, back in our tweening function, we can use <code class="language-plaintext highlighter-rouge">getEmptyArc()</code> as a fallback if we can‚Äôt find the old or new data:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="k">from</span> <span class="o">=</span> <span class="nx">d_old</span> <span class="p">?</span> <span class="p">{...</span><span class="nx">d_old</span><span class="p">}</span> <span class="p">:</span> <span class="nx">getEmptyArc</span><span class="p">(</span><span class="nx">label</span><span class="p">,</span> <span class="nx">oldData</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">to</span> <span class="o">=</span> <span class="c1">// ...</span>
</code></pre></div></div><p class="fyi">The <code class="language-plaintext highlighter-rouge">test ? iftrue : iffalse</code> syntax is the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Conditional_operator">conditional operator</a> which helps us get one value or another based on a test, much more compactly than an <code class="language-plaintext highlighter-rouge">if() {...}</code> block.</p><p>We should now get a perfect transition regardless of the technologies present in the old and new pies, right? Except ‚Ä¶we don‚Äôt. If we preview, we see that all our effort did not make an iota of difference. Why is that?</p><p>The reason is that when we transition between pies with different technologies, the wedges are added to the DOM or removed from the DOM after our code has run.</p><p>Thankfully, Svelte provides a feature dedicated to transitioning element addition or removal from the DOM: <a href="https://svelte.dev/docs/element-directives#transition-fn">Svelte transitions</a>! You can either use the same code for both states, via the <code class="language-plaintext highlighter-rouge">transition:fn</code> directive, or separate functions for entering and leaving, via the <code class="language-plaintext highlighter-rouge">in:fn</code> and <code class="language-plaintext highlighter-rouge">out:fn</code> directives. Svelte provides a bunch of <a href="https://svelte.dev/docs/svelte-transition">predefined functions for common effects</a> that you can just import, but in this case we‚Äôll define our own function.</p><p>The general structure is quite similar to what we did for <code class="language-plaintext highlighter-rouge">d3-transition</code>, just with a different syntax:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">arc</span><span class="p">(</span><span class="nx">wedge</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Calculations that will only be done once per element go here</span>
  <span class="c1">// TODO use transitionArc() to get the data you need</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="na">duration</span><span class="p">:</span> <span class="nx">transitionDuration</span><span class="p">,</span>
    <span class="na">css</span><span class="p">:</span> <span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">u</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// t is a number between 0 and 1 that represents the transition progress; u is 1 - t</span>
      <span class="c1">// TODO return CSS to be applied for the current t as a string, e.g. `fill: red`</span>
    <span class="p">},</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div><p>and then use it, by adding <code class="language-plaintext highlighter-rouge">transition:arc</code> to our wedge <code class="language-plaintext highlighter-rouge">&lt;path&gt;</code> (we can also pass parameters, but we won‚Äôt do that this time).</p><p>There is a lot of the code we wrote in <code class="language-plaintext highlighter-rouge">styleTween</code> that we can reuse in <code class="language-plaintext highlighter-rouge">animateArc</code>. Let‚Äôs abstract it out into a new function, <code class="language-plaintext highlighter-rouge">transitionArc()</code> that accepts a wedge element and optionally its label (as a performance optimization):</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">transitionArc</span><span class="p">(</span><span class="nx">wedge</span><span class="p">,</span> <span class="nx">label</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">label</span> <span class="p">??</span><span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">wedges</span><span class="p">).</span><span class="nx">find</span><span class="p">(([</span><span class="nx">label</span><span class="p">,</span> <span class="nx">w</span><span class="p">])</span> <span class="o">=&gt;</span> <span class="nx">w</span> <span class="o">===</span> <span class="nx">wedge</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div><p>We can now move all our code from <code class="language-plaintext highlighter-rouge">styleTween</code> that calculates <code class="language-plaintext highlighter-rouge">d</code>, <code class="language-plaintext highlighter-rouge">d_old</code>, <code class="language-plaintext highlighter-rouge">from</code>, <code class="language-plaintext highlighter-rouge">to</code>, <code class="language-plaintext highlighter-rouge">interpolator</code> etc into <code class="language-plaintext highlighter-rouge">transitionArc</code>, which will just return an object like:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="p">{</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">d_old</span><span class="p">,</span> <span class="k">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">interpolator</span> <span class="p">};</span>
</code></pre></div></div><p>After <code class="language-plaintext highlighter-rouge">d</code> and <code class="language-plaintext highlighter-rouge">d_old</code> are calculated, we also want to exit early if they are not different:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nx">sameArc</span><span class="p">(</span><span class="nx">d_old</span><span class="p">,</span> <span class="nx">d</span><span class="p">))</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>You should implement the <code class="language-plaintext highlighter-rouge">sameArc()</code> function. It should return <code class="language-plaintext highlighter-rouge">true</code> if either both arcs are falsy (e.g. one is <code class="language-plaintext highlighter-rouge">undefined</code>, the other <code class="language-plaintext highlighter-rouge">null</code>), or if both arcs have the same <code class="language-plaintext highlighter-rouge">startAngle</code> and <code class="language-plaintext highlighter-rouge">endAngle</code>.</p><p>Last, it‚Äôs useful to also add a <code class="language-plaintext highlighter-rouge">type</code> property to the object returned so we know what type of transition we are dealing with:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">d</span> <span class="p">?</span> <span class="p">(</span><span class="nx">d_old</span> <span class="p">?</span> <span class="dl">'</span><span class="s1">update</span><span class="dl">'</span> <span class="p">:</span> <span class="dl">'</span><span class="s1">in</span><span class="dl">'</span><span class="p">)</span> <span class="p">:</span> <span class="dl">'</span><span class="s1">out</span><span class="dl">'</span><span class="p">;</span>
</code></pre></div></div><p>We can now replace the code in <code class="language-plaintext highlighter-rouge">styleTween()</code> to use our new <code class="language-plaintext highlighter-rouge">transitionArc()</code> function:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">wedge</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">label</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">wedges</span><span class="p">)[</span><span class="nx">index</span><span class="p">];</span>
<span class="kd">let</span> <span class="nx">transition</span> <span class="o">=</span> <span class="nx">transitionArc</span><span class="p">(</span><span class="nx">wedge</span><span class="p">,</span> <span class="nx">label</span><span class="p">);</span>
<span class="k">return</span> <span class="nx">transition</span><span class="p">?.</span><span class="nx">interpolator</span><span class="p">;</span>
</code></pre></div></div><p>We can now use the same logic in our Svelte transition! Can you fill the <code class="language-plaintext highlighter-rouge">arc()</code> function so that it calls <code class="language-plaintext highlighter-rouge">transitionArc()</code> to compute the overall transition details and then use the returned <code class="language-plaintext highlighter-rouge">interpolator</code> to produce a CSS declaration for each frame? Remember that the <code class="language-plaintext highlighter-rouge">interpolator</code> that <code class="language-plaintext highlighter-rouge">transitionArc()</code> is returning gives us a CSS <code class="language-plaintext highlighter-rouge">"path(...)"</code> value, so all we need to do to turn this into what Svelte expects is to prepend <code class="language-plaintext highlighter-rouge">"d: "</code> to it.</p><p class="caveat">In ‚Äúout‚Äù transitions, i.e. where an existing element disappears, <strong>Svelte inverts the progression</strong>. Therefore, to get the right CSS string, you need to do do something like <code class="language-plaintext highlighter-rouge">transition.type === "out" ? u : t</code> instead of just <code class="language-plaintext highlighter-rouge">t</code> as the argument to the interpolator (i.e. <code class="language-plaintext highlighter-rouge">transition.interpolator(transition.type === "out" ? u : t)</code>).</p><p class="caveat">The <code class="language-plaintext highlighter-rouge">css</code> function needs to return <strong>a CSS <em>string</em></strong>, not an object! If you get an error like ‚ÄúCannot read properties of <code class="language-plaintext highlighter-rouge">undefined</code> (reading ‚Äòsplit‚Äô)‚Äù it‚Äôs likely because you are returning the wrong type.</p><p>If everything goes well, this is what you should see:</p><video src="videos/svelte-transition-cubic.mp4" loading="lazy" muted="" autoplay="" loop=""></video><h3 id="step-35-harmonizing-easing-across-the-d3-and-svelte-transitions"> <a href="#step-35-harmonizing-easing-across-the-d3-and-svelte-transitions" class="anchor-heading" aria-labelledby="step-35-harmonizing-easing-across-the-d3-and-svelte-transitions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 3.5: Harmonizing easing across the D3 and Svelte transitions</h3><p>We‚Äôre getting there, but there are some weird gaps. This is because we are trying to <em>synchronize</em> Svelte transitions with D3 transitions that have different parameters. While we did take care of applying the same duration across both, they use different easings! Svelte uses linear easing by default, whereas D3 uses <a href="https://d3js.org/d3-ease#easeCubic"><code class="language-plaintext highlighter-rouge">easeCubic</code></a> by default.</p><p>We can fix this in one of two ways:</p><ul><li>By making the D3 transition linear as well, by adding <code class="language-plaintext highlighter-rouge">.ease(d3.easeLinear)</code> to the chain of function calls that make up the transition.<li>By making the Svelte transition cubic as well, by adding <code class="language-plaintext highlighter-rouge">easing: d3.easeCubic</code> to the object returned by <code class="language-plaintext highlighter-rouge">arc()</code>.</ul><p>Try them both and see what you prefer!</p><p class="tip">An easing function is just a function that takes a number between 0 and 1 and returns a number between 0 and 1. Therefore, you can use Svelte easing functions in D3 and vice versa.</p><figure class="multiple"> <video src="videos/svelte-transition-linear.mp4" loading="lazy" muted="" autoplay="" loop=""></video> <video src="videos/svelte-transition-cubic.mp4" loading="lazy" muted="" autoplay="" loop=""></video><figcaption> Left: Linear. Right: Cubic.</figcaption></figure><h2 id="step-4-scrollytelling-part-1-commits-over-time"> <a href="#step-4-scrollytelling-part-1-commits-over-time" class="anchor-heading" aria-labelledby="step-4-scrollytelling-part-1-commits-over-time"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 4: Scrollytelling Part 1 (commits over time)</h2><p>So far, we have been progressing through these visualizations by moving a slider. However, these visualizations both tell a story, the story of how our repo evolved. Wouldn‚Äôt it be cool if we could <em>actually</em> tell that story in our own words, and have the viewer progress through the visualizations as they progress through the narrative?</p><p>Let‚Äôs do that!</p><h3 id="step-40-making-our-page-a-bit-wider-if-there-is-space"> <a href="#step-40-making-our-page-a-bit-wider-if-there-is-space" class="anchor-heading" aria-labelledby="step-40-making-our-page-a-bit-wider-if-there-is-space"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 4.0: Making our page a bit wider, if there is space</h3><p>Because our scrolly will involve a story next to a visualization, we want to be able to use up more space, at least in large viewports.</p><p>We can do this only for the Meta page, by adding a CSS rule where the selector is <code class="language-plaintext highlighter-rouge">:global(body)</code>. <code class="language-plaintext highlighter-rouge">:global()</code> Tells Svelte not to rewrite that part of the selector, and that we will handle any scoping conflicts ourselves.</p><p>Then, within the rule, we want to set the <code class="language-plaintext highlighter-rouge">max-width</code> to <code class="language-plaintext highlighter-rouge">120ch</code> (instead of <code class="language-plaintext highlighter-rouge">100ch</code>), but only as long as that doesn‚Äôt exceed 80% of the viewport width. We can do that like this:</p><div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">max-width</span><span class="o">:</span> <span class="nt">min</span><span class="o">(</span><span class="err">120</span><span class="nt">ch</span><span class="o">,</span> <span class="err">80</span><span class="nt">vw</span><span class="o">);</span>
</code></pre></div></div><h3 id="step-41-using-a-scrolly"> <a href="#step-41-using-a-scrolly" class="anchor-heading" aria-labelledby="step-41-using-a-scrolly"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 4.1: Using a scrolly</h3><p>I prepared a <a href="https://www.npmjs.com/package/svelte-scrolly"><code class="language-plaintext highlighter-rouge">&lt;Scrolly&gt;</code></a> component for you to use in this step, you will find the documentation here: <a href="https://www.npmjs.com/package/svelte-scrolly">svelte-scrolly</a>. If you find any bugs, please <a href="https://github.com/LeaVerou/svelte-scrolly/issues/new">file bug reports</a> directly at <a href="https://github.com/LeaVerou/svelte-scrolly/issues?q=is%3Aissue+is%3Aopen+sort%3Aupdated-desc">its bug tracker</a>.</p><p class="note">There is an official Svelte package for this purpose: <a href="https://www.npmjs.com/package/@sveltejs/svelte-scroller"><code class="language-plaintext highlighter-rouge">@sveltejs/svelte-scroller</code></a> but it seems to only cater to scrollytelling cases where the narrative is overlaid on top of the visualization, which is not what we want here.</p><p>To use <a href="https://www.npmjs.com/package/svelte-scrolly"><code class="language-plaintext highlighter-rouge">&lt;Scrolly&gt;</code></a>, you first need to install it (via <code class="language-plaintext highlighter-rouge">npm install svelte-scrolly</code>), then import it at the top of your component:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">Scrolly</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">svelte-scrolly</span><span class="dl">'</span><span class="p">;</span>
</code></pre></div></div><p>Then you can use it like this:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Scrolly</span> <span class="na">bind:progress=</span><span class="s">"{"</span> <span class="na">myProgressVariable</span> <span class="err">}</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- Story here --&gt;</span>
  <span class="nt">&lt;svelte:fragment</span> <span class="na">slot=</span><span class="s">"viz"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!-- Visualizations here --&gt;</span>
  <span class="nt">&lt;/svelte:fragment&gt;</span>
<span class="nt">&lt;/Scrolly&gt;</span>
</code></pre></div></div><p class="fyi"><a href="https://svelte.dev/docs/special-elements#svelte-fragment"><code class="language-plaintext highlighter-rouge">&lt;svelte:fragment&gt;</code></a> is a special element that we can use when no suitable element exists, to avoid bloating our DOM with pointless wrapper elements. If there is an actual element that makes sense to use, you should use that instead!</p><h3 id="step-42-creating-a-dummy-narrative"> <a href="#step-42-creating-a-dummy-narrative" class="anchor-heading" aria-labelledby="step-42-creating-a-dummy-narrative"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 4.2: Creating a dummy narrative</h3><p><strong>Before you finish the lab, you should have something meaningful for the narrative.</strong> Don‚Äôt spend long on it; you can even generate it with ChatGPT as long as you check that the result is coherent, relevant, and tells a story that complements to the visualization next to it without simply repeating information in a less digestible format.</p><p>For now, let‚Äôs just create some dummy text that we can use to test our scrollytelling so that writing the narrative is not a blocker:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{#each commits as commit, index }
<span class="nt">&lt;p&gt;</span>
  On {commit.datetime.toLocaleString("en", {dateStyle: "full", timeStyle:
  "short"})}, I made
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{commit.url}"</span> <span class="na">target=</span><span class="s">"_blank"</span>
    <span class="nt">&gt;</span>{ index &gt; 0 ? 'another glorious commit' : 'my first commit, and it was
    glorious' }<span class="nt">&lt;/a</span>
  <span class="nt">&gt;</span>. I edited {commit.totalLines} lines across { d3.rollups(commit.lines, D =&gt;
  D.length, d =&gt; d.file).length } files. Then I looked over all I had made, and
  I saw that it was very good.
<span class="nt">&lt;/p&gt;</span>
{/each}
</code></pre></div></div><h3 id="step-43-creating-a-scroller-for-our-commits-over-time"> <a href="#step-43-creating-a-scroller-for-our-commits-over-time" class="anchor-heading" aria-labelledby="step-43-creating-a-scroller-for-our-commits-over-time"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 4.3: Creating a scroller for our commits over time</h3><p>Move the story you just generated into the <a href="https://www.npmjs.com/package/svelte-scrolly"><code class="language-plaintext highlighter-rouge">&lt;Scrolly&gt;</code></a> component, and the scatterplot and pie chart into the <code class="language-plaintext highlighter-rouge">&lt;svelte:fragment slot="viz"&gt;</code>.</p><p>Then, bind the existing <code class="language-plaintext highlighter-rouge">commitProgress</code> variable to the <code class="language-plaintext highlighter-rouge">progress</code> variable of the <a href="https://www.npmjs.com/package/svelte-scrolly"><code class="language-plaintext highlighter-rouge">&lt;Scrolly&gt;</code></a> component (<code class="language-plaintext highlighter-rouge">&lt;Scrolly bind:progress={commitProgress}&gt;</code>).</p><p>If you try it now, you should already see that the scroller is advancing the slider as you scroll!</p><video src="videos/scrolly-commits.mp4" loading="lazy" muted="" autoplay="" loop="" class="tbd"></video><p>Now that everything works, you should remove the slider as it conflicts with the scrolly, and it‚Äôs largely repeating information that the scrollbar already provides.</p><p class="further">One thing you could do is show a date next to the actual browser scrollbar thumb, so that users have a sense of where they are in the timeline.</p><h2 id="step-5-scrollytelling-part-2-file-sizes"> <a href="#step-5-scrollytelling-part-2-file-sizes" class="anchor-heading" aria-labelledby="step-5-scrollytelling-part-2-file-sizes"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 5: Scrollytelling Part 2 (file sizes)</h2><h3 id="step-51-adding-another-scrolly"> <a href="#step-51-adding-another-scrolly" class="anchor-heading" aria-labelledby="step-51-adding-another-scrolly"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 5.1: Adding another scrolly</h3><p>Create another <a href="https://www.npmjs.com/package/svelte-scrolly"><code class="language-plaintext highlighter-rouge">&lt;Scrolly&gt;</code></a> instance for the file sizes visualization, after the commit visualization. You can copy and paste the same narrative as a temporary placeholder, but as with the one about commits, you should replace it with something meaningful before you finish the lab.</p><p>The progress of this component is independent, so you will want to use a different variable for it (and similarly the corresponding <code class="language-plaintext highlighter-rouge">maxTime</code> variable and filtered data). Aside from that, the rest is very similar to Step 4.</p><p>To make it more visually interesting, we can place that story on the right, and the unit visualization on the left. To do that, you add <code class="language-plaintext highlighter-rouge">--scrolly-layout="viz-first"</code> to the component, which passes that CSS variable to it:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Scrolly</span> <span class="na">bind:progress=</span><span class="s">"{raceProgress}"</span> <span class="na">--scrolly-layout=</span><span class="s">"viz-first"</span><span class="nt">&gt;&lt;/Scrolly&gt;</span>
</code></pre></div></div><p>You can also specify <code class="language-plaintext highlighter-rouge">--scrolly-viz-width="1.5fr"</code> to change the proportion of viz to story to 3:2 give it more space.</p><h3 id="step-52-limit-number-of-updates"> <a href="#step-52-limit-number-of-updates" class="anchor-heading" aria-labelledby="step-52-limit-number-of-updates"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 5.2: Limit number of updates</h3><p>Our scrolly currently looks smooth if we scroll relatively slowly, but breaks down if we scroll fast:</p><video src="videos/scrolly-broken.mp4" loading="lazy" muted="" autoplay="" loop="" class="browser"></video><p>This is where <a href="https://css-tricks.com/debouncing-throttling-explained-examples/">throttling and debouncing</a> come in. They are both methods of achieving the same goal: limiting the number of times a function is called.</p><ul><li><strong>Throttling</strong> enforces a minimum interval between subsequent calls to the same action.<li><strong>Debouncing</strong> defers an action until a certain period of time has passed since the last user action.</ul><p>The <a href="https://www.npmjs.com/package/svelte-scrolly"><code class="language-plaintext highlighter-rouge">&lt;Scrolly&gt;</code></a> component we are using supports both, via <code class="language-plaintext highlighter-rouge">throttle</code> and <code class="language-plaintext highlighter-rouge">debounce</code> props. Experiment with different values for these props (you don‚Äôt need to use both) to see what works best for your scrolly.</p><hr /><p>The final result looks similar to this:</p><video src="videos/final.mp4" loading="lazy" muted="" autoplay="" loop="" class="browser"></video><h2 id="resources"> <a href="#resources" class="anchor-heading" aria-labelledby="resources"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Resources</h2><h3 id="transitions--animations"> <a href="#transitions--animations" class="anchor-heading" aria-labelledby="transitions--animations"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Transitions &amp; Animations</h3><p>Tech:</p><ul><li><a href="./slides/#technologies">Cheatsheet on animation-related technologies</a><li><a href="https://www.joshwcomeau.com/animation/css-transitions/">An interactive guide to CSS transitions</a></ul><h3 id="scrollytelling"> <a href="#scrollytelling" class="anchor-heading" aria-labelledby="scrollytelling"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Scrollytelling</h3><p>Cool examples:</p><ul><li><a href="https://pudding.cool/2024/03/teenagers/">This is a teenager</a><li><a href="http://www.r2d3.us/visual-intro-to-machine-learning-part-1/">A visual introduction to Machine Learning Part 1</a><li><a href="http://www.r2d3.us/visual-intro-to-machine-learning-part-2/">A visual introduction to Machine Learning Part 2</a><li><a href="https://benjerry.heshlindsdataviz.com/">Ben &amp; Jerry‚Äôs</a></ul></div></div><div class="search-overlay"></div></div>
