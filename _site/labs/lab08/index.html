<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><title>Lab 8: Geospatial Visualizations | DSC 106</title><meta name="generator" content="Jekyll v3.9.0" /><meta property="og:title" content="Lab 8: Geospatial Visualizations" /><meta name="author" content="Sam Lau" /><meta property="og:locale" content="en_US" /><meta name="description" content="DSC 106, Winter 2025 at UC San Diego" /><meta property="og:description" content="DSC 106, Winter 2025 at UC San Diego" /><link rel="canonical" href="http://localhost:4000/labs/lab08/" /><meta property="og:url" content="http://localhost:4000/labs/lab08/" /><meta property="og:site_name" content="DSC 106" /><meta property="og:type" content="website" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Lab 8: Geospatial Visualizations" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Sam Lau"},"description":"DSC 106, Winter 2025 at UC San Diego","headline":"Lab 8: Geospatial Visualizations","url":"http://localhost:4000/labs/lab08/"}</script><body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> </svg><div class="side-bar"><div class="site-header"> <a href="/" class="site-title lh-tight"> DSC 106 </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a></div><nav aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">🏠 Home</a><li class="nav-list-item"><a href="/syllabus/" class="nav-list-link">📖 Syllabus</a><li class="nav-list-item"><a href="/calendar/" class="nav-list-link">📆 Calendar</a><li class="nav-list-item"><a href="/tech_support/" class="nav-list-link">🙋‍♂️ Tech Support</a><li class="nav-list-item"><a href="/resources/" class="nav-list-link">📚 Resources</a><li class="nav-list-item"><a href="/staff/" class="nav-list-link">👩‍🏫 Staff</a><li class="nav-list-item active"><a href="#" class="nav-list-expander" aria-label="toggle links in 👩‍🔬 Programming Labs category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/labs/" class="nav-list-link">👩‍🔬 Programming Labs</a><ul class="nav-list "><li class="nav-list-item "><a href="/labs/debugging/" class="nav-list-link">Help Us Help You: Things to try before asking for help</a><li class="nav-list-item "><a href="/labs/lab00/" class="nav-list-link">Lab 0: Setup</a><li class="nav-list-item "><a href="/labs/lab01/" class="nav-list-link">Lab 1: Introduction to the Web platform</a><li class="nav-list-item "><a href="/labs/lab02/" class="nav-list-link">Lab 2: Styling with CSS</a><li class="nav-list-item "><a href="/labs/lab03/" class="nav-list-link">Lab 3: Introduction to JS</a><li class="nav-list-item "><a href="/labs/lab04/" class="nav-list-link">Lab 4: Svelte (Templating & Control Flow)</a><li class="nav-list-item "><a href="/labs/lab05/" class="nav-list-link">Lab 5: Svelte II (Loading Data & Reactivity)</a><li class="nav-list-item "><a href="/labs/lab06/" class="nav-list-link">Lab 6: Visualizing categorical data with D3</a><li class="nav-list-item "><a href="/labs/lab07/" class="nav-list-link">Lab 7: Visualizing quantitative data with D3</a><li class="nav-list-item active"><a href="/labs/lab08/" class="nav-list-link active">Lab 8: Geospatial Visualizations</a><li class="nav-list-item "><a href="/labs/lab09/" class="nav-list-link">Lab 9: Animation & Scrollytelling</a></ul><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in 📝 Projects category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/projects/" class="nav-list-link">📝 Projects</a><ul class="nav-list "><li class="nav-list-item "><a href="/projects/final_project/" class="nav-list-link">Final Project</a><li class="nav-list-item "><a href="/projects/project1/" class="nav-list-link">Project 1: Expository Visualization</a><li class="nav-list-item "><a href="/projects/project2/" class="nav-list-link">Project 2: Deceptive Visualization</a><li class="nav-list-item "><a href="/projects/project2peer/" class="nav-list-link">Project 2: Deceptive Visualization - Peer Grading</a><li class="nav-list-item "><a href="/projects/project3/" class="nav-list-link">Project 3: Interactive Visualization</a><li class="nav-list-item "><a href="/projects/project3peer/" class="nav-list-link">Project 3: Interactive Visualization - Peer Grading</a></ul><li class="nav-list-item"><a href="/labs/lab09/todo/" class="nav-list-link">For next year</a><li class="nav-list-item"><a href="/labs/lab07/old/" class="nav-list-link">Old content, ignore</a><li class="nav-list-item"><a href="/labs/lab09/playtesting/" class="nav-list-link">Playtesting</a><li class="nav-list-item"><a href="/labs/lab05/playtesting/" class="nav-list-link">Playtesting</a><li class="nav-list-item"><a href="/labs/lab06/playtesting/" class="nav-list-link">Playtesting</a><li class="nav-list-item"><a href="/labs/lab07/playtesting/" class="nav-list-link">Playtesting</a><li class="nav-list-item"><a href="/labs/lab08/playtesting/" class="nav-list-link">Playtesting</a><li class="nav-list-item"><a href="/labs/lab02/playtesting/" class="nav-list-link">Playtesting Lab 2</a><li class="nav-list-item"><a href="/labs/lab04/playtesting/enrique/" class="nav-list-link">create-svelte</a><li class="nav-list-item"><a href="/labs/lab04/playtesting/" class="nav-list-link">create-svelte</a></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search DSC 106" aria-label="Search DSC 106" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="" class="site-button" > 💻 GitHub </a><li class="aux-nav-list-item"> <a href="" class="site-button" > 🙋 Ed </a><li class="aux-nav-list-item"> <a href="" class="site-button" > 💯 Gradescope </a></ul></nav></div><div id="main-content-wrap" class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="/labs/">👩‍🔬 Programming Labs</a><li class="breadcrumb-nav-list-item"><span>Lab 8: Geospatial Visualizations</span></ol></nav><div id="main-content" class="main-content" role="main"><h1 id="lab-8-geospatial-visualizations"> <a href="#lab-8-geospatial-visualizations" class="anchor-heading" aria-labelledby="lab-8-geospatial-visualizations"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Lab 8: Geospatial visualizations</h1><blockquote class="no_toc summary"><p>In this lab, we will:</p><ul><li>Learn how to embed a Mapbox map into a webpage<li>Learn to add data-driven layers within a Mapbox canvas.<li>Learn to add custom SVG overlays on Mapbox maps and adapt to the map’s panning and zooming<li>Practice creating visualizations with large datasets of real-world data, by importing, parsing, filtering and binding to elements on the page.</ul></blockquote><details open=""> <summary class="text-delta"> Table of contents </summary><ul id="markdown-toc"><li><a href="#lab-8-geospatial-visualizations" id="markdown-toc-lab-8-geospatial-visualizations">Lab 8: Geospatial visualizations</a><ul><li><a href="#check-off" id="markdown-toc-check-off">Check-off</a><li><a href="#what-will-we-make" id="markdown-toc-what-will-we-make">What will we make?</a><li><a href="#step-0-start-a-new-svelte-project" id="markdown-toc-step-0-start-a-new-svelte-project">Step 0: Start a new Svelte project</a><ul><li><a href="#step-01-create-a-new-repository-and-push-it-to-github" id="markdown-toc-step-01-create-a-new-repository-and-push-it-to-github">Step 0.1: Create a new repository and push it to GitHub</a><li><a href="#step-02-publish-your-new-project-to-github-pages" id="markdown-toc-step-02-publish-your-new-project-to-github-pages">Step 0.2: Publish your new project to GitHub Pages</a><li><a href="#step-03-start-local-server" id="markdown-toc-step-03-start-local-server">Step 0.3: Start local server</a><li><a href="#step-04-edit-routespagesvelte" id="markdown-toc-step-04-edit-routespagesvelte">Step 0.4: Edit <code class="language-plaintext highlighter-rouge">routes/+page.svelte</code></a><li><a href="#step-05-add-basic-styling" id="markdown-toc-step-05-add-basic-styling">Step 0.5: Add basic styling</a><li><a href="#step-06-add-a-bike-favicon-optional" id="markdown-toc-step-06-add-a-bike-favicon-optional">Step 0.6: Add a bike favicon <em>(optional)</em></a></ul><li><a href="#step-1-my-first-map" id="markdown-toc-step-1-my-first-map">Step 1: My first map</a><ul><li><a href="#step-10-create-a-mapbox-account" id="markdown-toc-step-10-create-a-mapbox-account">Step 1.0: Create a Mapbox account</a><li><a href="#step-11-install-mapboxjs" id="markdown-toc-step-11-install-mapboxjs">Step 1.1: Install Mapbox.js</a><li><a href="#step-12-add-an-element-to-hold-the-map" id="markdown-toc-step-12-add-an-element-to-hold-the-map">Step 1.2: Add an element to hold the map</a><li><a href="#step-13-import-mapbox-and-connect-it-to-our-account" id="markdown-toc-step-13-import-mapbox-and-connect-it-to-our-account">Step 1.3: Import Mapbox and connect it to our account</a><li><a href="#step-14-create-the-map" id="markdown-toc-step-14-create-the-map">Step 1.4: Create the map</a><li><a href="#step-15-customizing-the-map-optional" id="markdown-toc-step-15-customizing-the-map-optional">Step 1.5: Customizing the map <em>(optional)</em></a></ul><li><a href="#step-2-adding-bike-lanes" id="markdown-toc-step-2-adding-bike-lanes">Step 2: Adding bike lanes</a><ul><li><a href="#step-20-getting-familiar-with-the-data" id="markdown-toc-step-20-getting-familiar-with-the-data">Step 2.0: Getting familiar with the data</a><li><a href="#step-21-import-the-data" id="markdown-toc-step-21-import-the-data">Step 2.1: Import the data</a><li><a href="#step-22-drawing-bike-lanes-on-the-map" id="markdown-toc-step-22-drawing-bike-lanes-on-the-map">Step 2.2: Drawing bike lanes on the map</a><li><a href="#step-23-styling-the-bike-lanes" id="markdown-toc-step-23-styling-the-bike-lanes">Step 2.3: Styling the bike lanes</a><li><a href="#step-24-adding-cambridge-bike-lanes" id="markdown-toc-step-24-adding-cambridge-bike-lanes">Step 2.4: Adding Cambridge bike lanes</a></ul><li><a href="#step-3-adding-bike-stations" id="markdown-toc-step-3-adding-bike-stations">Step 3: Adding bike stations</a><ul><li><a href="#step-31-fetching-and-parsing-the-csv" id="markdown-toc-step-31-fetching-and-parsing-the-csv">Step 3.1: Fetching and parsing the CSV</a><li><a href="#step-32-overlaying-svg-on-the-map" id="markdown-toc-step-32-overlaying-svg-on-the-map">Step 3.2: Overlaying SVG on the map</a><li><a href="#step-33-adding-station-markers" id="markdown-toc-step-33-adding-station-markers">Step 3.3: Adding station markers</a><li><a href="#step-34-adjusting-station-markers-when-map-is-zoomedpanned" id="markdown-toc-step-34-adjusting-station-markers-when-map-is-zoomedpanned">Step 3.4: Adjusting station markers when map is zoomed/panned</a></ul><li><a href="#step-4-visualizing-bike-traffic" id="markdown-toc-step-4-visualizing-bike-traffic">Step 4: Visualizing bike traffic</a><ul><li><a href="#step-41-importing-and-parsing-the-traffic-data" id="markdown-toc-step-41-importing-and-parsing-the-traffic-data">Step 4.1: Importing and parsing the traffic data</a><li><a href="#step-42-calculating-traffic-at-each-station" id="markdown-toc-step-42-calculating-traffic-at-each-station">Step 4.2: Calculating traffic at each station</a><li><a href="#step-43-size-markers-according-to-traffic" id="markdown-toc-step-43-size-markers-according-to-traffic">Step 4.3: Size markers according to traffic</a><li><a href="#step-44-adding-a-tooltip-with-exact-traffic-numbers-optional" id="markdown-toc-step-44-adding-a-tooltip-with-exact-traffic-numbers-optional">Step 4.4: Adding a tooltip with exact traffic numbers <em>(optional)</em></a></ul><li><a href="#step-5-interactive-data-filtering" id="markdown-toc-step-5-interactive-data-filtering">Step 5: Interactive data filtering</a><ul><li><a href="#step-51-adding-the-html-and-css-for-the-slider" id="markdown-toc-step-51-adding-the-html-and-css-for-the-slider">Step 5.1: Adding the HTML and CSS for the slider</a><li><a href="#step-52-reactivity" id="markdown-toc-step-52-reactivity">Step 5.2: Reactivity</a><li><a href="#step-53-filtering-the-data" id="markdown-toc-step-53-filtering-the-data">Step 5.3: Filtering the data</a><li><a href="#step-54-performance-optimizations-optional-if-you-dont-have-this-problem" id="markdown-toc-step-54-performance-optimizations-optional-if-you-dont-have-this-problem">Step 5.4: Performance optimizations <em>(optional if you don’t have this problem)</em></a></ul><li><a href="#step-6-visualizing-traffic-flow" id="markdown-toc-step-6-visualizing-traffic-flow">Step 6: Visualizing traffic <em>flow</em></a><ul><li><a href="#step-61-make-circle-color-depend-on-traffic-flow" id="markdown-toc-step-61-make-circle-color-depend-on-traffic-flow">Step 6.1: Make circle color depend on traffic flow</a><li><a href="#step-62-adding-a-legend" id="markdown-toc-step-62-adding-a-legend">Step 6.2: Adding a legend</a><ul><li><a href="#design-1-blocks" id="markdown-toc-design-1-blocks">Design 1: Blocks</a><li><a href="#design-2-separate-swatches--labels" id="markdown-toc-design-2-separate-swatches--labels">Design 2: Separate swatches &amp; labels</a></ul></ul><li><a href="#step-7-add-your-new-project-to-your-list-of-projects" id="markdown-toc-step-7-add-your-new-project-to-your-list-of-projects">Step 7: Add your new project to your list of projects!</a></ul></ul></details><hr /><h2 id="check-off"> <a href="#check-off" class="anchor-heading" aria-labelledby="check-off"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Check-off</h2><p><strong>You need to come to TA Office Hours to get checked off for this lab</strong> (any of them, no appointment needed). Please fill in <a href="checkoff">the check-off form at <code class="language-plaintext highlighter-rouge">labs/8/checkoff</code></a> <em>before</em> your check-off. Ideally you should fill in the form <em>right before</em> your check-off, but it’s ok if you fill it out in advance.</p><p class="warning">Filling out the form is a necessary but not sufficient condition to get checked-off. <strong>You still need to come to office hours in person for your check-off to be processed.</strong></p><p>You could even fill it out before you finish the lab, since we won’t look at it until your check-off, but the closer to the end of the lab you fill it out, the more meaningful your feedback will be.</p><h2 id="what-will-we-make"> <a href="#what-will-we-make" class="anchor-heading" aria-labelledby="what-will-we-make"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> What will we make?</h2><p>In this lab, we will be building an immersive, interactive map visualization of bike traffic in the Boston area during different times of the day, shown in the screencast below:</p><video src="videos/final.mp4" loop="" muted="" autoplay="" class="browser"></video><ul><li>The underlying map shows Boston area roads and labels of neighborhoods. You can pan and zoom around as you would with services like Google Maps.<li>The green lines show bike lanes. We will be importing two datasets from the city governments of Boston and Cambridge for this.<li>The circles represent individual BlueBike stations. The size of each circle represents the amount of traffic at each station, while the color represents whether most traffic is entering or leaving the station. We will be using two datasets from BlueBikes to analyze bike traffic from about 260,000 individual rides from March 2024.<li>There is a slider at the top right that allows the user to filter the data for traffic at specific times of the day, and the circles will change size and color accordingly.</ul><p>There is a lot of room for styling and customization in this lab, and you are free to choose colors and themes that you prefer. So the screenshots and videos here are for reference only and your version can differ in appearance (but should be functionally the same!).</p><h2 id="step-0-start-a-new-svelte-project"> <a href="#step-0-start-a-new-svelte-project" class="anchor-heading" aria-labelledby="step-0-start-a-new-svelte-project"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 0: Start a new Svelte project</h2><h3 id="step-01-create-a-new-repository-and-push-it-to-github"> <a href="#step-01-create-a-new-repository-and-push-it-to-github" class="anchor-heading" aria-labelledby="step-01-create-a-new-repository-and-push-it-to-github"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 0.1: Create a new repository and push it to GitHub</h3><p>In this lab, we will be working on a new project and thus a new repository (that we will subsequently list on our projects page). Follow <a href="../4/#step-1-setting-up">step 1 of lab 4</a> again to set up a new Svelte project with a new repo name this time. I called mine <code class="language-plaintext highlighter-rouge">bikewatching</code>, but you may want to get more creative with bike-related puns. 😉</p><h3 id="step-02-publish-your-new-project-to-github-pages"> <a href="#step-02-publish-your-new-project-to-github-pages" class="anchor-heading" aria-labelledby="step-02-publish-your-new-project-to-github-pages"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 0.2: Publish your new project to GitHub Pages</h3><p>Also follow <a href="https://vis-society.github.io/labs/4/#step-3-publishing-our-new-website-to-github-pages">step 3 from the same lab</a> to set up GitHub Pages for your new project.</p><h3 id="step-03-start-local-server"> <a href="#step-03-start-local-server" class="anchor-heading" aria-labelledby="step-03-start-local-server"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 0.3: Start local server</h3><p>Run <code class="language-plaintext highlighter-rouge">npm run dev --open</code> to start the local server and open the project in your browser.</p><h3 id="step-04-edit-routespagesvelte"> <a href="#step-04-edit-routespagesvelte" class="anchor-heading" aria-labelledby="step-04-edit-routespagesvelte"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 0.4: Edit <code class="language-plaintext highlighter-rouge">routes/+page.svelte</code></h3><p>Replace the content of <code class="language-plaintext highlighter-rouge">routes/+page.svelte</code> with a heading of your project name and a brief description of what it does. Commit and push the change, and make sure the website updates accordingly.</p><h3 id="step-05-add-basic-styling"> <a href="#step-05-add-basic-styling" class="anchor-heading" aria-labelledby="step-05-add-basic-styling"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 0.5: Add basic styling</h3><p>Create a CSS file for global styles in <code class="language-plaintext highlighter-rouge">src/lib</code> called <code class="language-plaintext highlighter-rouge">global.css</code> and add the following content:</p><div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">body</span> <span class="p">{</span>
  <span class="nl">font</span><span class="p">:</span> <span class="m">100%</span><span class="p">/</span><span class="m">1.5</span> <span class="n">system-ui</span><span class="p">,</span> <span class="nb">sans-serif</span><span class="p">;</span>
  <span class="nl">display</span><span class="p">:</span> <span class="n">flex</span><span class="p">;</span>
  <span class="nl">flex-flow</span><span class="p">:</span> <span class="n">column</span><span class="p">;</span>
  <span class="nl">max-width</span><span class="p">:</span> <span class="m">80em</span><span class="p">;</span>
  <span class="nl">min-height</span><span class="p">:</span> <span class="m">100vh</span><span class="p">;</span>
  <span class="nl">box-sizing</span><span class="p">:</span> <span class="n">border-box</span><span class="p">;</span>
  <span class="nl">margin</span><span class="p">:</span> <span class="nb">auto</span><span class="p">;</span>
  <span class="nl">padding</span><span class="p">:</span> <span class="m">1em</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>Then, in your <code class="language-plaintext highlighter-rouge">src/routes/+page.svelte</code> file, import the CSS file by adding this in a <code class="language-plaintext highlighter-rouge">&lt;style&gt;</code> element:</p><div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@import</span> <span class="sx">url('$lib/global.css')</span><span class="p">;</span>
</code></pre></div></div><p>At this point, you should be seeing something like this:</p><p><img src="images/step-0.png" class="browser" alt="" /></p><h3 id="step-06-add-a-bike-favicon-optional"> <a href="#step-06-add-a-bike-favicon-optional" class="anchor-heading" aria-labelledby="step-06-add-a-bike-favicon-optional"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 0.6: Add a bike favicon <em>(optional)</em></h3><p>To distinguish open tabs from your project, you can customize its <em><a href="https://en.wikipedia.org/wiki/Favicon">favicon</a></em>.</p><p>In your <code class="language-plaintext highlighter-rouge">static</code> directory, add a <code class="language-plaintext highlighter-rouge">favicon.svg</code> file with the following content:</p><div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;svg</span> <span class="na">xmlns=</span><span class="s">"http://www.w3.org/2000/svg"</span> <span class="na">viewBox=</span><span class="s">"0 0 100 100"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;text</span> <span class="na">y=</span><span class="s">".9em"</span> <span class="na">font-size=</span><span class="s">"90"</span><span class="nt">&gt;</span>🚴🏼‍♀️<span class="nt">&lt;/text&gt;</span>
<span class="nt">&lt;/svg&gt;</span>
</code></pre></div></div><p>Feel free to use any emoji you want. Then edit <code class="language-plaintext highlighter-rouge">src/app.html</code> to change <code class="language-plaintext highlighter-rouge">favicon.png</code> to <code class="language-plaintext highlighter-rouge">favicon.svg</code> here:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"icon"</span> <span class="na">href=</span><span class="s">"%sveltekit.assets%/favicon.png"</span> <span class="nt">/&gt;</span>
</code></pre></div></div><p>You may also want to add a <code class="language-plaintext highlighter-rouge">&lt;title&gt;</code> with your project title, as a fallback for pages that don’t specify one.</p><p>It should look like this: <img src="/labs/lab08/images/favicon.png" alt="" /></p><p class="tip">You can now delete <code class="language-plaintext highlighter-rouge">static/favicon.png</code> if you want to keep things tidy, since we’re not using it anymore.</p><h2 id="step-1-my-first-map"> <a href="#step-1-my-first-map" class="anchor-heading" aria-labelledby="step-1-my-first-map"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1: My first map</h2><h3 id="step-10-create-a-mapbox-account"> <a href="#step-10-create-a-mapbox-account" class="anchor-heading" aria-labelledby="step-10-create-a-mapbox-account"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1.0: Create a Mapbox account</h3><p>Go to <a href="https://www.mapbox.com/">Mapbox</a> and create an account <a href="https://www.mapbox.com/community/education">using your MIT email</a>. We will be using the free service tier which carries no charge.</p><p>After you sign up, make sure to verify your email.</p><h3 id="step-11-install-mapboxjs"> <a href="#step-11-install-mapboxjs" class="anchor-heading" aria-labelledby="step-11-install-mapboxjs"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1.1: Install Mapbox.js</h3><p>In your project directory, run the following command to install the Mapbox.js library:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install </span>mapbox-gl
</code></pre></div></div><h3 id="step-12-add-an-element-to-hold-the-map"> <a href="#step-12-add-an-element-to-hold-the-map" class="anchor-heading" aria-labelledby="step-12-add-an-element-to-hold-the-map"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1.2: Add an element to hold the map</h3><p>We will largely follow the steps outlined in <a href="https://docs.mapbox.com/help/tutorials/use-mapbox-gl-js-with-svelte/">Mapbox’s official docs about Svelte integration</a>.</p><p>Let’s create an element to receive our map and bind it to a variable (we’ll need to reference that when we tell Mapbox to create a map there):</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"map"</span> <span class="nt">/&gt;</span>
</code></pre></div></div><p>We also want to add some CSS to ensure the map will have sufficient height:</p><div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">#map</span> <span class="p">{</span>
  <span class="nl">flex</span><span class="p">:</span> <span class="m">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>Try giving the map a background color to make sure it’s taking up the space you expect:</p><p><img src="images/map-empty.png" class="browser" alt="" /></p><h3 id="step-13-import-mapbox-and-connect-it-to-our-account"> <a href="#step-13-import-mapbox-and-connect-it-to-our-account" class="anchor-heading" aria-labelledby="step-13-import-mapbox-and-connect-it-to-our-account"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1.3: Import Mapbox and connect it to our account</h3><p>In order to use Mapbox, we first need to import its JS and CSS. In your <code class="language-plaintext highlighter-rouge">src/routes/+page.svelte</code> file, inside your <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> tag, add this:</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">mapboxgl</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">mapbox-gl</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="dl">'</span><span class="s1">../../node_modules/mapbox-gl/dist/mapbox-gl.css</span><span class="dl">'</span><span class="p">;</span>
</code></pre></div></div><p>Then, we need to connect our account to it, by setting up our access token:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">mapboxgl</span><span class="p">.</span><span class="nx">accessToken</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">your access token here</span><span class="dl">'</span><span class="p">;</span>
</code></pre></div></div><p>To find your access token, you go to your account page on Mapbox:</p><p><img src="images/access-token.png" class="browser" /></p><p class="warning">Make sure your repo is private before you push your access token to GitHub!</p><h3 id="step-14-create-the-map"> <a href="#step-14-create-the-map" class="anchor-heading" aria-labelledby="step-14-create-the-map"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1.4: Create the map</h3><p>To create the map, we create a new <code class="language-plaintext highlighter-rouge">mapboxgl.Map</code> object with <a href="https://docs.mapbox.com/mapbox-gl-js/api/map/">settings</a> that specify things like:</p><ul><li>which HTML element will hold the map? (<code class="language-plaintext highlighter-rouge">container</code>) This can be either an element reference, or a string with the element’s ID (which is what we will use)<li>What will the <em>basemap</em> look like? (<code class="language-plaintext highlighter-rouge">style</code>)<li><em>Map extent</em>:<ul><li>What latitude and longitude will the map be centered on? (<code class="language-plaintext highlighter-rouge">center: [longitude, latitude]</code>)<li>How zoomed in will the map start off and what will be the min &amp; max zoom allowed? (<code class="language-plaintext highlighter-rouge">zoom</code>, <code class="language-plaintext highlighter-rouge">minZoom</code>, <code class="language-plaintext highlighter-rouge">maxZoom</code>)</ul></ul><p>We want to do that <em>only</em> in the browser, so we will use the <a href="https://learn.svelte.dev/tutorial/onmount"><code class="language-plaintext highlighter-rouge">onMount</code> lifecycle function</a>, which we need to import separately from <code class="language-plaintext highlighter-rouge">svelte</code>:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">onMount</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">svelte</span><span class="dl">'</span><span class="p">;</span>

<span class="nx">onMount</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mapboxgl</span><span class="p">.</span><span class="nb">Map</span><span class="p">({</span>
    <span class="cm">/* options */</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div><p>In terms of what values to apply to options:</p><ul><li>For the container, we want to specify an id so we don’t have to worry about element references.<li>For the style, I used <code class="language-plaintext highlighter-rouge">"mapbox://styles/mapbox/streets-v12"</code> but you are welcome to choose any <a href="https://docs.mapbox.com/api/maps/styles/#classic-mapbox-styles">other style</a> you like. Keep in mind that the busier the style, the harder it will be to see your data drawn on top of it.<li>Map extent:<ul><li>I used <code class="language-plaintext highlighter-rouge">12</code> for the zoom level (<code class="language-plaintext highlighter-rouge">zoom</code>)<li>You can use any centerpoint you like (I used MIT’s HQ), but it should be within the Cambridge &amp; Boston area. See below for how to find the latitude and longitude of any location.</ul></ul><p>To find the coordinates of a location, you can enter it on Google Maps, and then right click and select the first option:</p><p><img src="/labs/lab08/images/gps-copy.png" alt="" /></p><p>Another way is via the URL, it’s the part after the <code class="language-plaintext highlighter-rouge">@</code>: <img src="/labs/lab08/images/gmaps-latlng.png" alt="" /></p><p>Note that you will need to specify them in the reverse order, as <a href="https://docs.mapbox.com/api/overview/#coordinate-format">Mapbox expects longitude first</a>.</p><p>If everything went well, you should have a map of Boston already! 🎉</p><p><img src="images/step-1.png" class="browser" alt="" /></p><p>Try panning and zooming around to see the map in action.</p><p>Right click your map element and inspect it using the dev tools. Notice how Mapbox has added a bunch of elements to the DOM to render the map, including a <code class="language-plaintext highlighter-rouge">&lt;canvas&gt;</code> element that it uses to draw the map.</p><p><img src="images/dev-tools-screenshot.png" alt="Dev tools" /></p><p>Don’t like how your map looks? Try the optional step below!</p><h3 id="step-15-customizing-the-map-optional"> <a href="#step-15-customizing-the-map-optional" class="anchor-heading" aria-labelledby="step-15-customizing-the-map-optional"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1.5: Customizing the map <em>(optional)</em></h3><p>The map style in its current form is quite functional as it shows a lot of useful waypoints and detail. However, sometimes we’d like to create a more stylized map to create a cohesive design language across our website, or simply to draw readers in with a unique design.</p><p>Luckily, Mapbox provides a way to fully customize your map style using <a href="https://docs.mapbox.com/studio-manual/guides/"><strong>Mapbox Studio</strong></a>. To access Mapbox Studio, go back to your Mapbox account page and click “Create a map in Studio”.</p><p><img src="images/mapbox-studio-red-box.png" class="browser" /></p><p>Next, create a new style.</p><p><img src="images/new-style.png" class="inline" /></p><p>From here, you are free to create a style however you’d like! As a starting point, many high quality map visualizations end up using a monochrome style, which you can find by clicking on “Classic template”, then “Monochrome”. Once you’ve selected a variant from the list of styles, click on the “Customize” buttom to add further customization, which will open up the actual studio, shown below.</p><p><img src="images/mapbox-studio.png" class="browser" /></p><p>Mapbox styles are made up of <a href="https://docs.mapbox.com/studio-manual/reference/styles/#layers">layers</a> and <a href="https://docs.mapbox.com/studio-manual/reference/styles/#components">components</a> (e.g. natural features, streets, points of interest, transit nodes, etc.). These items have properties which can be edited, such as the color or font, and can even be removed for a cleaner look. For example, if you wanted to make the color of the bodies of water a more natural blue color in this monochrome example, you could click on the “Land &amp; water <em>water</em>” layer in the left panel and simply adjust the color in the color picker.</p><p><img src="images/mapbox-edit-property.png" class="browser" /></p><p>Once you are done playing around with the style, you can <a href="https://docs.mapbox.com/studio-manual/guides/publish-your-style/"><strong>publish it</strong></a> so that it can be referenced in your code where you define the map, as you did in <a href="#step-14-create-the-map">Step 1.4</a>. To do so, click “Publish” in the top right corner of the studio interface.</p><p>Then, click on the three dots next to your style name to find the style URL (it will look something like this: <code class="language-plaintext highlighter-rouge">mapbox://styles/casillasenrique/clukyyerk007v01pb6r107k1o</code>).</p><p><img src="images/copy-style.png" /></p><p>Copy it and paste this URL in your <code class="language-plaintext highlighter-rouge">style</code> property when defining the <code class="language-plaintext highlighter-rouge">mapboxgl.Map</code> object. You should now see that your map uses your custom style!</p><p><img src="images/studio-final-in-code.png" class="browser" /></p><p>Now, each time you edit your map style in Mapbox Studio and re-publish it, the updated style will automatically be applied in your website (note that sometimes the style takes a couple of minutes to update after publishing).</p><h2 id="step-2-adding-bike-lanes"> <a href="#step-2-adding-bike-lanes" class="anchor-heading" aria-labelledby="step-2-adding-bike-lanes"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2: Adding bike lanes</h2><h3 id="step-20-getting-familiar-with-the-data"> <a href="#step-20-getting-familiar-with-the-data" class="anchor-heading" aria-labelledby="step-20-getting-familiar-with-the-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2.0: Getting familiar with the data</h3><p>The City of Boston provides an <a href="https://bostonopendata-boston.opendata.arcgis.com/datasets/boston::existing-bike-network-2022.geojson?outSR=%7B%22latestWkid%22%3A3857%2C%22wkid%22%3A102100%7D">open dataset with bike lanes in the city</a>. The dataset is in <a href="https://en.wikipedia.org/wiki/GeoJSON">GeoJSON</a> format, which is just JSON that follows a specific structure, designed to represent geographical data.</p><p>Download the dataset, open it in VS Code, and examine its structure.</p><p class="tip">Try pressing <kbd>Cmd</kbd> + <kbd>Shift</kbd> + <kbd>P</kbd> to open the command palette, and then select “Format document” to make the JSON more readable.</p><h3 id="step-21-import-the-data"> <a href="#step-21-import-the-data" class="anchor-heading" aria-labelledby="step-21-import-the-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2.1: Import the data</h3><p>Mapbox provides an <code class="language-plaintext highlighter-rouge">addSource</code> function to connect the map with an external data <a href="https://docs.mapbox.com/mapbox-gl-js/api/sources/">source</a>. However, to use any of that, we first need to wait for the <code class="language-plaintext highlighter-rouge">"load"</code> event to fire on <code class="language-plaintext highlighter-rouge">map</code>. To avoid nesting all our code in an event listener, we can instead convert our <code class="language-plaintext highlighter-rouge">onMount</code> function to an <code class="language-plaintext highlighter-rouge">async</code> function, and then add this after the map creation:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">await</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">map</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">load</span><span class="dl">'</span><span class="p">,</span> <span class="nx">resolve</span><span class="p">));</span>
</code></pre></div></div><p>After that we can add the source:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">map</span><span class="p">.</span><span class="nx">addSource</span><span class="p">(</span><span class="dl">'</span><span class="s1">boston_route</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">geojson</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="dl">'</span><span class="s1">https://bostonopendata-boston.opendata.arcgis.com/datasets/boston::existing-bike-network-2022.geojson?outSR=%7B%22latestWkid%22%3A3857%2C%22wkid%22%3A102100%7D</span><span class="dl">'</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div></div><p class="fyi">What is <code class="language-plaintext highlighter-rouge">boston_route</code>? It’s just a name we made up to refer to this data source. You can name it anything you want, but it should be unique to this source.</p><p>This won’t produce much of a visible result. To actually <em>see</em> something, we need to actually <em>use</em> the data to draw something.</p><h3 id="step-22-drawing-bike-lanes-on-the-map"> <a href="#step-22-drawing-bike-lanes-on-the-map" class="anchor-heading" aria-labelledby="step-22-drawing-bike-lanes-on-the-map"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2.2: Drawing bike lanes on the map</h3><p>One way to do that is to use the <a href="https://docs.mapbox.com/mapbox-gl-js/api/map/#map#addlayer"><code class="language-plaintext highlighter-rouge">map.addLayer()</code></a> method to add a <a href="https://docs.mapbox.com/style-spec/reference/layers/"><em>layer</em></a> to our map that visualizes the data source.</p><p>The this will look like this:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">({</span>
  <span class="nx">id</span><span class="p">,</span> <span class="c1">// A name for our layer (up to you)</span>
  <span class="nx">type</span><span class="p">,</span> <span class="c1">// one of the supported layer types, e.g. line, circle, etc.</span>
  <span class="na">source</span><span class="p">:</span> <span class="dl">'</span><span class="s1">boston_route</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// The id we specified in `addSource()`</span>
  <span class="na">paint</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">// paint params, e.g. colors, thickness, etc.</span>
  <span class="p">},</span>
<span class="p">});</span>
</code></pre></div></div><p>You should experiment with the different types of layers and paint properties to see what you can come up with, but chances are you’ll settle on <code class="language-plaintext highlighter-rouge">"line"</code>, to draw a network of bike routes as lines.</p><p>Without any painting properties (i.e. an empty <code class="language-plaintext highlighter-rouge">paint</code> object), your map will look like this: <img src="/labs/lab08/images/routes-unstyled.png" alt="" />.</p><h3 id="step-23-styling-the-bike-lanes"> <a href="#step-23-styling-the-bike-lanes" class="anchor-heading" aria-labelledby="step-23-styling-the-bike-lanes"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2.3: Styling the bike lanes</h3><p>You should look at the <a href="https://docs.mapbox.com/style-spec/reference/layers/#layer-sub-properties">reference</a> to see what you can do with the <code class="language-plaintext highlighter-rouge">paint</code> property, but chances are you will need at least the following:</p><ul><li><code class="language-plaintext highlighter-rouge">line-color</code> to set the color of the lines (see caveat below)<li><code class="language-plaintext highlighter-rouge">line-width</code> to make the lines thicker (default is <code class="language-plaintext highlighter-rouge">1</code>)<li><code class="language-plaintext highlighter-rouge">line-opacity</code> to make the lines translucent (0 is fully transparent, 1 is fully opaque). This is recommended so that the lines blend in to the rest of the map smoothly instead of obscuring it.</ul><p class="caveat">Mapbox does not yet understand newer color formats like <code class="language-plaintext highlighter-rouge">oklch()</code>. You can see the <a href="https://docs.mapbox.com/style-spec/reference/types/#color">docs</a> on what it accepts, but at the time of writing it’s basically named colors (e.g. <code class="language-plaintext highlighter-rouge">green</code>), hex codes (e.g. <code class="language-plaintext highlighter-rouge">#32D400</code>), <code class="language-plaintext highlighter-rouge">hsl()</code> and <code class="language-plaintext highlighter-rouge">rgb()</code>. You can convert any valid CSS color to the closest <code class="language-plaintext highlighter-rouge">rgb()</code> or <code class="language-plaintext highlighter-rouge">hsl()</code> equivalent using <a href="https://colorjs.io/apps/convert">this tool</a>. If it shows two versions, you want the one marked “gamut mapped”.</p><p class="caveat">Since these are properties in a JS object, and they contain hyphens, we need to wrap them in quotes, e.g. <code class="language-plaintext highlighter-rouge">"line-color": "green"</code>, not <code class="language-plaintext highlighter-rouge">line-color: "green"</code>.</p><p>The exact styling is up to you. I went with a translucent <code class="language-plaintext highlighter-rouge">green</code> (40% opacity), and a line width of <code class="language-plaintext highlighter-rouge">3</code>, which looked like this:</p><p><img src="images/bike-lanes-green.png" class="browser" alt="" /></p><h3 id="step-24-adding-cambridge-bike-lanes"> <a href="#step-24-adding-cambridge-bike-lanes" class="anchor-heading" aria-labelledby="step-24-adding-cambridge-bike-lanes"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2.4: Adding Cambridge bike lanes</h3><p>Notice that our map right now only shows bike lanes from Boston. What about the numerous Cambridge ones?!</p><p>Fortunately, the City of Cambridge also provides <a href="https://raw.githubusercontent.com/cambridgegis/cambridgegis_data/main/Recreation/Bike_Facilities/RECREATION_BikeFacilities.geojson">bike lane data as a GeoJSON file</a>.</p><p>Follow a similar process as steps 2.0 - 2.3 to visualize Cambridge bike lanes as well. It should look like this:</p><p><img src="images/cambridge-routes.png" class="browser" alt="" /></p><p class="further">At this point, you have likely ended up specifying your line styles twice: one in the Boston layer, and one in the Cambridge layer. This means that if we want to tweak them, we need to do it as many times as our layers. A good idea at this point (but entirely optional) is to specify the styling as a separate object that you reference in both places.</p><h2 id="step-3-adding-bike-stations"> <a href="#step-3-adding-bike-stations" class="anchor-heading" aria-labelledby="step-3-adding-bike-stations"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 3: Adding bike stations</h2><p>As you probably know, <a href="https://bluebikes.com/">Bluebikes</a> is a bicycle sharing program in the Boston area. They make many <a href="https://bluebikes.com/system-data">datasets</a> publicly available, including real-time and historical data. The first Bluebikes dataset we will use in this lab is station information, which is a JSON file with names, IDs and coordinates (among other info) for each station.</p><p>We have made a copy of this data in <a href="data/bluebikes-stations.csv" download=""><code class="language-plaintext highlighter-rouge">https://vis-society.github.io/labs/8/data/bluebikes-stations.csv</code></a>. This is a CSV file where every row has the following properties:</p><ul><li><code class="language-plaintext highlighter-rouge">Number</code>: a code like “L32001”<li><code class="language-plaintext highlighter-rouge">NAME</code>: the station’s name, like “Railroad Lot and Minuteman Bikeway”<li><code class="language-plaintext highlighter-rouge">Lat</code>: the station’s latitude, e.g. 42.41606457<li><code class="language-plaintext highlighter-rouge">Long</code>: the station’s longitude, e.g. -71.15336637<li><code class="language-plaintext highlighter-rouge">Seasonal Status</code>: whether the station is seasonal or not with statuses like “Year Round”, “Winter storage” etc.<li><code class="language-plaintext highlighter-rouge">Municipality</code>: e.g. “Cambridge”, “Arligton”, etc.<li><code class="language-plaintext highlighter-rouge">Total Docks</code>: the number of docks at the station as a number, e.g. 11</ul><p>We will be using the latitude and longitude data to add markers to our map for each station.</p><p>While we <em>could</em> use Mapbox’s <code class="language-plaintext highlighter-rouge">addSource()</code> and <a href="https://docs.mapbox.com/mapbox-gl-js/api/map/#map#addlayer"><code class="language-plaintext highlighter-rouge">addLayer()</code></a> functions to plot the stations as another layer on the map canvas (like we just did with bike lanes), we will try a different approach here so we can learn how to combine the two visualization methods we have already learned: Mapbox and D3. We will be adding an SVG layer on top of our map to hold the station markers, and use D3 to fetch and parse the data, and to draw the markers.</p><h3 id="step-31-fetching-and-parsing-the-csv"> <a href="#step-31-fetching-and-parsing-the-csv" class="anchor-heading" aria-labelledby="step-31-fetching-and-parsing-the-csv"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 3.1: Fetching and parsing the CSV</h3><p>Install <code class="language-plaintext highlighter-rouge">d3</code> as we have done before:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install </span>d3
</code></pre></div></div><p>Then, in your <code class="language-plaintext highlighter-rouge">src/routes/+page.svelte</code> file, import <code class="language-plaintext highlighter-rouge">d3</code> and fetch the CSV file using <code class="language-plaintext highlighter-rouge">d3.csv()</code>, as we did in <a href="../7/#step-11-reading-the-csv-file-in-d3">the previous lab</a>. You don’t need to download this file and include in your project, you can just fetch it directly from that URL. Let’s call the variable that will hold the station data <code class="language-plaintext highlighter-rouge">stations</code>.</p><p>Make sure that the data is being fetched correctly by logging it to the console. That way you can also explore its structure.</p><h3 id="step-32-overlaying-svg-on-the-map"> <a href="#step-32-overlaying-svg-on-the-map" class="anchor-heading" aria-labelledby="step-32-overlaying-svg-on-the-map"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 3.2: Overlaying SVG on the map</h3><p>We will start by appending an <code class="language-plaintext highlighter-rouge">&lt;svg&gt;</code> element on our map container:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"map"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;svg&gt;&lt;/svg&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div><p>If you preview your app right now, you won’t see anything different. However, if you right click on the map, you should be able to see the <code class="language-plaintext highlighter-rouge">&lt;svg&gt;</code> element we just inserted in the dev tools:</p><p><img src="images/svg.png" alt="" /></p><p>However, it doesn’t have the right size: it’s just a small rectangle in the top left corner. Worse yet, it’s actually rendered <em>under</em> the map, which becomes obvious if we give it a background color:</p><div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">#map</span> <span class="nt">svg</span> <span class="p">{</span>
  <span class="nl">background</span><span class="p">:</span> <span class="no">yellow</span><span class="p">;</span>
  <span class="nl">opacity</span><span class="p">:</span> <span class="m">50%</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>Let’s fix all of that, by applying the following declarations:</p><ul><li><code class="language-plaintext highlighter-rouge">position: absolute</code> and <code class="language-plaintext highlighter-rouge">z-index: 1</code> so we can position it on top of the map (<code class="language-plaintext highlighter-rouge">z-index</code> does not work without positioning)<li><code class="language-plaintext highlighter-rouge">width: 100%</code> and <code class="language-plaintext highlighter-rouge">height: 100%</code> to make it fill the map container<li><code class="language-plaintext highlighter-rouge">pointer-events: none</code> so that we can still pan and move the map</ul><p>Make sure you’re now seeing something like this:</p><p><img src="/labs/lab08/images/svg-yellow.png" alt="" /></p><p>And then remove the <code class="language-plaintext highlighter-rouge">background</code> and <code class="language-plaintext highlighter-rouge">opacity</code> declarations — they were only there as debugging aids, we don’t need them for the actual visualization.</p><h3 id="step-33-adding-station-markers"> <a href="#step-33-adding-station-markers" class="anchor-heading" aria-labelledby="step-33-adding-station-markers"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 3.3: Adding station markers</h3><p>This step is similar to making the scatterplot in the previous lab: we just need to append a bunch of circles to the SVG element, each representing a station.</p><p>The only tricky part here is positioning them so that they line up with the map. Fortunately, Mapbox has a great built-in function <a href="https://docs.mapbox.com/android/maps/api/10.0.0-beta.12/-mapbox%20-maps%20-android/com.mapbox.maps/-mapbox-map/project.html"><code class="language-plaintext highlighter-rouge">map.project()</code></a>, which takes longitude and latitude values and returns the relative map coordinates in pixels.</p><p class="fyi">Why not just use D3 scales for this? <code class="language-plaintext highlighter-rouge">map.project()</code> takes into account many things: panning, zooming, even rotation. It’s certainly <em>possible</em> to calculate this manually, but it’s nontrivial.</p><p>First, we need to move some of our variables outside the <code class="language-plaintext highlighter-rouge">onMount()</code> callback so that they are visible to the HTML template too. So instead of doing this:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">onMount</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="kd">let</span> <span class="nx">foo</span> <span class="o">=</span> <span class="cm">/* calculate foo */</span>
<span class="p">});</span>
</code></pre></div></div><p>We now want to do this:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">foo</span><span class="p">;</span>

<span class="nx">onMount</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="nx">foo</span> <span class="o">=</span> <span class="cm">/* calculate foo */</span>
<span class="p">});</span>
</code></pre></div></div><p>We need to do this for both <code class="language-plaintext highlighter-rouge">stations</code> (so we can loop over them in the HTML template), and <code class="language-plaintext highlighter-rouge">map</code> (so we can use <code class="language-plaintext highlighter-rouge">map.project()</code> to calculate coordinates). Initialize <code class="language-plaintext highlighter-rouge">stations</code> to <code class="language-plaintext highlighter-rouge">[]</code> so that you don’t get an error before the data is fetched.</p><p>Now let’s define a helper function to give the circle center from latitude and longitude for every station:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">getCoords</span><span class="p">(</span><span class="nx">station</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">point</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">mapboxgl</span><span class="p">.</span><span class="nx">LngLat</span><span class="p">(</span><span class="o">+</span><span class="nx">station</span><span class="p">.</span><span class="nx">Long</span><span class="p">,</span> <span class="o">+</span><span class="nx">station</span><span class="p">.</span><span class="nx">Lat</span><span class="p">);</span>
  <span class="kd">let</span> <span class="p">{</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">map</span><span class="p">.</span><span class="nx">project</span><span class="p">(</span><span class="nx">point</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">{</span> <span class="na">cx</span><span class="p">:</span> <span class="nx">x</span><span class="p">,</span> <span class="na">cy</span><span class="p">:</span> <span class="nx">y</span> <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div><p>In our template, we add an <a href="https://svelte.dev/docs/logic-blocks#each"><code class="language-plaintext highlighter-rouge">{#each}</code></a> block to loop over the stations and append an SVG <code class="language-plaintext highlighter-rouge">&lt;circle&gt;</code> for each one, very much like we did in the previous lab. You can use any radius (<code class="language-plaintext highlighter-rouge">r</code> attribute) and fill/stroke color(s) you like (I used a radius of <code class="language-plaintext highlighter-rouge">5</code> and a fill of <code class="language-plaintext highlighter-rouge">steelblue</code>).</p><p>While we <em>could</em> do something like this for the circle center:</p><div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nt">circle</span>
  <span class="na">cx</span><span class="p">=</span><span class="si">{</span><span class="nx">getCoords</span><span class="p">(</span><span class="nx">station</span><span class="p">).</span><span class="nx">cx</span><span class="si">}</span>
  <span class="na">cy</span><span class="p">=</span><span class="si">{</span><span class="nx">getCoords</span><span class="p">(</span><span class="nx">station</span><span class="p">).</span><span class="nx">cy</span><span class="si">}</span>
  <span class="na">r</span><span class="p">=</span><span class="s">'5'</span>
  <span class="na">fill</span><span class="p">=</span><span class="s">'steelblue'</span>
<span class="p">/&gt;</span>
</code></pre></div></div><p>A better way is to take advantage of a special syntax called <a href="https://svelte.dev/docs/basic-markup#attributes-and-props:~:text=Spread%20attributes">spread attributes</a>, which allows us to set multiple attributes at once:</p><div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nt">circle</span> <span class="si">{</span><span class="p">...</span><span class="nx">getCoords</span><span class="p">(</span><span class="nx">station</span><span class="p">)</span><span class="si">}</span> <span class="na">r</span><span class="p">=</span><span class="s">'5'</span> <span class="na">fill</span><span class="p">=</span><span class="s">'steelblue'</span> <span class="p">/&gt;</span>
</code></pre></div></div><p>If everything went well, you should see something like this:</p><p><img src="/labs/lab08/images/stations-static.png" alt="" /></p><h3 id="step-34-adjusting-station-markers-when-map-is-zoomedpanned"> <a href="#step-34-adjusting-station-markers-when-map-is-zoomedpanned" class="anchor-heading" aria-labelledby="step-34-adjusting-station-markers-when-map-is-zoomedpanned"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 3.4: Adjusting station markers when map is zoomed/panned</h3><p>Our map looks great when everything is stationary, but it all breaks down if we try to pan, zoom, rorate, or even resize the window: The stations are “stuck” in the same position like splatters on a window!</p><video src="videos/splatters.mp4" loop="" muted="" autoplay=""></video><p>To fix this, we need to reposition the stations every time the map moves.</p><blockquote class="fyi"><p>Normally, Svelte’s reactivity takes care of updating state whenever needed without us having to worry about it (beyond making statements reactive). However, because our code depends on <em>side effects</em>, Svelte’s reactivity does not work as expected. What are side effects in this context? When you look at <code class="language-plaintext highlighter-rouge">getCoords(station)</code> it looks like the result depends on <code class="language-plaintext highlighter-rouge">station</code> — and it does. But that’s not the full story. It also depends on things that are not visible by simply looking at the code, such as the current state of the map (zooming, panning, etc.). These are side effects. When the dependencies are not visible in the code, we need to take care of updating the state ourselves.</p></blockquote><p>Mapbox fires many <a href="https://docs.mapbox.com/mapbox-gl-js/api/map/#map-events">events</a> on <code class="language-plaintext highlighter-rouge">map</code> as we interact with it. Most useful in this case is the <a href="https://docs.mapbox.com/mapbox-gl-js/api/map/#map.event:move"><code class="language-plaintext highlighter-rouge">move</code></a> event, which is fired whenever the map is moved (panned, zoomed, rotated, etc.). But how do we force Svelte’s to re-run <code class="language-plaintext highlighter-rouge">getCoords()</code> when the <code class="language-plaintext highlighter-rouge">move</code> event fires?</p><p>Svelte provides a <a href="https://svelte.dev/docs/logic-blocks#key"><code class="language-plaintext highlighter-rouge">{#key}</code></a> block that can be used to force a re-render when a variable changes. We can easily do that by defining a variable that we increment every time the <code class="language-plaintext highlighter-rouge">move</code> event is fired. Let’s define our variable in the JS:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">mapViewChanged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></div></div><p>Then we use a <code class="language-plaintext highlighter-rouge">move</code> event listener (using Mapbox’s own <code class="language-plaintext highlighter-rouge">.on()</code> function for events):</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">:</span> <span class="nx">map</span><span class="p">?.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">move</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">mapViewChanged</span><span class="o">++</span><span class="p">);</span>
</code></pre></div></div><p>and then we wrap the code drawing the stations with:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{#key mapViewChanged}
<span class="c">&lt;!-- render stations here --&gt;</span>
{/key}
</code></pre></div></div><p>If everything went well, you should now see the stations move around as you pan and zoom the map:</p><video src="videos/panning.mp4" loop="" muted="" autoplay=""></video><p class="note">Some of you may have wondered why we needed to use <code class="language-plaintext highlighter-rouge">{#key}</code> at all. We <em>could</em> have gotten the exact same result by adding <code class="language-plaintext highlighter-rouge">mapViewChanged</code> as a dummy parameter in <code class="language-plaintext highlighter-rouge">getCoords()</code>, i.e. pass it as an argument to the function even though the function does not use it in any way. We just use <code class="language-plaintext highlighter-rouge">{#key}</code> because it makes our intent more clear, while the dummy parameter approach is more of a <a href="https://www.reddit.com/r/learnprogramming/comments/3cd0x4/what_constitutes_a_hack_or_hacky_code/">hack</a> and could make it look like our code has a bug, rather than this being intentional. It also means it could break in the future if Svelte becomes smarter about detecting dependencies.</p><p class="further">We are currently drawing all the stations in the Bluebikes network, even though we can only actually see a few. You can explore tweaking the code to only draw stations that are currently visible on the map which should make it much faster.</p><h2 id="step-4-visualizing-bike-traffic"> <a href="#step-4-visualizing-bike-traffic" class="anchor-heading" aria-labelledby="step-4-visualizing-bike-traffic"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 4: Visualizing bike traffic</h2><p>Marking the station position is nice, but doesn’t tell a very interesting story. What patterns could we uncover if we set the size of the circles according to the amount of traffic at each station?</p><p>A copy of the Bluebikes traffic data from March 2024 is at <a href="data/bluebikes-traffic-2024-03.csv" download=""><code class="language-plaintext highlighter-rouge">https://vis-society.github.io/labs/8/data/bluebikes-traffic-2024-03.csv</code></a>. This is quite a large file (21 MB) containing more than 260,000 entries with the following fields:</p><ul><li><code class="language-plaintext highlighter-rouge">ride_id</code>: A unique id of the ride<li><code class="language-plaintext highlighter-rouge">bike_type</code>: <code class="language-plaintext highlighter-rouge">electric</code> or <code class="language-plaintext highlighter-rouge">classic</code><li><code class="language-plaintext highlighter-rouge">started_at</code>: the date and time the trip started in ISO 8601 format (e.g. <code class="language-plaintext highlighter-rouge">"2019-12-13 13:28:04.2860"</code>)<li><code class="language-plaintext highlighter-rouge">ended_at</code>: the date and time the trip ended in ISO 8601 format (e.g. <code class="language-plaintext highlighter-rouge">"2019-12-13 13:33:57.4370"</code>)<li><code class="language-plaintext highlighter-rouge">start_station_id</code>: the ID of the station where the trip started (e.g. <code class="language-plaintext highlighter-rouge">A32000</code>)<li><code class="language-plaintext highlighter-rouge">end_station_id</code>: the ID of the station where the trip ended (e.g. <code class="language-plaintext highlighter-rouge">A32000</code>)<li><code class="language-plaintext highlighter-rouge">is_member</code>: whether the rider is a member or not (<code class="language-plaintext highlighter-rouge">1</code> or <code class="language-plaintext highlighter-rouge">0</code>)</ul><p>This is a cut down / simplified version of the dataset that Bluebikes provides to reduce filesize.</p><h3 id="step-41-importing-and-parsing-the-traffic-data"> <a href="#step-41-importing-and-parsing-the-traffic-data" class="anchor-heading" aria-labelledby="step-41-importing-and-parsing-the-traffic-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 4.1: Importing and parsing the traffic data</h3><p>Just like the previous step, we will use <code class="language-plaintext highlighter-rouge">d3.csv()</code> to fetch the traffic data. You can fetch it directly from the URL, without hosting it yourself. Let’s call the variable that will hold the traffic data <code class="language-plaintext highlighter-rouge">trips</code>.</p><h3 id="step-42-calculating-traffic-at-each-station"> <a href="#step-42-calculating-traffic-at-each-station" class="anchor-heading" aria-labelledby="step-42-calculating-traffic-at-each-station"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 4.2: Calculating traffic at each station</h3><p>Now that we have read the data into a JS object, we can use it to calculate station traffic volumes (arrivals, departures, and total traffic per station).</p><p>As we have in the previous labs, we will use <a href="https://d3js.org/d3-array/group#rollup"><code class="language-plaintext highlighter-rouge">d3.rollup()</code></a> (or <code class="language-plaintext highlighter-rouge">d3.rollups()</code>) to calculate arrivals and departures.</p><p>First, we calculate them separately, like this:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">departures</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">rollup</span><span class="p">(</span>
  <span class="nx">trips</span><span class="p">,</span>
  <span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">v</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
  <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">start_station_id</span><span class="p">,</span>
<span class="p">);</span>
</code></pre></div></div><p class="note">We are calculating <code class="language-plaintext highlighter-rouge">departures</code> and <code class="language-plaintext highlighter-rouge">arrivals</code> inside <code class="language-plaintext highlighter-rouge">onMount</code> since we only need to calculate them once. However, you should make sure to declare the <code class="language-plaintext highlighter-rouge">arrivals</code> and <code class="language-plaintext highlighter-rouge">departures</code> variables <em>outside</em> <code class="language-plaintext highlighter-rouge">onMount()</code> so you can access them in your reactive code later!</p><p>Now, we want to add <code class="language-plaintext highlighter-rouge">arrivals</code>, <code class="language-plaintext highlighter-rouge">departures</code>, <code class="language-plaintext highlighter-rouge">totalTraffic</code> properties to each station, which we can do like this after both <code class="language-plaintext highlighter-rouge">stations</code> and <code class="language-plaintext highlighter-rouge">trips</code> have loaded:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">stations</span> <span class="o">=</span> <span class="nx">stations</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">station</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">station</span><span class="p">.</span><span class="nb">Number</span><span class="p">;</span>
  <span class="nx">station</span><span class="p">.</span><span class="nx">arrivals</span> <span class="o">=</span> <span class="nx">arrivals</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">??</span> <span class="mi">0</span><span class="p">;</span>
  <span class="c1">// TODO departures</span>
  <span class="c1">// TODO totalTraffic</span>
  <span class="k">return</span> <span class="nx">station</span><span class="p">;</span>
<span class="p">});</span>
</code></pre></div></div><p class="tip">You can log <code class="language-plaintext highlighter-rouge">stations</code> in the console after to make sure the properties have been added correctly.</p><h3 id="step-43-size-markers-according-to-traffic"> <a href="#step-43-size-markers-according-to-traffic" class="anchor-heading" aria-labelledby="step-43-size-markers-according-to-traffic"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 4.3: Size markers according to traffic</h3><p>Now, we can use this data structure to size the markers on the map according to the traffic at each station. Currently, all our circle radii are hardcoded. We should decide what the minimum and maximum radius should be (I went with <code class="language-plaintext highlighter-rouge">0</code> and <code class="language-plaintext highlighter-rouge">25</code>), and then create a D3 scale to map our data domain <code class="language-plaintext highlighter-rouge">[0, d3.max(stations, d =&gt; d.totalTraffic)]</code> to this range of circle radii.</p><p>However, there is a catch: if we just use a linear scale to calculate the circle’s radius, we will end up misrepresenting the data: for example, stations that have double the traffic would appear 4 times larger since the area of a circle is proportional to the square of its radius (A = πr²). We want to use the circle <em>area</em> to visualize the variable, not the circle <em>radius</em>.</p><p>To fix this, we will use a different type of scale: a <a href="https://d3js.org/d3-scale/pow#scaleSqrt">square root scale</a>. A square root scale is a type of power scale that uses the square root of the input domain value to calculate the output range value.</p><p class="note">If you did the optional <a href="../7/#step-4-communicating-lines-edited-via-the-size-of-the-dots-optional">step 4 in the previous lab</a> you will be familiar with this already.</p><p>Thankfully, the API is very similar to the linear scale we used before, the only thing that changes is that we use a different function name:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">:</span> <span class="nx">radiusScale</span> <span class="o">=</span> <span class="nx">d3</span>
  <span class="p">.</span><span class="nx">scaleSqrt</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">stations</span><span class="p">,</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">totalTraffic</span><span class="p">)])</span>
  <span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">]);</span>
</code></pre></div></div><p>Then, we can use this scale to calculate the radius of each circle in the SVG by passing the station traffic as a parameter to <code class="language-plaintext highlighter-rouge">radiusScale()</code>.</p><p>If we look at our map right now, it looks like this:</p><p><img src="/labs/lab08/images/station-traffic-1.png" alt="" /></p><p>Because our dots are opaque and overlapping, it’s hard to see the actual traffic patterns. Add a CSS rule for <code class="language-plaintext highlighter-rouge">circle</code> inside your <code class="language-plaintext highlighter-rouge">svg</code> rule, and experiment with different <code class="language-plaintext highlighter-rouge">fill-opacity</code> values and strokes to improve this. I used a <code class="language-plaintext highlighter-rouge">steelblue</code> fill, a <code class="language-plaintext highlighter-rouge">fill-opacity</code> of 60%, and a <code class="language-plaintext highlighter-rouge">stroke</code> of <code class="language-plaintext highlighter-rouge">white</code>, and this was the result: <img src="/labs/lab08/images/stations-stroke.png" alt="alt text" /></p><h3 id="step-44-adding-a-tooltip-with-exact-traffic-numbers-optional"> <a href="#step-44-adding-a-tooltip-with-exact-traffic-numbers-optional" class="anchor-heading" aria-labelledby="step-44-adding-a-tooltip-with-exact-traffic-numbers-optional"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 4.4: Adding a tooltip with exact traffic numbers <em>(optional)</em></h3><p>In addition to providing additional info, it helps us debug as well to be able to see the number of trips that each circle represents. We <em>could</em> add a tooltip in the same way we did in <a href="../7/#step-3-adding-a-tooltip">the previous lab</a> but that’s fairly involved. Here we will do the quick and dirty way and use the default browser tooltips. To create those, all it takes is adding a <code class="language-plaintext highlighter-rouge">&lt;title&gt;</code> element inside each <code class="language-plaintext highlighter-rouge">&lt;circle&gt;</code> element with the number of trips:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;circle&gt;</span>
  <span class="c">&lt;!-- (omitting attributes for brevity) --&gt;</span>
  <span class="nt">&lt;title&gt;</span>
    {station.totalTraffic} trips ({station.departures} departures, {
    station.arrivals} arrivals)
  <span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/circle&gt;</span>
</code></pre></div></div><p>We have applied <code class="language-plaintext highlighter-rouge">pointer-events: none</code> to the whole <code class="language-plaintext highlighter-rouge">&lt;svg&gt;</code>, so to be able to see our tooltips we need to override that on circles, by adding <code class="language-plaintext highlighter-rouge">pointer-events: auto</code> to our CSS rule for <code class="language-plaintext highlighter-rouge">circle</code>.</p><p><img src="/labs/lab08/images/title-tooltip.png" alt="" /></p><p class="further">If you want to go even further, you could explore adding a nicer tooltip, with more advanced information.</p><p class="caveat">Note that <em>both</em> SVG and HTML have a <code class="language-plaintext highlighter-rouge">&lt;title&gt;</code> element, but they are false friends, as they do different things!</p><h2 id="step-5-interactive-data-filtering"> <a href="#step-5-interactive-data-filtering" class="anchor-heading" aria-labelledby="step-5-interactive-data-filtering"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 5: Interactive data filtering</h2><p>Even with the styling improvements, it’s hard to make sense of all this data as currently displayed all at once. Let’s add some interactive filtering with a slider for arrival/departure time.</p><h3 id="step-51-adding-the-html-and-css-for-the-slider"> <a href="#step-51-adding-the-html-and-css-for-the-slider" class="anchor-heading" aria-labelledby="step-51-adding-the-html-and-css-for-the-slider"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 5.1: Adding the HTML and CSS for the slider</h3><p>The first step is to add the HTML for our time filter, which includes the following elements:</p><ul><li>A slider (<code class="language-plaintext highlighter-rouge">&lt;input type=range&gt;</code>) with a min of -1 (no filtering) and a max of 1440 (the number of minutes in the day).<li>A <code class="language-plaintext highlighter-rouge">&lt;time&gt;</code> element to display the selected time.<li>An <code class="language-plaintext highlighter-rouge">&lt;em&gt;(any time)&lt;/em&gt;</code> element that will be shown when the slider is at -1.<li>A <code class="language-plaintext highlighter-rouge">&lt;label&gt;</code> <em>around</em> the slider and <code class="language-plaintext highlighter-rouge">&lt;time&gt;</code> element with some explanatory text (e.g. “Filter by time:”).</ul><p>Where you put it on the page is up to you. I added it under the <code class="language-plaintext highlighter-rouge">&lt;h1&gt;</code> and wrapped both with a <code class="language-plaintext highlighter-rouge">&lt;header&gt;</code>, to which I applied a <code class="language-plaintext highlighter-rouge">display: flex</code>, <code class="language-plaintext highlighter-rouge">gap: 1em</code>, and <code class="language-plaintext highlighter-rouge">align-items: baseline</code> to align them horizontally, then gave the label a <code class="language-plaintext highlighter-rouge">margin-left: auto</code> to push it all the way to the right.</p><p>Make sure to place the <code class="language-plaintext highlighter-rouge">&lt;time&gt;</code> and <code class="language-plaintext highlighter-rouge">&lt;em&gt;</code> on their own line (e.g. via <code class="language-plaintext highlighter-rouge">display: block</code>) otherwise the contents of the <code class="language-plaintext highlighter-rouge">&lt;time&gt;</code> updating will move the slider and it will look very jarring.</p><p>You would also want to style the <code class="language-plaintext highlighter-rouge">&lt;em&gt;</code> differently, e.g. with a lighter color and/or italic, to make it clear that it’s a different state.</p><p>Here is a sample rendering of what you should have at this point:</p><p><img src="images/slider-static.png" alt="" class="browser" /></p><h3 id="step-52-reactivity"> <a href="#step-52-reactivity" class="anchor-heading" aria-labelledby="step-52-reactivity"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 5.2: Reactivity</h3><p>Now that we’ve added our static HTML and CSS, let’s connect it with our code by having the slider update a variable that we can use to filter the data and outputting the currently selected time in the <code class="language-plaintext highlighter-rouge">&lt;time&gt;</code> element.</p><p>First, let’s create a variable to hold the slider value, called <code class="language-plaintext highlighter-rouge">timeFilter</code>, that we initialize to <code class="language-plaintext highlighter-rouge">-1</code> so that no filtering is done by default.</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">timeFilter</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</code></pre></div></div><p>Then we can use <a href="https://svelte.dev/docs/element-directives#bind-property"><code class="language-plaintext highlighter-rouge">bind:value</code></a> on the slider to reactively update <code class="language-plaintext highlighter-rouge">timeFilter</code> as the slider is moved.</p><p>Lastly, we need to display the selected time in the <code class="language-plaintext highlighter-rouge">&lt;time&gt;</code> element, which also serves as validation that we’ve done the plumbing correctly.</p><p>For that, let’s define a reactive variable that converts the number of minutes since midnight to a human-readable time string (using <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/toLocaleString"><code class="language-plaintext highlighter-rouge">date.toLocaleString()</code></a>):</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">:</span> <span class="nx">timeFilterLabel</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">timeFilter</span><span class="p">).</span><span class="nx">toLocaleString</span><span class="p">(</span><span class="dl">'</span><span class="s1">en</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">timeStyle</span><span class="p">:</span> <span class="dl">'</span><span class="s1">short</span><span class="dl">'</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div></div><p>Then, all we need to do is print out <code class="language-plaintext highlighter-rouge">timeFilterLabel</code> via a reactive expression (<code class="language-plaintext highlighter-rouge">{}</code>) in the <code class="language-plaintext highlighter-rouge">&lt;time&gt;</code> element.</p><p>It looks like this now:</p><p><img src="/labs/lab08/images/slider.gif" alt="" /></p><p>Lastly, we want to display the <code class="language-plaintext highlighter-rouge">&lt;em&gt;</code> element only when the slider is at <code class="language-plaintext highlighter-rouge">-1</code> and the <code class="language-plaintext highlighter-rouge">&lt;time&gt;</code> only when it is not, using a <a href="https://svelte.dev/docs/logic-blocks#if">Svelte <code class="language-plaintext highlighter-rouge">{#if}</code> block</a>.</p><h3 id="step-53-filtering-the-data"> <a href="#step-53-filtering-the-data" class="anchor-heading" aria-labelledby="step-53-filtering-the-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 5.3: Filtering the data</h3><p>Our slider now <em>looks</em> like a filter, but doesn’t actually <em>do</em> anything. To make it work there are a few more things we need to do:</p><ol><li>Writing out the logic to filter the data, by creating <code class="language-plaintext highlighter-rouge">filteredXXX</code> versions of each of our root variables:<ol><li>A <code class="language-plaintext highlighter-rouge">filteredTrips</code> data structure that contains the trips that correspond to the filter.<li><code class="language-plaintext highlighter-rouge">filteredArrivals</code> and <code class="language-plaintext highlighter-rouge">filteredDepartures</code> data structures that contain the <code class="language-plaintext highlighter-rouge">arrivals</code> and <code class="language-plaintext highlighter-rouge">departures</code> data after filtering.<li>A <code class="language-plaintext highlighter-rouge">filteredStations</code> data structure with stations that contain data that corresponds to the filter (i.e. filtered arrivals, departures, and total traffic).</ol><li>Updating our HTML template to use these new data structures instead of the original ones.</ol><p>The trip data includes dates and times as strings, which are not directly comparable to the number of minutes since midnight that we have from the slider. To compare the two, we need to convert the date and time strings to a number of minutes since midnight.</p><p>We will do this in two steps. First, we will replace the start and end date strings of each trip with <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date"><code class="language-plaintext highlighter-rouge">Date</code></a> objects.</p><p>We only need to do this once, so we can do this in <code class="language-plaintext highlighter-rouge">onMount()</code>, right after <code class="language-plaintext highlighter-rouge">trips</code> has been fetched. Since <code class="language-plaintext highlighter-rouge">trips</code> is such a large dataset, we want to avoid setting it twice, so we will instead use the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/then"><code class="language-plaintext highlighter-rouge">then()</code></a> method of the <code class="language-plaintext highlighter-rouge">Promise</code> returned by <code class="language-plaintext highlighter-rouge">d3.csv()</code> to do this:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">trips</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">csv</span><span class="p">(</span><span class="nx">TRIP_DATA_URL</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">trips</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">trip</span> <span class="k">of</span> <span class="nx">trips</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">trip</span><span class="p">.</span><span class="nx">started_at</span> <span class="o">=</span> <span class="cm">/* ...
		... */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">trips</span><span class="p">;</span>
<span class="p">});</span>
</code></pre></div></div><p>To convert each time and date string, we just do <code class="language-plaintext highlighter-rouge">new Date(dateTimeString)</code> (assuming <code class="language-plaintext highlighter-rouge">dateTimeString</code> is the date &amp; time string we are trying to convert).</p><p>Now, we can define a function that takes a <code class="language-plaintext highlighter-rouge">Date</code> object and returns the number of minutes since midnight:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">minutesSinceMidnight</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getHours</span><span class="p">()</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div><p>Then, we can use this function to filter the data to trips that started or ended within 1 hour before or after the selected time:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">:</span> <span class="nx">filteredTrips</span> <span class="o">=</span>
  <span class="nx">timeFilter</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span>
    <span class="p">?</span> <span class="nx">trips</span>
    <span class="p">:</span> <span class="nx">trips</span><span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">trip</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">startedMinutes</span> <span class="o">=</span> <span class="nx">minutesSinceMidnight</span><span class="p">(</span><span class="nx">trip</span><span class="p">.</span><span class="nx">started_at</span><span class="p">);</span>
        <span class="kd">let</span> <span class="nx">endedMinutes</span> <span class="o">=</span> <span class="nx">minutesSinceMidnight</span><span class="p">(</span><span class="nx">trip</span><span class="p">.</span><span class="nx">ended_at</span><span class="p">);</span>
        <span class="k">return</span> <span class="p">(</span>
          <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">startedMinutes</span> <span class="o">-</span> <span class="nx">timeFilter</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">60</span> <span class="o">||</span>
          <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">endedMinutes</span> <span class="o">-</span> <span class="nx">timeFilter</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">60</span>
        <span class="p">);</span>
      <span class="p">});</span>
</code></pre></div></div><p>Now, we need to create new data structures that correspond to <code class="language-plaintext highlighter-rouge">arrivals</code>, <code class="language-plaintext highlighter-rouge">departures</code>, and <code class="language-plaintext highlighter-rouge">stations</code> but <em>only</em> for the filtered trips. We can call them <code class="language-plaintext highlighter-rouge">filteredArrivals</code>, <code class="language-plaintext highlighter-rouge">filteredDepartures</code>, and <code class="language-plaintext highlighter-rouge">filteredStations</code>.</p><p>For <code class="language-plaintext highlighter-rouge">filteredArrivals</code> and <code class="language-plaintext highlighter-rouge">filteredDepartures</code>, all we need to do is copy the statements that set the original variables (<code class="language-plaintext highlighter-rouge">arrivals</code> and <code class="language-plaintext highlighter-rouge">departures</code>), convert them to reactive statements, and replace <code class="language-plaintext highlighter-rouge">trips</code> with <code class="language-plaintext highlighter-rouge">filteredTrips</code>.</p><p>For <code class="language-plaintext highlighter-rouge">filteredStations</code>, we don’t actually need to do any filtering of the <code class="language-plaintext highlighter-rouge">stations</code> array (since it’s unlikely that there are stations with zero arrivals and departures for a given time), but we do need an array that contains updated data for <code class="language-plaintext highlighter-rouge">station.arrivals</code>, <code class="language-plaintext highlighter-rouge">station.departures</code> and <code class="language-plaintext highlighter-rouge">station.totalTraffic</code> that correspond to the filtered trips.</p><blockquote class="caution"><p>This is where we need to be careful: if we simply do <code class="language-plaintext highlighter-rouge">$: filteredStations = stations.map(station =&gt; {...})</code> and set properties on <code class="language-plaintext highlighter-rouge">station</code>, we will have modified our original station objects since <a href="https://dev.to/bbarbour/passed-by-reference-vs-value-in-javascript-2fna">in JS, objects are passed around by reference</a>! To avoid this, before we set any property on these objects, we need to <em>clone</em> them. We can do that by doing this before we modify <code class="language-plaintext highlighter-rouge">station</code>:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">station</span> <span class="o">=</span> <span class="p">{</span> <span class="p">...</span><span class="nx">station</span> <span class="p">};</span>
</code></pre></div></div></blockquote><p>Last, we want to have bigger circles, since there’s fewer data. We can do that by changing the scale when a filter is applied, by making the scale conditional, i.e. instead of using a static <code class="language-plaintext highlighter-rouge">[0, 25]</code> as the range, we use <code class="language-plaintext highlighter-rouge">[0, 25]</code> when <code class="language-plaintext highlighter-rouge">timeFilter</code> is <code class="language-plaintext highlighter-rouge">-1</code> and e.g. <code class="language-plaintext highlighter-rouge">[3, 50]</code> otherwise. You will find the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Conditional_operator">conditional operator</a> useful for this.</p><p>The result right now should look like this:</p><video src="videos/filtering.mp4" class="browser" loop="" autoplay="" muted=""></video><h3 id="step-54-performance-optimizations-optional-if-you-dont-have-this-problem"> <a href="#step-54-performance-optimizations-optional-if-you-dont-have-this-problem" class="anchor-heading" aria-labelledby="step-54-performance-optimizations-optional-if-you-dont-have-this-problem"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 5.4: Performance optimizations <em>(optional if you don’t have this problem)</em></h3><p>Notice that moving the slider now does not feel as smooth as it did before we implemented the filtering. This is because every time we move the slider, we filter the trips, which is a relatively expensive operation given that we have over a quarter of a million of them! Worse, every time we do this filtering, <em>nothing else can happen</em> until the filtering ends, including things like the browser updating the slider position! This is commonly referred to as <em>“blocking the main thread”</em>.</p><p>There are many ways to improve this. <a href="https://css-tricks.com/debouncing-throttling-explained-examples/"><em>Throttling</em> and <em>debouncing</em></a> are two common techniques to limit the rate at which a certain (expensive) piece of code is called in response to user action.</p><p>These are “brute force” in the sense that they work regardless of what the expensive operation or the user action is, but they can adversely affect the user experience, since they make the UI update less frequently. However, depending on the case, there are often ways to optimize the operation itself (e.g. by caching repetitive work), without any negative impact on the user experience.</p><p>In this case, we can make the filtering a lot less expensive by presorting the trips into 1440 “buckets”, one for each minute of the day. Then, instead of going over 260 K trips every time the slider moves, we only need to go over the trips in the 120 buckets corresponding to the selected time.</p><p>We start by defining two top-level variables to hold the departure and arrival “buckets”, which will be arrays with 1440 elements initially filled with empty arrays:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">departuresByMinute</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">({</span> <span class="na">length</span><span class="p">:</span> <span class="mi">1440</span> <span class="p">},</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">[]);</span>
<span class="kd">let</span> <span class="nx">arrivalsByMinute</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">({</span> <span class="na">length</span><span class="p">:</span> <span class="mi">1440</span> <span class="p">},</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">[]);</span>
</code></pre></div></div><p>Then, in <code class="language-plaintext highlighter-rouge">onMount()</code>, in the same callback where we converted <code class="language-plaintext highlighter-rouge">trip.started_at</code> and <code class="language-plaintext highlighter-rouge">trip.ended_at</code> to <code class="language-plaintext highlighter-rouge">Date</code> objects, we add:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">startedMinutes</span> <span class="o">=</span> <span class="nx">minutesSinceMidnight</span><span class="p">(</span><span class="nx">trip</span><span class="p">.</span><span class="nx">started_at</span><span class="p">);</span>
<span class="nx">departuresByMinute</span><span class="p">[</span><span class="nx">startedMinutes</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">trip</span><span class="p">);</span>

<span class="c1">// TODO: Same for arrivals</span>
</code></pre></div></div><p class="note">Why not use <code class="language-plaintext highlighter-rouge">d3.group()</code> or <code class="language-plaintext highlighter-rouge">d3.groups()</code>? These return different data structures and as you will see below, using an array of arrays simplifies our code a lot as we can use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/slice"><code class="language-plaintext highlighter-rouge">array.slice()</code></a> to get a whole time range.</p><p>Now let’s use our awesome new data structures to make our code faster!</p><p>First, we can get rid of <code class="language-plaintext highlighter-rouge">filteredTrips</code>, as we will be calculating <code class="language-plaintext highlighter-rouge">filteredDepartures</code> and <code class="language-plaintext highlighter-rouge">filteredArrivals</code> directly from <code class="language-plaintext highlighter-rouge">departuresByMinute</code> and <code class="language-plaintext highlighter-rouge">arrivalsByMinute</code> respectively.</p><p>Let’s discuss calculating <code class="language-plaintext highlighter-rouge">filteredDepartures</code> and you can apply the same logic to <code class="language-plaintext highlighter-rouge">filteredArrivals</code>. For a first approximation, we can replace <code class="language-plaintext highlighter-rouge">filteredTrips</code>, with <code class="language-plaintext highlighter-rouge">departuresByMinute.slice(timeFilter - 60, timeFilter + 60).flat()</code>.</p><p>There are two methods in this you may not have seen before:</p><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/slice"><code class="language-plaintext highlighter-rouge">array.slice(start, end)</code></a> returns a new array with the elements from <code class="language-plaintext highlighter-rouge">start</code> (inclusive) to <code class="language-plaintext highlighter-rouge">end</code> (exclusive).<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/flat"><code class="language-plaintext highlighter-rouge">array.flat()</code></a> “flattens” an array of arrays, so that the result is a single array with all the elements of the subarrays.</ul><p>Let’s now enjoy the fruits of our labor by moving the slider <em>really fast</em> — it should now be smooth as butter! (or at least, much smoother than before)</p><p>But …there is one bug. Can you spot it? Our code works great for times between 1 AM and 11 PM. However for times where the 2 hour window spans midnight, it doesn’t work so well: <code class="language-plaintext highlighter-rouge">minMinute</code> will be negative, or <code class="language-plaintext highlighter-rouge">maxMinute</code> will be greater than 1440. While <code class="language-plaintext highlighter-rouge">array.slice()</code> actually does accept negative numbers and numbers greater than the array length, it doesn’t do what we want in this case.</p><p>In these cases, we basically want <em>two</em> separate <code class="language-plaintext highlighter-rouge">array.slice()</code> operations: one for the times before midnight and one for those after, that we then combine.</p><p>Let’s create a helper function to do just that:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">filterByMinute</span><span class="p">(</span><span class="nx">tripsByMinute</span><span class="p">,</span> <span class="nx">minute</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Normalize both to the [0, 1439] range</span>
  <span class="c1">// % is the remainder operator: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Remainder</span>
  <span class="kd">let</span> <span class="nx">minMinute</span> <span class="o">=</span> <span class="p">(</span><span class="nx">minute</span> <span class="o">-</span> <span class="mi">60</span> <span class="o">+</span> <span class="mi">1440</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1440</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nx">maxMinute</span> <span class="o">=</span> <span class="p">(</span><span class="nx">minute</span> <span class="o">+</span> <span class="mi">60</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1440</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">minMinute</span> <span class="o">&gt;</span> <span class="nx">maxMinute</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">beforeMidnight</span> <span class="o">=</span> <span class="nx">tripsByMinute</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">minMinute</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">afterMidnight</span> <span class="o">=</span> <span class="nx">tripsByMinute</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">maxMinute</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">beforeMidnight</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">afterMidnight</span><span class="p">).</span><span class="nx">flat</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">tripsByMinute</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">minMinute</span><span class="p">,</span> <span class="nx">maxMinute</span><span class="p">).</span><span class="nx">flat</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>Then, in the calculation for <code class="language-plaintext highlighter-rouge">filteredDepartures</code>, we use <code class="language-plaintext highlighter-rouge">filterByMinute(departuresByMinute, timeFilter)</code> instead of our previous <code class="language-plaintext highlighter-rouge">filteredDepartures.slice().flat()</code> operation. Don’t forget to do the same for <code class="language-plaintext highlighter-rouge">filteredArrivals</code>!</p><p>If everything goes well, it should now look like this:</p><video src="videos/optimized.mp4" class="browser" loop="" autoplay="" muted=""></video><p>Here they are side by side:</p><figure> <video src="videos/filtering.mp4" loop="" autoplay="" muted=""></video> <video src="videos/optimized.mp4" loop="" autoplay="" muted=""></video><figcaption> Left: original, Right: optimized</figcaption></figure><h2 id="step-6-visualizing-traffic-flow"> <a href="#step-6-visualizing-traffic-flow" class="anchor-heading" aria-labelledby="step-6-visualizing-traffic-flow"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 6: Visualizing traffic <em>flow</em></h2><p>Currently, we are visualizing traffic volume at different times of the day, but traffic direction also changes! In the morning, stations in downtown and near MIT campus tend to have a lot of arrivals, while in the evening they tend to see a lot of departures.</p><p>In this step, we will use circle color to visualize traffic flow at different times of the day.</p><h3 id="step-61-make-circle-color-depend-on-traffic-flow"> <a href="#step-61-make-circle-color-depend-on-traffic-flow" class="anchor-heading" aria-labelledby="step-61-make-circle-color-depend-on-traffic-flow"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 6.1: Make circle color depend on traffic flow</h3><p>While it may seem that using a continuous color scale gives us more information, humans are very poor at associating continuous color scales with quantitative data (as we will see in the upcoming Color lecture), so using only three colors will actually make the traffic flow trends more salient.</p><p>To do this, we will use a <a href="https://d3js.org/d3-scale/quantize"><em>quantize scale</em></a>, which is like a linear scale but with a discrete output range. We will use this scale to map a continuous number from 0 to 1 to a discrete number in the array <code class="language-plaintext highlighter-rouge">[0, 0.5, 1]</code>. It looks like this:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">stationFlow</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scaleQuantize</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]).</span><span class="nx">range</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span>
</code></pre></div></div><p>Notice that this is not a reactive statement, since it does not depend on any variables.</p><p>Then, on our circles, we calculate the ratio of departures to total traffic, map it to our discrete scale, and assign the result to a CSS variable:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- Other attributes ommitted for brevity --&gt;</span>
<span class="nt">&lt;circle</span>
  <span class="na">style=</span><span class="s">"--departure-ratio: { stationFlow(station.departures / station.totalTraffic) }"</span>
<span class="nt">&gt;&lt;/circle&gt;</span>
</code></pre></div></div><p>Then, in our CSS rule for <code class="language-plaintext highlighter-rouge">circle</code> we can use this variable to set the fill color:</p><div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">--color-departures</span><span class="o">:</span> <span class="nt">steelblue</span><span class="o">;</span>
<span class="nt">--color-arrivals</span><span class="o">:</span> <span class="nt">darkorange</span><span class="o">;</span>
<span class="nt">--color</span><span class="o">:</span> <span class="nt">color-mix</span><span class="o">(</span>
  <span class="nt">in</span> <span class="nt">oklch</span><span class="o">,</span>
  <span class="nt">var</span><span class="o">(</span><span class="nt">--color-departures</span><span class="o">)</span> <span class="nt">calc</span><span class="o">(</span><span class="err">100</span><span class="o">%</span> <span class="o">*</span> <span class="nt">var</span><span class="o">(</span><span class="nt">--departure-ratio</span><span class="o">)),</span>
  <span class="nt">var</span><span class="o">(</span><span class="nt">--color-arrivals</span><span class="o">)</span>
<span class="o">);</span>
<span class="nt">fill</span><span class="o">:</span> <span class="nt">var</span><span class="o">(</span><span class="nt">--color</span><span class="o">);</span>
</code></pre></div></div><p>If everything went well, our current map looks like this:</p><video src="videos/traffic-flow.mp4" loop="" muted="" autoplay=""></video><h3 id="step-62-adding-a-legend"> <a href="#step-62-adding-a-legend" class="anchor-heading" aria-labelledby="step-62-adding-a-legend"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 6.2: Adding a legend</h3><p>Our visualization looks pretty cool, but it’s very hard to understand what the three colors mean. We can fix this by adding a legend to the map.</p><p>Let’s first add some HTML for the legend <em>after</em> our map container:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"legend"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"--departure-ratio: 1"</span><span class="nt">&gt;</span>More departures<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"--departure-ratio: 0.5"</span><span class="nt">&gt;</span>Balanced<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"--departure-ratio: 0"</span><span class="nt">&gt;</span>More arrivals<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div><p>There are many ways to style this as a legend, but the following apply to most of them:</p><ul><li>Move the <code class="language-plaintext highlighter-rouge">--color-departures</code>, <code class="language-plaintext highlighter-rouge">--color-arrivals</code>, and <code class="language-plaintext highlighter-rouge">--color</code> variables to a new rule so that it applies to both <code class="language-plaintext highlighter-rouge">#map circle</code> and <code class="language-plaintext highlighter-rouge">.legend &gt; div</code>.<li>Apply flexbox to the legend container to align the items horizontally.<li>Apply <code class="language-plaintext highlighter-rouge">margin-block</code> to the legend container to give it some space from the map.</ul><p>Here are some example styles and a few pointers on how to implement them, but you’re welcome to experiment and come up with your own design:</p><h4 id="design-1-blocks"> <a href="#design-1-blocks" class="anchor-heading" aria-labelledby="design-1-blocks"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Design 1: Blocks</h4><p><img src="/labs/lab08/images/legend-blocks.png" alt="" /></p><p>One advantage of this is that it generalizes more nicely to more than 3 colors, and it’s fairly simple.</p><ul><li>Here each child <code class="language-plaintext highlighter-rouge">&lt;div&gt;</code> has <code class="language-plaintext highlighter-rouge">flex: 1</code> to make them take up equal space.<li>The gap is only <code class="language-plaintext highlighter-rouge">1px</code>; just enough to prevent the colors from touching.<li>Note that <code class="language-plaintext highlighter-rouge">text-align</code> is different for each swatch.<li>Specify significantly more horizontal padding than vertical, otherwise they will not look even<li>If you have used different colors, make sure to pick the text color accordingly to ensure sufficient contrast.</ul><h4 id="design-2-separate-swatches--labels"> <a href="#design-2-separate-swatches--labels" class="anchor-heading" aria-labelledby="design-2-separate-swatches--labels"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Design 2: Separate swatches &amp; labels</h4><p><img src="/labs/lab08/images/legend-swatches.png" alt="" /></p><p>This is a little more advanced but looks much more like an actual legend. One downside of it is that it’s harder to generalize to more than 3 colors, as it looks like a legend for a categorical variable.</p><ul><li>Uses a <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/::before"><code class="language-plaintext highlighter-rouge">::before</code></a> pseudo-element with <code class="language-plaintext highlighter-rouge">content: ""</code> to create the swatches.<li>Uses an additional element for the “Legend:” label<li>Each child <code class="language-plaintext highlighter-rouge">&lt;div&gt;</code> <em>also</em> uses flexbox<li>Make sure the gap on child <code class="language-plaintext highlighter-rouge">&lt;div&gt;</code> is <em>significantly</em> smaller than the gap on the parent <code class="language-plaintext highlighter-rouge">.legend</code> to create the effect of the swatches being connected to the labels (<a href="https://www.nngroup.com/articles/gestalt-proximity/">design principle of <em>proximity</em></a>).</ul><p>Here is the final result:</p><video src="videos/final.mp4" loop="" muted="" autoplay="" class="browser"></video><h2 id="step-7-add-your-new-project-to-your-list-of-projects"> <a href="#step-7-add-your-new-project-to-your-list-of-projects" class="anchor-heading" aria-labelledby="step-7-add-your-new-project-to-your-list-of-projects"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 7: Add your new project to your list of projects!</h2><p>Now that you have made this cool app to visualize bike traffic in the Boston area, time to claim credit for your work! Go back to your portfolio website, and add a new entry for this project, with a nice screenshot.</p><p>You should also add a <code class="language-plaintext highlighter-rouge">url</code> field to each project, and add a link to it in the template (for projects that have a <code class="language-plaintext highlighter-rouge">url</code> field).</p></div></div><div class="search-overlay"></div></div>
