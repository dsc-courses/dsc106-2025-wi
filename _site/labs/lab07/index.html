<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script src="/assets/js/vendor/lunr.min.js"></script> <script src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><title>Lab 7: Visualizing quantitative data with D3 | DSC 106</title><meta name="generator" content="Jekyll v3.9.0" /><meta property="og:title" content="Lab 7: Visualizing quantitative data with D3" /><meta name="author" content="Sam Lau" /><meta property="og:locale" content="en_US" /><meta name="description" content="DSC 106, Winter 2025 at UC San Diego" /><meta property="og:description" content="DSC 106, Winter 2025 at UC San Diego" /><link rel="canonical" href="http://localhost:4000/labs/lab07/" /><meta property="og:url" content="http://localhost:4000/labs/lab07/" /><meta property="og:site_name" content="DSC 106" /><meta property="og:type" content="website" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Lab 7: Visualizing quantitative data with D3" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","author":{"@type":"Person","name":"Sam Lau"},"description":"DSC 106, Winter 2025 at UC San Diego","headline":"Lab 7: Visualizing quantitative data with D3","url":"http://localhost:4000/labs/lab07/"}</script><body> <a class="skip-to-main" href="#main-content">Skip to main content</a> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> <symbol id="svg-external-link" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"><title id="svg-external-link-title">(external link)</title><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line> </symbol> </svg><div class="side-bar"><div class="site-header"> <a href="/" class="site-title lh-tight"> DSC 106 </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a></div><nav aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">üè† Home</a><li class="nav-list-item"><a href="/syllabus/" class="nav-list-link">üìñ Syllabus</a><li class="nav-list-item"><a href="/calendar/" class="nav-list-link">üìÜ Calendar</a><li class="nav-list-item"><a href="/tech_support/" class="nav-list-link">üôã‚Äç‚ôÇÔ∏è Tech Support</a><li class="nav-list-item"><a href="/resources/" class="nav-list-link">üìö Resources</a><li class="nav-list-item"><a href="/staff/" class="nav-list-link">üë©‚Äçüè´ Staff</a><li class="nav-list-item active"><a href="#" class="nav-list-expander" aria-label="toggle links in üë©‚Äçüî¨ Programming Labs category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/labs/" class="nav-list-link">üë©‚Äçüî¨ Programming Labs</a><ul class="nav-list "><li class="nav-list-item "><a href="/labs/debugging/" class="nav-list-link">Help Us Help You: Things to try before asking for help</a><li class="nav-list-item "><a href="/labs/lab00/" class="nav-list-link">Lab 0: Setup</a><li class="nav-list-item "><a href="/labs/lab01/" class="nav-list-link">Lab 1: Introduction to the Web platform</a><li class="nav-list-item "><a href="/labs/lab02/" class="nav-list-link">Lab 2: Styling with CSS</a><li class="nav-list-item "><a href="/labs/lab03/" class="nav-list-link">Lab 3: Introduction to JS</a><li class="nav-list-item "><a href="/labs/lab04/" class="nav-list-link">Lab 4: Svelte (Templating & Control Flow)</a><li class="nav-list-item "><a href="/labs/lab05/" class="nav-list-link">Lab 5: Svelte II (Loading Data & Reactivity)</a><li class="nav-list-item "><a href="/labs/lab06/" class="nav-list-link">Lab 6: Visualizing categorical data with D3</a><li class="nav-list-item active"><a href="/labs/lab07/" class="nav-list-link active">Lab 7: Visualizing quantitative data with D3</a><li class="nav-list-item "><a href="/labs/lab08/" class="nav-list-link">Lab 8: Geospatial Visualizations</a><li class="nav-list-item "><a href="/labs/lab09/" class="nav-list-link">Lab 9: Animation & Scrollytelling</a></ul><li class="nav-list-item"><a href="#" class="nav-list-expander" aria-label="toggle links in üìù Projects category"> <svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg> </a><a href="/projects/" class="nav-list-link">üìù Projects</a><ul class="nav-list "><li class="nav-list-item "><a href="/projects/final_project/" class="nav-list-link">Final Project</a><li class="nav-list-item "><a href="/projects/project1/" class="nav-list-link">Project 1: Expository Visualization</a><li class="nav-list-item "><a href="/projects/project2/" class="nav-list-link">Project 2: Deceptive Visualization</a><li class="nav-list-item "><a href="/projects/project2peer/" class="nav-list-link">Project 2: Deceptive Visualization - Peer Grading</a><li class="nav-list-item "><a href="/projects/project3/" class="nav-list-link">Project 3: Interactive Visualization</a><li class="nav-list-item "><a href="/projects/project3peer/" class="nav-list-link">Project 3: Interactive Visualization - Peer Grading</a></ul><li class="nav-list-item"><a href="/labs/lab09/todo/" class="nav-list-link">For next year</a><li class="nav-list-item"><a href="/labs/lab07/old/" class="nav-list-link">Old content, ignore</a><li class="nav-list-item"><a href="/labs/lab09/playtesting/" class="nav-list-link">Playtesting</a><li class="nav-list-item"><a href="/labs/lab05/playtesting/" class="nav-list-link">Playtesting</a><li class="nav-list-item"><a href="/labs/lab06/playtesting/" class="nav-list-link">Playtesting</a><li class="nav-list-item"><a href="/labs/lab07/playtesting/" class="nav-list-link">Playtesting</a><li class="nav-list-item"><a href="/labs/lab08/playtesting/" class="nav-list-link">Playtesting</a><li class="nav-list-item"><a href="/labs/lab02/playtesting/" class="nav-list-link">Playtesting Lab 2</a><li class="nav-list-item"><a href="/labs/lab04/playtesting/enrique/" class="nav-list-link">create-svelte</a><li class="nav-list-item"><a href="/labs/lab04/playtesting/" class="nav-list-link">create-svelte</a></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/just-the-docs/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search DSC 106" aria-label="Search DSC 106" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="" class="site-button" > üíª GitHub </a><li class="aux-nav-list-item"> <a href="" class="site-button" > üôã Ed </a><li class="aux-nav-list-item"> <a href="" class="site-button" > üíØ Gradescope </a></ul></nav></div><div id="main-content-wrap" class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="/labs/">üë©‚Äçüî¨ Programming Labs</a><li class="breadcrumb-nav-list-item"><span>Lab 7: Visualizing quantitative data with D3</span></ol></nav><div id="main-content" class="main-content" role="main"><h1 id="lab-7-visualizing-quantitative-data-with-d3"> <a href="#lab-7-visualizing-quantitative-data-with-d3" class="anchor-heading" aria-labelledby="lab-7-visualizing-quantitative-data-with-d3"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Lab 7: Visualizing quantitative data with D3</h1><blockquote class="no_toc summary"><p>In this lab, we will learn:</p><ul><li>How do we draw visualizations for quantitative data, such as bar charts and scatter plots, using D3<li>How to show tooltips on hover as a way to provide more information about the data<li>How to compute summary statistics about our data in a structured a way</ul></blockquote><details open=""> <summary class="text-delta"> Table of contents </summary><ul id="markdown-toc"><li><a href="#lab-7-visualizing-quantitative-data-with-d3" id="markdown-toc-lab-7-visualizing-quantitative-data-with-d3">Lab 7: Visualizing quantitative data with D3</a><ul><li><a href="#check-off" id="markdown-toc-check-off">Check-off</a><li><a href="#questions-doc" id="markdown-toc-questions-doc"><a href="https://docs.google.com/document/d/1pgWQbf7FpseuojV1J4i2gzmgKhmlStOawYKLNQPc7bI/edit?usp=sharing" target="_blank" rel="noopener noreferrer">Questions Doc</a></a><li><a href="#slides-or-lack-thereof" id="markdown-toc-slides-or-lack-thereof">Slides (or lack thereof)</a><li><a href="#step-0-setting-up" id="markdown-toc-step-0-setting-up">Step 0: Setting up</a><ul><li><a href="#step-01-adding-a-new-page-with-meta-analysis-of-the-code-in-our-project" id="markdown-toc-step-01-adding-a-new-page-with-meta-analysis-of-the-code-in-our-project">Step 0.1: Adding a new page with meta-analysis of the code in our project</a><li><a href="#step-02-adding-code-analysis-script" id="markdown-toc-step-02-adding-code-analysis-script">Step 0.2: Adding code analysis script</a><li><a href="#step-03-setting-it-up-so-that-the-csv-file-is-generated-on-every-build" id="markdown-toc-step-03-setting-it-up-so-that-the-csv-file-is-generated-on-every-build">Step 0.3: Setting it up so that the CSV file is generated on every build</a><li><a href="#step-04-exclude-csv-from-committed-files" id="markdown-toc-step-04-exclude-csv-from-committed-files">Step 0.4: Exclude CSV from committed files.</a></ul><li><a href="#step-1-displaying-summary-stats" id="markdown-toc-step-1-displaying-summary-stats">Step 1: Displaying summary stats</a><ul><li><a href="#step-11-reading-the-csv-file-in-d3" id="markdown-toc-step-11-reading-the-csv-file-in-d3">Step 1.1: Reading the CSV file in D3</a><li><a href="#step-12-computing-commit-data" id="markdown-toc-step-12-computing-commit-data">Step 1.2: Computing commit data</a><li><a href="#step-13-displaying-the-stats" id="markdown-toc-step-13-displaying-the-stats">Step 1.3: Displaying the stats</a><ul><li><a href="#aggregates-over-the-whole-dataset" id="markdown-toc-aggregates-over-the-whole-dataset">Aggregates over the whole dataset</a><li><a href="#number-of-distinct-values" id="markdown-toc-number-of-distinct-values">Number of distinct values</a><li><a href="#grouped-aggregates" id="markdown-toc-grouped-aggregates">Grouped aggregates</a><li><a href="#minmax-value" id="markdown-toc-minmax-value">Min/max value</a></ul></ul><li><a href="#step-2-visualizing-time-and-day-of-commits-in-a-scatterplot" id="markdown-toc-step-2-visualizing-time-and-day-of-commits-in-a-scatterplot">Step 2: Visualizing time and day of commits in a scatterplot</a><ul><li><a href="#step-21-drawing-the-dots" id="markdown-toc-step-21-drawing-the-dots">Step 2.1: Drawing the dots</a><li><a href="#step-22-adding-axes" id="markdown-toc-step-22-adding-axes">Step 2.2: Adding axes</a><li><a href="#step-23-adding-horizontal-grid-lines" id="markdown-toc-step-23-adding-horizontal-grid-lines">Step 2.3: Adding horizontal grid lines</a></ul><li><a href="#step-3-adding-a-tooltip" id="markdown-toc-step-3-adding-a-tooltip">Step 3: Adding a tooltip</a><ul><li><a href="#step-31-static-element" id="markdown-toc-step-31-static-element">Step 3.1: Static element</a><li><a href="#step-32-making-it-look-like-a-tooltip" id="markdown-toc-step-32-making-it-look-like-a-tooltip">Step 3.2: Making it look like a tooltip</a><li><a href="#step-33-making-only-appear-when-we-are-hovering-over-a-dot" id="markdown-toc-step-33-making-only-appear-when-we-are-hovering-over-a-dot">Step 3.3: Making only appear when we are hovering over a dot</a><li><a href="#step-34-positioning-the-tooltip-near-the-mouse-cursor" id="markdown-toc-step-34-positioning-the-tooltip-near-the-mouse-cursor">Step 3.4: Positioning the tooltip near the mouse cursor</a><li><a href="#step-35-bulletproof-positioning-optional" id="markdown-toc-step-35-bulletproof-positioning-optional">Step 3.5: Bulletproof positioning (optional)</a></ul><li><a href="#step-4-communicating-lines-edited-via-the-size-of-the-dots-optional" id="markdown-toc-step-4-communicating-lines-edited-via-the-size-of-the-dots-optional">Step 4: Communicating lines edited via the size of the dots (optional)</a><ul><li><a href="#step-41-calculating-our-scale" id="markdown-toc-step-41-calculating-our-scale">Step 4.1: Calculating our scale</a><li><a href="#step-42-area-not-radius" id="markdown-toc-step-42-area-not-radius">Step 4.2: Area, not radius</a><li><a href="#step-43-paint-smaller-dots-over-larger-ones" id="markdown-toc-step-43-paint-smaller-dots-over-larger-ones">Step 4.3: Paint smaller dots over larger ones</a></ul><li><a href="#step-5-brushing" id="markdown-toc-step-5-brushing">Step 5: Brushing</a><ul><li><a href="#step-51-setting-up-the-brush" id="markdown-toc-step-51-setting-up-the-brush">Step 5.1: Setting up the brush</a><li><a href="#step-52-getting-our-tooltips-back" id="markdown-toc-step-52-getting-our-tooltips-back">Step 5.2: Getting our tooltips back</a><li><a href="#step-53-styling-the-selection-rectangle-optional" id="markdown-toc-step-53-styling-the-selection-rectangle-optional">Step 5.3: Styling the selection rectangle (optional)</a><li><a href="#step-54-making-the-brush-actually-select-dots" id="markdown-toc-step-54-making-the-brush-actually-select-dots">Step 5.4: Making the brush actually select dots</a><li><a href="#step-54-showing-count-of-selected-commits" id="markdown-toc-step-54-showing-count-of-selected-commits">Step 5.4: Showing count of selected commits</a><li><a href="#step-55-showing-breakdown-of-languages-across-all-lines-edited-in-selected-commits" id="markdown-toc-step-55-showing-breakdown-of-languages-across-all-lines-edited-in-selected-commits">Step 5.5: Showing breakdown of languages across all lines edited in selected commits</a><li><a href="#step-56-drawing-a-pie-chart-of-the-language-breakdown" id="markdown-toc-step-56-drawing-a-pie-chart-of-the-language-breakdown">Step 5.6: Drawing a pie chart of the language breakdown</a></ul></ul></ul></details><hr /><h2 id="check-off"> <a href="#check-off" class="anchor-heading" aria-labelledby="check-off"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Check-off</h2><p><strong>You need to come to TA Office Hours to get checked off for this lab</strong> (any of them, no appointment needed). Please fill in <a href="checkoff">the check-off form at <code class="language-plaintext highlighter-rouge">labs/7/checkoff</code></a> <em>before</em> your check-off. Ideally you should fill in the form <em>right before</em> your check-off, but it‚Äôs ok if you fill it out in advance.</p><p class="warning">Filling out the form is a necessary but not sufficient condition to get checked-off. <strong>You still need to come to office hours in person for your check-off to be processed.</strong></p><p>You could even fill it out before you finish the lab, since we won‚Äôt look at it until your check-off, but the closer to the end of the lab you fill it out, the more meaningful your feedback will be.</p><h2 id="questions-doc"> <a href="#questions-doc" class="anchor-heading" aria-labelledby="questions-doc"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> <a href="https://docs.google.com/document/d/1pgWQbf7FpseuojV1J4i2gzmgKhmlStOawYKLNQPc7bI/edit?usp=sharing" target="_blank" rel="noopener noreferrer">Questions Doc</a></h2><p>Add questions to the questions doc throughout the lecture and lab! After lab, come to <a href="../../logistics/staff.html#office-hours">office hours</a> or ask on <a href="https://vis-society-forum.csail.mit.edu/">Discourse</a> for futher questions!</p><h2 id="slides-or-lack-thereof"> <a href="#slides-or-lack-thereof" class="anchor-heading" aria-labelledby="slides-or-lack-thereof"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Slides (or lack thereof)</h2><p>Just like the previous lab, there are no slides for this lab! Since the topic was covered in last Monday‚Äôs lecture, it can be helpful for you to review the <a href="../../lectures/intro-svelte-d3.html">material from it</a>.</p><p class="note">This lab is a little more involved than most of the previous labs, because it‚Äôs introducing the core technical material around data visualization. A robust understanding of these concepts will be invaluable as you work on your final projects, so spending time practicing them for the lab will be time will spent.</p><h2 id="step-0-setting-up"> <a href="#step-0-setting-up" class="anchor-heading" aria-labelledby="step-0-setting-up"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 0: Setting up</h2><p>This step takes you through several prepratory steps before we can work on the main part of the lab.</p><h3 id="step-01-adding-a-new-page-with-meta-analysis-of-the-code-in-our-project"> <a href="#step-01-adding-a-new-page-with-meta-analysis-of-the-code-in-our-project" class="anchor-heading" aria-labelledby="step-01-adding-a-new-page-with-meta-analysis-of-the-code-in-our-project"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 0.1: Adding a new page with meta-analysis of the code in our project</h3><p>In this lab, we will be computing and visualizing different stats about our codebase. We will display these in a new page on our website. Create a <code class="language-plaintext highlighter-rouge">routes/meta/+page.svelte</code> file and add some content in it (e.g. a heading, a description).</p><p>Add it to your navigation menu.</p><p><img src="images/meta-page.png" alt="" class="browser" data-url="http://localhost:5173/meta" /></p><h3 id="step-02-adding-code-analysis-script"> <a href="#step-02-adding-code-analysis-script" class="anchor-heading" aria-labelledby="step-02-adding-code-analysis-script"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 0.2: Adding code analysis script</h3><p>In this step you will install <a href="https://www.npmjs.com/package/elocuent">our code analysis script</a> which will analyze the code of our app and display some statistics about it.</p><p class="fyi">If you‚Äôre interested in the details of how this script works, you can <a href="https://github.com/LeaVerou/elocuent/tree/main/src">examine its code in its repo</a>. It‚Äôs just some JS code that runs in Node.js :) (and it‚Äôs not that long either!)</p><p>First, open the terminal and run this, to install <a href="https://www.npmjs.com/package/elocuent">the package</a> that will do the analysis:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install </span>elocuent <span class="nt">-D</span>
</code></pre></div></div><p>Now in your terminal, run this command:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npx elocuent <span class="nt">-d</span> static,src <span class="nt">-o</span> static/loc.csv
</code></pre></div></div><p>Or this, if you‚Äôve used spaces for indentation (replace <code class="language-plaintext highlighter-rouge">2</code> with the number of spaces):</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npx elocuent <span class="nt">-d</span> static,src <span class="nt">-o</span> static/loc.csv <span class="nt">--spaces</span> 2
</code></pre></div></div><p>Make sure your indentation is consistent across your code!</p><p class="tip">Two very popular tools to ensure a consistent code style are <a href="https://eslint.org/">ESLint</a> (JS only) and <a href="https://prettier.io/">Prettier</a> (JS, CSS, HTML) They have different philosophies: ESLint is a <em>linting tool</em>: you define what rules you want to follow, and it warns you when you don‚Äôt follow them (often it can fix them too, but you need to explicitly ask it to). Prettier is a <em>code formatter</em>: when you hit Save it auto-formats your code based on its predefined rules. Linters give you more control, whereas code formatters are more hands-off but also less flexible.</p><p>If everything went well, you should now have a file called <code class="language-plaintext highlighter-rouge">loc.csv</code> in the <code class="language-plaintext highlighter-rouge">static</code> directory. Its content should look like this (showing first 30 lines):</p><details> <summary>First 30 lines of <code>loc.csv</code></summary><pre><code class="language-csv">file,line,type,commit,author,date,time,timezone,datetime,depth,length
src/app.html,1,html,7d3b906,Lea Verou,2024-02-26,01:33:51,-05:00,2024-02-26T01:33:51-05:00,0,15
src/app.html,2,html,7d3b906,Lea Verou,2024-02-26,01:33:51,-05:00,2024-02-26T01:33:51-05:00,0,16
src/app.html,3,html,7d3b906,Lea Verou,2024-02-26,01:33:51,-05:00,2024-02-26T01:33:51-05:00,1,5
src/app.html,4,html,7d3b906,Lea Verou,2024-02-26,01:33:51,-05:00,2024-02-26T01:33:51-05:00,2,22
src/app.html,5,html,7d3b906,Lea Verou,2024-02-26,01:33:51,-05:00,2024-02-26T01:33:51-05:00,2,26
src/app.html,6,html,7d3b906,Lea Verou,2024-02-26,01:33:51,-05:00,2024-02-26T01:33:51-05:00,2,55
src/app.html,7,html,7d3b906,Lea Verou,2024-02-26,01:33:51,-05:00,2024-02-26T01:33:51-05:00,2,68
src/app.html,8,html,3c2ea132,Lea Verou,2024-03-02,15:26:34,-05:00,2024-03-02T15:26:34-05:00,2,59
src/app.html,9,html,04217ac3,Lea Verou,2024-02-27,14:46:20,-05:00,2024-02-27T14:46:20-05:00,2,64
src/app.html,10,html,7d3b906,Lea Verou,2024-02-26,01:33:51,-05:00,2024-02-26T01:33:51-05:00,2,14
src/app.html,11,html,7d3b906,Lea Verou,2024-02-26,01:33:51,-05:00,2024-02-26T01:33:51-05:00,1,6
src/app.html,12,html,7d3b906,Lea Verou,2024-02-26,01:33:51,-05:00,2024-02-26T01:33:51-05:00,1,41
src/app.html,13,html,7d3b906,Lea Verou,2024-02-26,01:33:51,-05:00,2024-02-26T01:33:51-05:00,2,51
src/app.html,14,html,7d3b906,Lea Verou,2024-02-26,01:33:51,-05:00,2024-02-26T01:33:51-05:00,1,6
src/app.html,15,html,7d3b906,Lea Verou,2024-02-26,01:33:51,-05:00,2024-02-26T01:33:51-05:00,0,7
src/routes/+page.svelte,1,svelte,7d3b906,Lea Verou,2024-02-26,01:33:51,-05:00,2024-02-26T01:33:51-05:00,0,21
src/routes/+page.svelte,2,svelte,7d3b906,Lea Verou,2024-02-26,01:33:51,-05:00,2024-02-26T01:33:51-05:00,0,43
src/routes/+page.svelte,3,svelte,7d3b906,Lea Verou,2024-02-26,01:33:51,-05:00,2024-02-26T01:33:51-05:00,0,40
src/routes/+page.svelte,4,svelte,7d3b906,Lea Verou,2024-02-26,01:33:51,-05:00,2024-02-26T01:33:51-05:00,1,102
src/routes/+page.svelte,5,svelte,7d3b906,Lea Verou,2024-02-26,01:33:51,-05:00,2024-02-26T01:33:51-05:00,1,76
src/routes/+page.svelte,6,svelte,7d3b906,Lea Verou,2024-02-26,01:33:51,-05:00,2024-02-26T01:33:51-05:00,1,39
src/routes/+page.svelte,7,svelte,bdb6236e,Lea Verou,2024-02-26,03:26:16,-05:00,2024-02-26T03:26:16-05:00,0,4
src/routes/+page.svelte,8,svelte,bdb6236e,Lea Verou,2024-02-26,03:26:16,-05:00,2024-02-26T03:26:16-05:00,0,0
src/routes/+page.svelte,9,svelte,bdb6236e,Lea Verou,2024-02-26,03:26:16,-05:00,2024-02-26T03:26:16-05:00,0,8
src/routes/+page.svelte,10,js,04217ac3,Lea Verou,2024-02-27,14:46:20,-05:00,2024-02-27T14:46:20-05:00,0,42
src/routes/+page.svelte,11,js,5c703cf0,Lea Verou,2024-02-27,19:56:10,-05:00,2024-02-27T19:56:10-05:00,0,44
src/routes/+page.svelte,12,js,50612a03,Lea Verou,2024-03-05,11:11:52,-05:00,2024-03-05T11:11:52-05:00,0,68
src/routes/+page.svelte,13,js,50612a03,Lea Verou,2024-03-05,11:11:52,-05:00,2024-03-05T11:11:52-05:00,0,19
src/routes/+page.svelte,14,js,50612a03,Lea Verou,2024-03-05,11:11:52,-05:00,2024-03-05T11:11:52-05:00,1,8
</code></pre></details><p>You can find a description of the metadata stored <a href="https://www.npmjs.com/package/elocuent">here</a>.</p><p class="fyi">Why are we using CSV instead of e.g. JSON? CSV is more efficient for data that has many rows, since we don‚Äôt need to repeat the names of the properties for every row.</p><p>Do periodically re-run the script as you work through the lab to see the data update!</p><h3 id="step-03-setting-it-up-so-that-the-csv-file-is-generated-on-every-build"> <a href="#step-03-setting-it-up-so-that-the-csv-file-is-generated-on-every-build" class="anchor-heading" aria-labelledby="step-03-setting-it-up-so-that-the-csv-file-is-generated-on-every-build"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 0.3: Setting it up so that the CSV file is generated on every build</h3><p>We want the CSV file to be generated every time we build our app, so that it‚Äôs always up-to-date. We can do that by adding a <code class="language-plaintext highlighter-rouge">prebuild</code> script to our <code class="language-plaintext highlighter-rouge">package.json</code> that runs <code class="language-plaintext highlighter-rouge">npx elocuent</code>. Right above this line in <code class="language-plaintext highlighter-rouge">package.json</code>:</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"build"</span><span class="p">:</span><span class="w"> </span><span class="s2">"vite build"</span><span class="err">,</span><span class="w">
</span></code></pre></div></div><p>add:</p><div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"prebuild"</span><span class="p">:</span><span class="w"> </span><span class="s2">"npx elocuent -d static,src -o static/loc.csv"</span><span class="err">,</span><span class="w">
</span></code></pre></div></div><p>We also need make sure that our build environment (which we specify in <code class="language-plaintext highlighter-rouge">deploy.yml</code>) has access to all of our Git history. To do this, open <code class="language-plaintext highlighter-rouge">.github/workflows/deploy.yml</code> and modify the <code class="language-plaintext highlighter-rouge">Checkout</code> step so that it looks like this:</p><div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout</span>
  <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v4</span>
  <span class="na">with</span><span class="pi">:</span>
    <span class="na">fetch-depth</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0'</span>
</code></pre></div></div><p class="fyi"><code class="language-plaintext highlighter-rouge">fetch-depth: '0'</code> tells GitHub actions to <a href="https://github.com/actions/checkout?tab=readme-ov-file#fetch-all-history-for-all-tags-and-branches">fetch <em>all</em> history for all branches and tags</a>. By default, the action will only fetch the latest commit, so your deployed scatterplot will only have one dot!</p><p>Now, every time we run <code class="language-plaintext highlighter-rouge">npm run build</code>, <code class="language-plaintext highlighter-rouge">elocuent</code> will be run first.</p><h3 id="step-04-exclude-csv-from-committed-files"> <a href="#step-04-exclude-csv-from-committed-files" class="anchor-heading" aria-labelledby="step-04-exclude-csv-from-committed-files"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 0.4: Exclude CSV from committed files.</h3><p>Since we are now generating the script on the server as well, there is no reason to include it in our commits. Add <code class="language-plaintext highlighter-rouge">static/loc.csv</code> to your <code class="language-plaintext highlighter-rouge">.gitignore</code> file.</p><p>If you have already committed it, you will need to first delete the file, commit &amp; push the deletion and the addition to <code class="language-plaintext highlighter-rouge">.gitignore</code>, and only after that re-run the script to re-generate it.</p><h2 id="step-1-displaying-summary-stats"> <a href="#step-1-displaying-summary-stats" class="anchor-heading" aria-labelledby="step-1-displaying-summary-stats"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1: Displaying summary stats</h2><h3 id="step-11-reading-the-csv-file-in-d3"> <a href="#step-11-reading-the-csv-file-in-d3" class="anchor-heading" aria-labelledby="step-11-reading-the-csv-file-in-d3"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1.1: Reading the CSV file in D3</h3><p>In our <code class="language-plaintext highlighter-rouge">routes/meta/+page.svelte</code> file, we will now read the CSV file. Thankfully, we don‚Äôt have to reinvent the wheel and parse CSV files ourselves, D3 has a built-in function for that.</p><p>Add a <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> element to the Meta page, and import D3, like you did in the previous lab:</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">d3</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">d3</span><span class="dl">'</span><span class="p">;</span>
</code></pre></div></div><p>We will be using the <code class="language-plaintext highlighter-rouge">d3.csv()</code> function from the <a href="https://d3js.org/d3-fetch"><code class="language-plaintext highlighter-rouge">d3-fetch</code></a> module, which provides helper functions for fetching data.</p><p>Now let‚Äôs read the CSV file:</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">onMount</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">svelte</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[];</span>

<span class="nx">onMount</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">csv</span><span class="p">(</span><span class="dl">'</span><span class="s1">loc.csv</span><span class="dl">'</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div><p>and let‚Äôs print out the total lines of code in our repo in the HTML to make sure it worked:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;p&gt;</span>Total lines of code: {data.length}<span class="nt">&lt;/p&gt;</span>
</code></pre></div></div><p>If everything went well, you‚Äôll be seeing something like this:</p><p><img src="images/total-loc.png" alt="" class="browser" data-url="http://localhost:5173/meta" /></p><p>To see the structure of these objects, add a <code class="language-plaintext highlighter-rouge">console.log(data)</code> right after the statement that sets the variable, then check your console.</p><p>You should be seeing something like this(I‚Äôve expanded the first row):</p><p><img src="images/data-console-string.png" alt="Screenshot of the output" class="outline" /></p><p>Note that everything is a string, including the numbers and dates. That can be quite a footgun when handling data *(as an anecdote, I spent about an hour debugging an issue caused by using <code class="language-plaintext highlighter-rouge">+</code> to add two numbers together, which instead concatenated them as strings <strong>while developing this very lab!*</strong>). To fix it, we add a <a href="&lt;https://d3js.org/d3-dsv#dsv_parse">row conversion function</a>:</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">data</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">csv</span><span class="p">(</span><span class="dl">'</span><span class="s1">loc.csv</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">row</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">({</span>
  <span class="p">...</span><span class="nx">row</span><span class="p">,</span>
  <span class="na">line</span><span class="p">:</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">line</span><span class="p">),</span> <span class="c1">// or just +row.line</span>
  <span class="na">depth</span><span class="p">:</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">depth</span><span class="p">),</span>
  <span class="na">length</span><span class="p">:</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">length</span><span class="p">),</span>
  <span class="na">date</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">date</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">T00:00</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">row</span><span class="p">.</span><span class="nx">timezone</span><span class="p">),</span>
  <span class="na">datetime</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">datetime</span><span class="p">),</span>
<span class="p">}));</span>
</code></pre></div></div><p>It should now look like this: <img src="images/data-console.png" alt="Screenshot of the output" class="outline" /></p><p>Don‚Äôt forget to delete this line now that we‚Äôre done ‚Äî we don‚Äôt want to clutter our page with debug info!</p><h3 id="step-12-computing-commit-data"> <a href="#step-12-computing-commit-data" class="anchor-heading" aria-labelledby="step-12-computing-commit-data"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1.2: Computing commit data</h3><p>Notice that while this data includes information about each commit<sup id="fnref:eachcommit" role="doc-noteref"><a href="#fn:eachcommit" class="footnote" rel="footnote">1</a></sup> (that still has an effect on the codebase), it‚Äôs not in a format we can easily access, but mixed in with the data about each line (this is called <em>denormalized</em> data).</p><p>Let‚Äôs extract this data about commits in a separate object for easy access. We will compute this inside <code class="language-plaintext highlighter-rouge">onMount</code> after reading the CSV file.</p><p>First, define a <code class="language-plaintext highlighter-rouge">commits</code> variable outside <code class="language-plaintext highlighter-rouge">onMount</code>:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">commits</span> <span class="o">=</span> <span class="p">[];</span>
</code></pre></div></div><p>Then, inside <code class="language-plaintext highlighter-rouge">onMount</code>, we will use the <a href="https://d3js.org/d3-array/group#groups"><code class="language-plaintext highlighter-rouge">d3.groups()</code></a> method to group the data by the <code class="language-plaintext highlighter-rouge">commit</code> property.</p><div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">commits</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">groups</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">commit</span><span class="p">);</span>
</code></pre></div></div><p>This will give us an array where each element is an array with two values:</p><ul><li>The first value is the unique commit identifier<li>The second value is an array of objects for lines that have been modified by that commit.</ul><p class="tip">Print it out with <code class="language-plaintext highlighter-rouge">{JSON.stringify(commits, null, "\t")}</code> to see what it looks like!</p><p>To transform this into an array of objects about each commit, with a <code class="language-plaintext highlighter-rouge">lines</code> property that contains the number of lines that were modified by that commit:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">commits</span> <span class="o">=</span> <span class="nx">d3</span>
  <span class="p">.</span><span class="nx">groups</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">commit</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">map</span><span class="p">(([</span><span class="nx">commit</span><span class="p">,</span> <span class="nx">lines</span><span class="p">])</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">first</span> <span class="o">=</span> <span class="nx">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="kd">let</span> <span class="p">{</span> <span class="nx">author</span><span class="p">,</span> <span class="nx">date</span><span class="p">,</span> <span class="nx">time</span><span class="p">,</span> <span class="nx">timezone</span><span class="p">,</span> <span class="nx">datetime</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">first</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">ret</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">id</span><span class="p">:</span> <span class="nx">commit</span><span class="p">,</span>
      <span class="na">url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">https://github.com/vis-society/lab-7/commit/</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">commit</span><span class="p">,</span>
      <span class="nx">author</span><span class="p">,</span>
      <span class="nx">date</span><span class="p">,</span>
      <span class="nx">time</span><span class="p">,</span>
      <span class="nx">timezone</span><span class="p">,</span>
      <span class="nx">datetime</span><span class="p">,</span>
      <span class="na">hourFrac</span><span class="p">:</span> <span class="nx">datetime</span><span class="p">.</span><span class="nx">getHours</span><span class="p">()</span> <span class="o">+</span> <span class="nx">datetime</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span><span class="p">,</span>
      <span class="na">totalLines</span><span class="p">:</span> <span class="nx">lines</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="c1">// Like ret.lines = lines</span>
    <span class="c1">// but non-enumerable so it doesn‚Äôt show up in JSON.stringify</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">ret</span><span class="p">,</span> <span class="dl">'</span><span class="s1">lines</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">value</span><span class="p">:</span> <span class="nx">lines</span><span class="p">,</span>
      <span class="na">configurable</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">writable</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">enumerable</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
  <span class="p">});</span>
</code></pre></div></div><p>Check it out by adding <code class="language-plaintext highlighter-rouge">console.log(commits)</code> <strong>after</strong> setting it. In my case it looks like this:</p><p><img src="/labs/lab07/images/commits-log.png" alt="" /></p><h3 id="step-13-displaying-the-stats"> <a href="#step-13-displaying-the-stats" class="anchor-heading" aria-labelledby="step-13-displaying-the-stats"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 1.3: Displaying the stats</h3><p>Let‚Äôs get our feet wet with this data by displaying a few more stats. Use a <code class="language-plaintext highlighter-rouge">&lt;dl&gt;</code> list that reuses the same formatting as in <a href="../5/#step-23-displaying-the-data-in-a-more-useful-way">the stats on your homepage</a>.</p><p class="note">Avoid copy-pasting the CSS. You can either create a class and define the styling for <code class="language-plaintext highlighter-rouge">dl.stats</code> and its children in your <code class="language-plaintext highlighter-rouge">style.css</code> file, or create a <code class="language-plaintext highlighter-rouge">&lt;Stats&gt;</code> Svelte component that wraps it (I went with the former for simplicity, but the ‚Äúproper‚Äù way is the latter).</p><p>Delete the paragraph we added in the previous step and display that as the first stat:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dl</span> <span class="na">class=</span><span class="s">"stats"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;dt&gt;</span>Total <span class="nt">&lt;abbr</span> <span class="na">title=</span><span class="s">"Lines of code"</span><span class="nt">&gt;</span>LOC<span class="nt">&lt;/abbr&gt;&lt;/dt&gt;</span>
  <span class="nt">&lt;dd&gt;</span>{data.length}<span class="nt">&lt;/dd&gt;</span>
<span class="nt">&lt;/dl&gt;</span>
</code></pre></div></div><p>You can display the total number of commits as the second statistic.</p><p>What other aggregate stats can you calculate about the whole codebase? Here are a few ideas (pick 3-4 from the list below, or come up with your own):</p><ul><li>Number of files in the codebase<li>Maximum file length (in lines)<li>Longest file<li>Average file length (in lines)<li>Average line length (in characters)<li>Longest line length<li>Longest line<li>Maximum depth<li>Deepest line<li>Average depth<li>Average file depth<li>Time of day (morning, afternoon, evening, night) that most work is done<li>Day of the week that most work is done</ul><figure><p><img src="/labs/lab07/images/summary.png" alt="" /></p><figcaption> Example of a summary stats section</figcaption></figure><p>You will find the <a href="https://d3js.org/d3-array"><code class="language-plaintext highlighter-rouge">d3-array</code></a> module very helpful for these kinds of computations, and especially:</p><ul><li><a href="https://d3js.org/d3-array/summarize">Summarizing data</a><li><a href="https://d3js.org/d3-array/group">Grouping data</a></ul><p>Following is some advice on how to calculate these stats depending on their category.</p><h4 id="aggregates-over-the-whole-dataset"> <a href="#aggregates-over-the-whole-dataset" class="anchor-heading" aria-labelledby="aggregates-over-the-whole-dataset"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Aggregates over the whole dataset</h4><p>These compute an aggregate (e.g. sum, mean, min, max) over a property across the whole dataset.</p><p>Examples:</p><ul><li>Average line length<li>Longest line<li>Maximum depth<li>Average depth</ul><p>These involve using one of the <a href="https://d3js.org/d3-array/summarize">data summarization methods</a> over the whole dataset, mapping to the property you want to summarize, and then applying the method. For example, to calculate the maximum depth, you‚Äôd use <code class="language-plaintext highlighter-rouge">d3.max(data, d =&gt; d.depth)</code>. To calculate the average depth, you‚Äôd use <code class="language-plaintext highlighter-rouge">d3.mean(data, d =&gt; d.depth)</code>.</p><h4 id="number-of-distinct-values"> <a href="#number-of-distinct-values" class="anchor-heading" aria-labelledby="number-of-distinct-values"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Number of distinct values</h4><p>These compute the number of distinct values of a property across the whole dataset.</p><p>Examples:</p><ul><li>Number of files<li>Number of authors<li>Number of days worked on site</ul><p>To calculate these, you‚Äôd use <a href="https://d3js.org/d3-array/group#group"><code class="language-plaintext highlighter-rouge">d3.group()</code></a> / <a href="https://d3js.org/d3-array/group#groups"><code class="language-plaintext highlighter-rouge">d3.groups()</code></a> to group the data by the property you want to count the distinct values of, and then use <code class="language-plaintext highlighter-rouge">result.size</code> / <code class="language-plaintext highlighter-rouge">result.length</code> respectively to get the number of groups.</p><p>For example, the number of files would be <code class="language-plaintext highlighter-rouge">d3.group(data, d =&gt; d.file).size</code>, (or <code class="language-plaintext highlighter-rouge">d3.groups(data, d =&gt; d.file).length</code>).</p><h4 id="grouped-aggregates"> <a href="#grouped-aggregates" class="anchor-heading" aria-labelledby="grouped-aggregates"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Grouped aggregates</h4><p>These are very interesting stats, but also the most involved of the bunch. These compute an aggregate within a group, and then a <em>different</em> aggregate across all groups.</p><p>Examples:</p><ul><li>Average file length (in lines)<li>Average file depth (average of max depth per file)</ul><p>First, we use <code class="language-plaintext highlighter-rouge">d3.rollup()</code> / <code class="language-plaintext highlighter-rouge">d3.rollups()</code> to compute the aggregate within each group. If it seems familiar, it‚Äôs because <a href="../6/#step-32-passing-project-data-via-the-data-prop">we used it in the previous lab to calculate projects per year</a>. For example, to calculate the average file length, we‚Äôd use <code class="language-plaintext highlighter-rouge">d3.rollups()</code> to callculate lengths for all files via</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">:</span> <span class="nx">fileLengths</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">rollups</span><span class="p">(</span>
  <span class="nx">data</span><span class="p">,</span>
  <span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">v</span><span class="p">.</span><span class="nx">line</span><span class="p">),</span>
  <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">file</span><span class="p">,</span>
<span class="p">);</span>
</code></pre></div></div><p>Then, to find the average of those, we‚Äôd use <code class="language-plaintext highlighter-rouge">d3.mean()</code> on the result:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">:</span> <span class="nx">averageFileLength</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">mean</span><span class="p">(</span><span class="nx">fileLengths</span><span class="p">,</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</code></pre></div></div><h4 id="minmax-value"> <a href="#minmax-value" class="anchor-heading" aria-labelledby="minmax-value"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Min/max value</h4><p>These involve finding not the min/max of a property itself, but another property of the row with the min/max value. This can apply both to the whole dataset and to groups.</p><p>Examples:</p><ul><li>Longest file<li>Longest line<li>Deepest line<li>Time of day (morning, afternoon, evening, night) that most work is done<li>Day of the week that most work is done</ul><p>For example, let‚Äôs try to calculate the time of day that the most work is done. We‚Äôd use <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl/DateTimeFormat/DateTimeFormat"><code class="language-plaintext highlighter-rouge">date.toLocaleString()</code></a> to get the time of day and use that as the grouping value:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">:</span> <span class="nx">workByPeriod</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">rollups</span><span class="p">(</span>
  <span class="nx">data</span><span class="p">,</span>
  <span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">v</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
  <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">datetime</span><span class="p">.</span><span class="nx">toLocaleString</span><span class="p">(</span><span class="dl">'</span><span class="s1">en</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">dayPeriod</span><span class="p">:</span> <span class="dl">'</span><span class="s1">short</span><span class="dl">'</span> <span class="p">}),</span>
<span class="p">);</span>
</code></pre></div></div><p>Then, to find the period with the most work, we‚Äôd use <a href="https://d3js.org/d3-array/summarize#greatest"><code class="language-plaintext highlighter-rouge">d3.greatest()</code></a> instead of <code class="language-plaintext highlighter-rouge">d3.max()</code> to get the entire element, then access the name of the period with <code class="language-plaintext highlighter-rouge">.[0]</code>:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">:</span> <span class="nx">maxPeriod</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">greatest</span><span class="p">(</span><span class="nx">workByPeriod</span><span class="p">,</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">])?.[</span><span class="mi">0</span><span class="p">];</span>
</code></pre></div></div><h2 id="step-2-visualizing-time-and-day-of-commits-in-a-scatterplot"> <a href="#step-2-visualizing-time-and-day-of-commits-in-a-scatterplot" class="anchor-heading" aria-labelledby="step-2-visualizing-time-and-day-of-commits-in-a-scatterplot"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2: Visualizing time and day of commits in a scatterplot</h2><p>Now let‚Äôs visualize our edits in a scatterplot with the time of day as the Y axis and the date as the X axis.</p><h3 id="step-21-drawing-the-dots"> <a href="#step-21-drawing-the-dots" class="anchor-heading" aria-labelledby="step-21-drawing-the-dots"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2.1: Drawing the dots</h3><p>First, let‚Äôs define a width and height for our coordinate space in our <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> block:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">width</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
  <span class="nx">height</span> <span class="o">=</span> <span class="mi">600</span><span class="p">;</span>
</code></pre></div></div><p>Then, in the HTML we add an <code class="language-plaintext highlighter-rouge">&lt;svg&gt;</code> element to hold our chart, and a suitable heading (e.g. ‚ÄúCommits by time of day‚Äù):</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;svg</span> <span class="na">viewBox=</span><span class="s">"0 0 {width} {height}"</span><span class="nt">&gt;</span>
  <span class="c">&lt;!-- scatterplot will go here --&gt;</span>
<span class="nt">&lt;/svg&gt;</span>
</code></pre></div></div><p>And a <code class="language-plaintext highlighter-rouge">&lt;style&gt;</code> element to hold styles:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;style&gt;</span>
  <span class="nt">svg</span> <span class="p">{</span>
    <span class="nl">overflow</span><span class="p">:</span> <span class="nb">visible</span><span class="p">;</span>
  <span class="p">}</span>
<span class="nt">&lt;/style&gt;</span>
</code></pre></div></div><p>Now, as shown in the <a href="https://vis-society.github.io/lectures/intro-svelte-d3.html">Web-based visualization lecture</a>, we create scales to map our data to the coordinate space using the <a href="https://d3js.org/d3-scale/linear">d3-scale</a> module.</p><p>We will need two scales: a Y scale for the times of day, and an X scale for the dates.</p><p>The Y scale (<code class="language-plaintext highlighter-rouge">yScale</code> variable) is a standard <a href="https://d3js.org/d3-scale/linear#scaleLinear">linear scale</a> that maps the hour of day (<code class="language-plaintext highlighter-rouge">0</code> to <code class="language-plaintext highlighter-rouge">24</code>) to the Y axis (0 to <code class="language-plaintext highlighter-rouge">height</code>).</p><p>But for the X scale (<code class="language-plaintext highlighter-rouge">xScale</code> variable), there‚Äôs a few things to unpack:</p><ul><li>Instead of a linear scale, which is meant for any type of quantitative data, We use a <a href="https://d3js.org/d3-scale/time"><em>time scale</em></a> which handles dates and times automagically. It works with JS <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date"><code class="language-plaintext highlighter-rouge">Date</code></a> objects, which we already have in the <code class="language-plaintext highlighter-rouge">datetime</code> property of each commit.<li>We can use <a href="https://d3js.org/d3-array#extent"><code class="language-plaintext highlighter-rouge">d3.extent()</code></a> to find the minimum and maximum date in our data in one fell swoop instead of computing it separately via <code class="language-plaintext highlighter-rouge">d3.min()</code> and <code class="language-plaintext highlighter-rouge">d3.max()</code>.<li>We can use <a href="https://d3js.org/d3-scale#continuous_nice"><code class="language-plaintext highlighter-rouge">scale.nice()</code></a> to extend the domain to the nearest ‚Äúnice‚Äù values (e.g. multiples of 5, 10, 15, etc. for numbers, or round dates to the nearest day, month, year, etc. for dates).</ul><p>Once we have both scales, we can draw the scatter plot by drawing circles with the appropriate coordinates inside our <code class="language-plaintext highlighter-rouge">&lt;svg&gt;</code> element:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;g</span> <span class="na">class=</span><span class="s">"dots"</span><span class="nt">&gt;</span>
  {#each commits as commit, index }
  <span class="nt">&lt;circle</span>
    <span class="na">cx=</span><span class="s">"{"</span>
    <span class="na">xScale</span><span class="err">(</span><span class="na">commit.datetime</span><span class="err">)</span>
    <span class="err">}</span>
    <span class="na">cy=</span><span class="s">"{"</span>
    <span class="na">yScale</span><span class="err">(</span><span class="na">commit.hourFrac</span><span class="err">)</span>
    <span class="err">}</span>
    <span class="na">r=</span><span class="s">"5"</span>
    <span class="na">fill=</span><span class="s">"steelblue"</span>
  <span class="nt">/&gt;</span>
  {/each}
<span class="nt">&lt;/g&gt;</span>
</code></pre></div></div><p class="note">The group (<code class="language-plaintext highlighter-rouge">&lt;g&gt;</code>) element is not necessary, but it helps keep the SVG structure a bit more organized once we start adding other visual elements.</p><p>If we preview at this point, we‚Äôll get something like this:</p><p><img src="/labs/lab07/images/dots.png" alt="" /></p><p>That was a bit anti-climactic! We did all this work and all we got was a bunch of dots?</p><p>Indeed, without axes, a scatterplot does not even look like a chart. Let‚Äôs add them!</p><h3 id="step-22-adding-axes"> <a href="#step-22-adding-axes" class="anchor-heading" aria-labelledby="step-22-adding-axes"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2.2: Adding axes</h3><p>As shown in lecture, the first step to add axes is to create space for them. We define margins in our JS:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">margin</span> <span class="o">=</span> <span class="p">{</span> <span class="na">top</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="na">right</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="na">bottom</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="na">left</span><span class="p">:</span> <span class="mi">20</span> <span class="p">};</span>
</code></pre></div></div><p>Then we adjust our scales to account for these margins by changing:</p><ul><li>The range of the X scale from <code class="language-plaintext highlighter-rouge">[0, width]</code> to <code class="language-plaintext highlighter-rouge">[margin.left, width - margin.right]</code><li>The range of the Y scale from <code class="language-plaintext highlighter-rouge">[height, 0]</code> to <code class="language-plaintext highlighter-rouge">[height - margin.bottom, margin.top]</code></ul><p>For readability and convenience, you can also define a <code class="language-plaintext highlighter-rouge">usableArea</code> variable to hold these bounds, since we‚Äôll later need them for other things too:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">usableArea</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">top</span><span class="p">:</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">top</span><span class="p">,</span>
  <span class="na">right</span><span class="p">:</span> <span class="nx">width</span> <span class="o">-</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">right</span><span class="p">,</span>
  <span class="na">bottom</span><span class="p">:</span> <span class="nx">height</span> <span class="o">-</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">bottom</span><span class="p">,</span>
  <span class="na">left</span><span class="p">:</span> <span class="nx">margin</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span>
<span class="p">};</span>
<span class="nx">usableArea</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">usableArea</span><span class="p">.</span><span class="nx">right</span> <span class="o">-</span> <span class="nx">usableArea</span><span class="p">.</span><span class="nx">left</span><span class="p">;</span>
<span class="nx">usableArea</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">usableArea</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">-</span> <span class="nx">usableArea</span><span class="p">.</span><span class="nx">top</span><span class="p">;</span>
</code></pre></div></div><p>Now the ranges become much more readable:</p><ul><li><code class="language-plaintext highlighter-rouge">[usableArea.left, usableArea.right]</code> for the X scale<li><code class="language-plaintext highlighter-rouge">[usableArea.bottom, usableArea.top]</code> for the Y scale</ul><p>Then we create <code class="language-plaintext highlighter-rouge">xAxis</code> and <code class="language-plaintext highlighter-rouge">yAxis</code> variables in our JS to hold our axes:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">xAxis</span><span class="p">,</span> <span class="nx">yAxis</span><span class="p">;</span>
</code></pre></div></div><p>and <code class="language-plaintext highlighter-rouge">&lt;g&gt;</code> elements that we bind to them:</p><div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nt">g</span> <span class="na">transform</span><span class="p">=</span><span class="s">"translate(0, {usableArea.bottom})"</span> <span class="na">bind</span><span class="err">:</span><span class="na">this</span><span class="p">=</span><span class="si">{</span><span class="nx">xAxis</span><span class="si">}</span> <span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">g</span> <span class="na">transform</span><span class="p">=</span><span class="s">"translate({usableArea.left}, 0)"</span> <span class="na">bind</span><span class="err">:</span><span class="na">this</span><span class="p">=</span><span class="si">{</span><span class="nx">yAxis</span><span class="si">}</span> <span class="p">/&gt;</span>
</code></pre></div></div><p class="caveat">Make sure these elements come <em>before</em> your dots, since SVG paints elements in the order they appear in the document, and you want your dots to be painted over anything else.</p><p>Then we use <code class="language-plaintext highlighter-rouge">d3.select()</code> to select these elements and apply the axes to them via <a href="https://d3js.org/d3-axis"><code class="language-plaintext highlighter-rouge">d3-axis</code></a> functions:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">xAxis</span><span class="p">,</span> <span class="nx">yAxis</span><span class="p">;</span>

<span class="nl">$</span><span class="p">:</span> <span class="p">{</span>
  <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">xAxis</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">axisBottom</span><span class="p">(</span><span class="nx">xScale</span><span class="p">));</span>
  <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">yAxis</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">axisLeft</span><span class="p">(</span><span class="nx">yScale</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div><p>If we view our scatterplot now, we‚Äôll see something like this:</p><p><img src="/labs/lab07/images/axes-basic.png" alt="" /></p><p>Much better, right?</p><p>But how does it work? Right click one of the points in the axes and select ‚ÄúInspect Element‚Äù. You will notice that the ticks are actually <code class="language-plaintext highlighter-rouge">&lt;g&gt;</code> elements with <code class="language-plaintext highlighter-rouge">&lt;text&gt;</code> elements inside them.</p><p><img src="images/ticks.png" alt="Dev tools screenshot" class="browser" data-url="http://localhost:5173/meta" /></p><p>Only thing that remains is to actually format the Y axis to look like actual times. We can do that using the <a href="https://d3js.org/d3-axis#axis_tickFormat"><code class="language-plaintext highlighter-rouge">axis.tickFormat()</code></a> method:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">yAxis</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span>
  <span class="nx">d3</span>
    <span class="p">.</span><span class="nx">axisLeft</span><span class="p">(</span><span class="nx">yScale</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">tickFormat</span><span class="p">((</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nb">String</span><span class="p">(</span><span class="nx">d</span> <span class="o">%</span> <span class="mi">24</span><span class="p">).</span><span class="nx">padStart</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="dl">'</span><span class="s1">0</span><span class="dl">'</span><span class="p">)</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">:00</span><span class="dl">'</span><span class="p">),</span>
<span class="p">);</span>
</code></pre></div></div><blockquote class="fyi"><p>What is this function actually doing? Let‚Äôs break it down:</p><ul><li><code class="language-plaintext highlighter-rouge">d % 24</code> uses the remainder operator (<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Remainder"><code class="language-plaintext highlighter-rouge">%</code></a>) to get <code class="language-plaintext highlighter-rouge">0</code> instead of <code class="language-plaintext highlighter-rouge">24</code> for midnight (we could have done <code class="language-plaintext highlighter-rouge">d === 24? 0 : d</code> instead)<li><code class="language-plaintext highlighter-rouge">String(d % 24)</code> converts the number to a string<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/padStart"><code class="language-plaintext highlighter-rouge">string.padStart()</code></a> formats it as a two digit number Finally, we append <code class="language-plaintext highlighter-rouge">":00"</code> to it to make it look like a time.</ul></blockquote><p class="note">D3 provides a host of date/time formatting helpers in the <a href="https://d3js.org/d3-time-format"><code class="language-plaintext highlighter-rouge">d3-time-format</code></a> module, however for this case, simple string manipulation is actually easier.</p><p>The result looks like this:</p><p><img src="/labs/lab07/images/y-axis-formatted.png" alt="Screenshot of the scatter plot with formatted Y axis" /></p><h3 id="step-23-adding-horizontal-grid-lines"> <a href="#step-23-adding-horizontal-grid-lines" class="anchor-heading" aria-labelledby="step-23-adding-horizontal-grid-lines"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 2.3: Adding horizontal grid lines</h3><p>Axes already improved our plot tenfold (it now looks like an actual scatterplot for one!) but it‚Äôs still hard to see what X and Y values each dot corresponds to.</p><p>Let‚Äôs add grid lines to make it easier to read the plot at a glance.</p><p class="caveat">When adding grid lines, there are a few tradeoffs to consider. You want to make them prominent enough to assist in reading the chart, but not so prominent that they add clutter and distract from the data itself. Err on the side of fewer, fainter grid lines rather than dense and darker ones.</p><p>We will only create horizontal grid lines for simplicity, but you can easily add vertical ones too if you want (but be extra mindful of visual clutter).</p><p>Conceptually, there is no D3 primitive specifically for grid lines. Grid lines are basically just axes with no labels and <em>freakishly</em> long ticks. üòÅ</p><p>So we add grid lines in a very similar way to how we added axes, but we use the <code class="language-plaintext highlighter-rouge">tickSize</code> method to make the lines extend across the whole chart.</p><p>Just like with the axes, we create a JS variable to hold the axis (I called it <code class="language-plaintext highlighter-rouge">yAxisGridlines</code>), and use a reactive statement that starts off identical to the one for our <code class="language-plaintext highlighter-rouge">yScale</code>. However, instead of a proper <code class="language-plaintext highlighter-rouge">tickFormat()</code> that actually formats axis labels, we use <code class="language-plaintext highlighter-rouge">tickFormat("")</code> to <em>remove</em> the labels. Thenm we use the <a href="https://d3js.org/d3-axis#axis_tickSize"><code class="language-plaintext highlighter-rouge">axis.tickSize()</code></a> method with a tick size of <code class="language-plaintext highlighter-rouge">-usableArea.width</code> to make the lines extend across the whole chart (the <code class="language-plaintext highlighter-rouge">-</code> is to flip them).</p><p>We also need to create a <code class="language-plaintext highlighter-rouge">&lt;g&gt;</code> element to hold the grid lines. Let‚Äôs give it a class of <code class="language-plaintext highlighter-rouge">gridlines</code> so we can style it later:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;g</span>
  <span class="na">class=</span><span class="s">"gridlines"</span>
  <span class="na">transform=</span><span class="s">"translate({usableArea.left}, 0)"</span>
  <span class="na">bind:this=</span><span class="s">"{yAxisGridlines}"</span>
<span class="nt">/&gt;</span>
</code></pre></div></div><p class="caveat">Make sure that your <code class="language-plaintext highlighter-rouge">&lt;g&gt;</code> element for the grid lines comes <em>before</em> the <code class="language-plaintext highlighter-rouge">&lt;g&gt;</code> element for the Y axis, as you want the grid lines to be painted <em>under</em> the axis, not <em>over</em> it.</p><p>So far, we‚Äôve only recreated our Y axis but without the formatting. How do we turn that into grid lines? First, we will use <a href="https://d3js.org/d3-axis#axis_tickFormat"><code class="language-plaintext highlighter-rouge">axis.tickFormat()</code></a> again, but this time to <em>remove</em> the text:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">:</span> <span class="p">{</span>
  <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">yAxisGridlines</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">axisLeft</span><span class="p">(</span><span class="nx">yScale</span><span class="p">).</span><span class="nx">tickFormat</span><span class="p">(</span><span class="dl">''</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div><p>Then, we use the <a href="https://d3js.org/d3-axis#axis_tickSize"><code class="language-plaintext highlighter-rouge">axis.tickSize()</code></a> method to make the lines extend across the whole chart:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">:</span> <span class="p">{</span>
  <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">yAxisGridlines</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span>
    <span class="nx">d3</span><span class="p">.</span><span class="nx">axisLeft</span><span class="p">(</span><span class="nx">yScale</span><span class="p">).</span><span class="nx">tickFormat</span><span class="p">(</span><span class="dl">''</span><span class="p">).</span><span class="nx">tickSize</span><span class="p">(</span><span class="o">-</span><span class="nx">usableArea</span><span class="p">.</span><span class="nx">width</span><span class="p">),</span>
  <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>If we look now, we already have grid lines, but they look a bit too prominent.</p><p>Let‚Äôs add some CSS to fix this:</p><div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">.gridlines</span> <span class="p">{</span>
  <span class="py">stroke-opacity</span><span class="p">:</span> <span class="m">0.2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>Much better now!</p><figure><p><img src="/labs/lab07/images/gridlines-black.png" alt="" /> <img src="/labs/lab07/images/gridlines.png" alt="" /></p><figcaption> The grid lines before and after `stroke-opacity`.</figcaption></figure><p class="caveat">Do not use <code class="language-plaintext highlighter-rouge">.gridlines line</code>, <code class="language-plaintext highlighter-rouge">.gridlines .tick line</code> or any other descendant selector to style the lines: Svelte <a href="https://github.com/sveltejs/svelte/issues/10844">thinks it‚Äôs unused CSS and removes it</a>!</p><p class="further">Coloring each line based on the time of day, with bluer colors for night times and orangish ones for daytime? üòÅ</p><h2 id="step-3-adding-a-tooltip"> <a href="#step-3-adding-a-tooltip" class="anchor-heading" aria-labelledby="step-3-adding-a-tooltip"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 3: Adding a tooltip</h2><p>Even with the gridlines, it‚Äôs still hard to see what each dot corresponds to. Let‚Äôs add a tooltip that shows information about the commit when you hover over a dot.</p><h3 id="step-31-static-element"> <a href="#step-31-static-element" class="anchor-heading" aria-labelledby="step-31-static-element"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 3.1: Static element</h3><p>First, we‚Äôll render the data in an HTML element, and once we‚Äôre sure eveyrthing works well, we‚Äôll make it look like a tooltip.</p><p>Similarly to <a href="../6/#step-52-highlighting-selected-wedge">Step 5.2</a> of the previous lab, when we were selecting a pie wedge, we will now use with a <code class="language-plaintext highlighter-rouge">hoveredIndex</code> variable to hold the index of the hovered commit, and a <code class="language-plaintext highlighter-rouge">hoveredCommit</code> variable that is reactively updated every time a commit is hovered and holds the data we want to display in the tooltip:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">hoveredIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="nl">$</span><span class="p">:</span> <span class="nx">hoveredCommit</span> <span class="o">=</span> <span class="nx">commits</span><span class="p">[</span><span class="nx">hoveredIndex</span><span class="p">]</span> <span class="p">??</span> <span class="nx">hoveredCommit</span> <span class="p">??</span> <span class="p">{};</span>
</code></pre></div></div><p>Then, in our SVG, we add <code class="language-plaintext highlighter-rouge">mouseenter</code> and <code class="language-plaintext highlighter-rouge">mouseleave</code> event listeners on each circle:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- Other attributes/directives not shown for brevity --&gt;</span>
<span class="nt">&lt;circle</span> <span class="na">on:mouseenter=</span><span class="s">{evt</span> <span class="err">=</span><span class="nt">&gt;</span> hoveredIndex = index} on:mouseleave={evt =&gt;
hoveredIndex = -1} /&gt;
</code></pre></div></div><p class="note">Ignore the accessibility warnings for now, we will get to them once we get the base functionality working.</p><p>Now add an element to display data about the hovered commit:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;dl</span> <span class="na">id=</span><span class="s">"commit-tooltip"</span> <span class="na">class=</span><span class="s">"info tooltip"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;dt&gt;</span>Commit<span class="nt">&lt;/dt&gt;</span>
  <span class="nt">&lt;dd&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"{ hoveredCommit.url }"</span> <span class="na">target=</span><span class="s">"_blank"</span><span class="nt">&gt;</span>{ hoveredCommit.id }<span class="nt">&lt;/a&gt;</span>
  <span class="nt">&lt;/dd&gt;</span>

  <span class="nt">&lt;dt&gt;</span>Date<span class="nt">&lt;/dt&gt;</span>
  <span class="nt">&lt;dd&gt;</span>{ hoveredCommit.datetime?.toLocaleString("en", {dateStyle: "full"}) }<span class="nt">&lt;/dd&gt;</span>

  <span class="c">&lt;!-- Add: Time, author, lines edited --&gt;</span>
<span class="nt">&lt;/dl&gt;</span>
</code></pre></div></div><p>In the CSS, we add two rules:</p><ul><li><code class="language-plaintext highlighter-rouge">dl.info</code> with grid layout so that the <code class="language-plaintext highlighter-rouge">&lt;dt&gt;</code>s are on the 1st column and the <code class="language-plaintext highlighter-rouge">&lt;dd&gt;</code>s on the 2nd, remove their default margins, and apply some styling to make the labels less prominent than the values.<li><code class="language-plaintext highlighter-rouge">.tooltip</code> with <code class="language-plaintext highlighter-rouge">position: fixed</code> to it and <code class="language-plaintext highlighter-rouge">top: 1em;</code> and <code class="language-plaintext highlighter-rouge">left: 1em;</code> to place it at the top left of the viewport so we can see it regardless of scroll status.</ul><p class="note">Why not just add everything on a single CSS rule? Because this way we can reuse the <code class="language-plaintext highlighter-rouge">.info</code> class for other <code class="language-plaintext highlighter-rouge">&lt;dl&gt;</code>s that are not tooltips and the <code class="language-plaintext highlighter-rouge">.tooltip</code> class for other tooltips that are not <code class="language-plaintext highlighter-rouge">&lt;dl&gt;</code>s.</p><p class="fyi">What‚Äôs the difference between <code class="language-plaintext highlighter-rouge">fixed</code> and <code class="language-plaintext highlighter-rouge">absolute</code> <a href="https://developer.mozilla.org/en-US/docs/Learn/CSS/CSS_layout/Positioning">positioning</a>? <code class="language-plaintext highlighter-rouge">position: fixed</code> positions the element relative to the <a href="https://developer.mozilla.org/en-US/docs/Glossary/Viewport"><em>viewport</em></a>, while <code class="language-plaintext highlighter-rouge">position: absolute</code> positions it relative to the nearest positioned ancestor (or the root element if there is none). The position offsets are specified via <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/top"><code class="language-plaintext highlighter-rouge">top</code></a>, <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/right"><code class="language-plaintext highlighter-rouge">right</code></a>, <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/bottom"><code class="language-plaintext highlighter-rouge">bottom</code></a>, and <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/left"><code class="language-plaintext highlighter-rouge">left</code></a> properties (or their shorthand, <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/inset"><code class="language-plaintext highlighter-rouge">inset</code></a>) In practice, it means that <code class="language-plaintext highlighter-rouge">position: fixed</code> elements stay in the same place even when you scroll, while <code class="language-plaintext highlighter-rouge">position: absolute</code> elements scroll with the rest of the page.</p><p>We should also apply some hover styles on the dots, e.g to smoothly make them bigger when hovered we can do something like this:</p><div class="language-scss highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">circle</span> <span class="p">{</span>
  <span class="nl">transition</span><span class="p">:</span> <span class="m">200ms</span><span class="p">;</span>

  <span class="k">&amp;</span><span class="nd">:hover</span> <span class="p">{</span>
    <span class="nl">transform</span><span class="p">:</span> <span class="nf">scale</span><span class="p">(</span><span class="m">1</span><span class="mi">.5</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>If you preview now, you will see some weirdness (slowed down by 10x):</p><p><img src="/labs/lab07/images/hover-weirdness.gif" alt="" /></p><p>This is because in SVG by default the origin of transforms is the top left corner of the coordinate system. To fix that and set the origin to the center of the dot itself, we need two properties:</p><div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">transform-origin</span><span class="o">:</span> <span class="nt">center</span><span class="o">;</span>
<span class="nt">transform-box</span><span class="o">:</span> <span class="nt">fill-box</span><span class="o">;</span>
</code></pre></div></div><p>The hover effect now looks far more reasonable:</p><p><img src="/labs/lab07/images/hover-fixed.gif" alt="" /></p><p>Overall, at the end of this step, we should have something like this:</p><video src="videos/hover-info.mp4" muted="" loop="" autoplay="" class="browser" data-url="http://localhost:5173/meta"></video><h3 id="step-32-making-it-look-like-a-tooltip"> <a href="#step-32-making-it-look-like-a-tooltip" class="anchor-heading" aria-labelledby="step-32-making-it-look-like-a-tooltip"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 3.2: Making it look like a tooltip</h3><p>Seeing this info is already useful, but it‚Äôs not really a tooltip yet. There are three components to making our <code class="language-plaintext highlighter-rouge">&lt;dl&gt;</code> an actual tooltip:</p><ol><li>Styling it like a tooltip (e.g. giving it a shadow that makes it look raised from the page)<li>Making it only appear when we are hovering over a dot (Step 3.3)<li>Positioning it near the mouse cursor (Step 3.4)</ol><p>I will do them in that order, but these are largely independent tasks that can be done in either order. If anything, doing 3 before 1 and 2 might help motivate them better.</p><p>In terms of styling, you should definitely give it a <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/background-color"><code class="language-plaintext highlighter-rouge">background-color</code></a> as otherwise the text will be hard to read. You can either go for a solid color (e.g. <code class="language-plaintext highlighter-rouge">white</code>) or a semi-transparent color (e.g. <code class="language-plaintext highlighter-rouge">oklch(100% 0% 0 / 80%)</code>) that will show some of the chart behind it.</p><p>A few other useful CSS properties are:</p><ul><li><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/box-shadow"><code class="language-plaintext highlighter-rouge">box-shadow</code></a> for shadows. <strong>Avoid overly prominent shadows</strong>: you are trying to make it look elevated, not to decorate it. The shadow should not be distracting, but just enough to make it look like it‚Äôs floating above the page. Generally, the larger the blur radius and the more transparent the color, the more raised the element will look. Experiment with different values to see what looks best for your design.<li><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/border-radius"><code class="language-plaintext highlighter-rouge">border-radius</code></a> for rounded corners<li><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/backdrop-filter"><code class="language-plaintext highlighter-rouge">backdrop-filter</code></a> to blur what‚Äôs underneath (frosted glass effect). This is only relevant if you have a semi-transparent background color.</ul><p>You would also probably want to add some spacing between its content and the edges of the tooltip, i.e. <code class="language-plaintext highlighter-rouge">padding</code>.</p><figure><p><img src="/labs/lab07/images/tooltip-styling.gif" alt="" /></p><figcaption> Example before and after.</figcaption></figure><h3 id="step-33-making-only-appear-when-we-are-hovering-over-a-dot"> <a href="#step-33-making-only-appear-when-we-are-hovering-over-a-dot" class="anchor-heading" aria-labelledby="step-33-making-only-appear-when-we-are-hovering-over-a-dot"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 3.3: Making only appear when we are hovering over a dot</h3><p>Currently, our tooltip appears even when it has no content, which is quite jarring. It also appears when we are not hovering over any dot, and just shows the previous content. That‚Äôs not too bad when it‚Äôs fixed at the top left of the viewport, but can you picture how annoying this would be if it was an actual tooltip that just won‚Äôt take a hint and go away?</p><p>We <em>could</em> wrap the whole tooltip with an <code class="language-plaintext highlighter-rouge">{#if hoveredIndex &gt; -1 }...{/if}</code> block and it would work. However, that‚Äôs not very flexible. It makes it hard to use transition effects when the tooltip disappears (because it‚Äôs gone immediately), make it disappear with a delay to allow users to interact with it, or not disappear at all if users are actively interacting with it (hovering it or focusing elements within it).</p><p>Instead, we will use the HTML <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Global_attributes/hidden"><code class="language-plaintext highlighter-rouge">hidden</code></a> attribute:</p><div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nt">dl</span> <span class="na">class</span><span class="p">=</span><span class="s">"info"</span> <span class="na">hidden</span><span class="p">=</span><span class="si">{</span><span class="nx">hoveredIndex</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="si">}</span><span class="p">&gt;</span>
</code></pre></div></div><p>and add some CSS to hide the element by fading it out:</p><div class="language-scss highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">dl</span><span class="nc">.info</span> <span class="p">{</span>
  <span class="cm">/* ... other styles ... */</span>
  <span class="nl">transition-duration</span><span class="p">:</span> <span class="m">500ms</span><span class="p">;</span>
  <span class="nl">transition-property</span><span class="p">:</span> <span class="n">opacity</span><span class="o">,</span> <span class="n">visibility</span><span class="p">;</span>

  <span class="k">&amp;</span><span class="o">[</span><span class="nt">hidden</span><span class="o">]</span><span class="nd">:not</span><span class="o">(</span><span class="nd">:hover</span><span class="o">,</span> <span class="nd">:focus-within</span><span class="o">)</span> <span class="p">{</span>
    <span class="nl">opacity</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="nl">visibility</span><span class="p">:</span> <span class="nb">hidden</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div><p>It should now behave like this:</p><video src="videos/tooltip-showhide.mp4" loop="" autoplay="" muted=""></video><h3 id="step-34-positioning-the-tooltip-near-the-mouse-cursor"> <a href="#step-34-positioning-the-tooltip-near-the-mouse-cursor" class="anchor-heading" aria-labelledby="step-34-positioning-the-tooltip-near-the-mouse-cursor"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 3.4: Positioning the tooltip near the mouse cursor</h3><p>Now, the final piece of the puzzle to make this element into an actual tooltip!</p><p>Our tooltip is currently positioned at the top left corner of the viewport (actually <code class="language-plaintext highlighter-rouge">1em</code> from the top and <code class="language-plaintext highlighter-rouge">1em</code> from the left) in a hardcoded way, via the <code class="language-plaintext highlighter-rouge">top</code> and <code class="language-plaintext highlighter-rouge">left</code> properties. To position it near the mouse cursor instead, we need to set these properties <em>dynamically</em> based on the mouse position.</p><p>Thankfully, the event object on mouse events has several properties that give us the mouse position relative to different things. To get the mouse position relative to the viewport, we can use the <code class="language-plaintext highlighter-rouge">x</code> and <code class="language-plaintext highlighter-rouge">y</code> properties of the event object.</p><p>We will declare a new variable in our JS and use it to store the last recorded mouse position:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="p">{</span> <span class="na">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">y</span><span class="p">:</span> <span class="mi">0</span> <span class="p">};</span>
</code></pre></div></div><p>Then, we will update it in our <code class="language-plaintext highlighter-rouge">mouseenter</code> event listener:</p><div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="err">!--</span> <span class="na">Other</span> <span class="na">attributes</span><span class="err">/</span><span class="na">directives</span> <span class="na">not</span> <span class="na">shown</span> <span class="na">for</span> <span class="na">brevity</span><span class="err">/</span><span class="na">clarity</span> <span class="err">--</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">circle</span>
	<span class="na">on</span><span class="err">:</span><span class="na">mouseenter</span><span class="p">=</span><span class="si">{</span><span class="nx">evt</span> <span class="o">=&gt;</span> <span class="p">{</span>
		<span class="nx">hoveredIndex</span> <span class="o">=</span> <span class="nx">index</span><span class="p">;</span>
		<span class="nx">cursor</span> <span class="o">=</span> <span class="p">{</span><span class="na">x</span><span class="p">:</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="na">y</span><span class="p">:</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">y</span><span class="p">};</span>
	<span class="p">}</span><span class="si">}</span>
<span class="p">/&gt;</span>
</code></pre></div></div><p>Print it out in your HTML via <code class="language-plaintext highlighter-rouge">{JSON.stringify(cursor, null, "\t")}</code> and move the mouse around to make sure it works!</p><p><img src="images/cursor-object.gif" class="outline" alt="" /></p><p>As with all these debug statements, don‚Äôt forget to remove it once you verify it works.</p><p>Now let‚Äôs use these to set <code class="language-plaintext highlighter-rouge">top</code> and <code class="language-plaintext highlighter-rouge">left</code> on the tooltip:</p><div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nt">dl</span> <span class="na">class</span><span class="p">=</span><span class="s">"info"</span> <span class="na">hidden</span><span class="p">=</span><span class="si">{</span><span class="nx">hoveredIndex</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="si">}</span> <span class="na">style</span><span class="p">=</span><span class="s">"top: {cursor.y}px; left: {cursor.x}px"</span><span class="p">&gt;</span>
</code></pre></div></div><p>This is the result:</p><video src="videos/tooltip-cursor.mp4" loop="" autoplay="" muted=""></video><p class="note">While we directly set <code class="language-plaintext highlighter-rouge">top</code> and <code class="language-plaintext highlighter-rouge">left</code> for simplicity, we usually want to avoid setting CSS properties directly. It‚Äôs more flexible to set custom properties that we then use in our CSS. For example, assume you wanted to subtly move the shadow as the mouse pointer moves to create more sense of depth (<a href="https://en.wikipedia.org/wiki/Parallax">parallax</a>). If we had custom properties with the mouse coordinates, we could just use them in other properties too, whereas here we‚Äôd have to set the <code class="language-plaintext highlighter-rouge">box-shadow</code> with inline styles too.</p><h3 id="step-35-bulletproof-positioning-optional"> <a href="#step-35-bulletproof-positioning-optional" class="anchor-heading" aria-labelledby="step-35-bulletproof-positioning-optional"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 3.5: Bulletproof positioning (optional)</h3><p>Our na√Øve approach to positioning the tooltip near the mouse cursor by setting the <code class="language-plaintext highlighter-rouge">top</code> and <code class="language-plaintext highlighter-rouge">left</code> CSS properties works well if the tooltip is small and the mouse is near the center of the viewport. However, if the tooltip is near the edges of the viewport, it falls apart.</p><p>Try it yourself: dock the dev tools at the bottom of the window and make them tall enough that you can scroll the page. Now hover over a dot near the bottom of the page. Can you see the tooltip?</p><p><img src="images/positioning-problem.png" alt="" class="outline" /></p><p>Solving this on our own is actually an incredibly complicated problem in the general case. Thankfully, there are many wonderful packages that solve it for us. We will use <a href="https://floating-ui.com/">Floating UI</a> here.</p><p>First, we install it via npm:</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install</span> @floating-ui/dom
</code></pre></div></div><p>Then, we import the three functions we will need from it:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">computePosition</span><span class="p">,</span> <span class="nx">autoPlacement</span><span class="p">,</span> <span class="nx">offset</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@floating-ui/dom</span><span class="dl">'</span><span class="p">;</span>
</code></pre></div></div><p>Just like D3, Floating UI is not Svelte-specific and works with DOM elements. Therefore, just like we did for the axes in Step 4.2, we will use <code class="language-plaintext highlighter-rouge">bind:this</code> to bind a variable to the tooltip element:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">commitTooltip</span><span class="p">;</span>
</code></pre></div></div><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- Other attributes omitted for brevity --&gt;</span>
<span class="nt">&lt;dl</span> <span class="na">class=</span><span class="s">"info"</span> <span class="na">bind:this=</span><span class="s">"{commitTooltip}"</span><span class="nt">&gt;&lt;/dl&gt;</span>
</code></pre></div></div><p>Then, we will use <a href="https://floating-ui.com/docs/computePosition"><code class="language-plaintext highlighter-rouge">computePosition()</code></a> to compute the position of the tooltip based on the mouse position and the size of the tooltip. This function returns a Promise that resolves to an object with properties like <code class="language-plaintext highlighter-rouge">x</code> and <code class="language-plaintext highlighter-rouge">y</code> that we can use in our CSS instead of <code class="language-plaintext highlighter-rouge">cursor</code>. Therefore, let‚Äôs create a new variable to hold the position of the tooltip that we will update in our <code class="language-plaintext highlighter-rouge">mouseenter</code> event listener.:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">tooltipPosition</span> <span class="o">=</span> <span class="p">{</span> <span class="na">x</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">y</span><span class="p">:</span> <span class="mi">0</span> <span class="p">};</span>
</code></pre></div></div><p>Since the code of this event listener is growing way beyond a single line expression, it‚Äôs time to move it to a function. This is also a good chance to address those accessibility warnings we ignored earlier.</p><p>Create a new <code class="language-plaintext highlighter-rouge">dotInteraction()</code> function in your JS that takes the index of the dot and the event object as arguments:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">dotInteraction</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// code will go here</span>
<span class="p">}</span>
</code></pre></div></div><p>We‚Äôll try something different this time: instead of creating separate functions for each event, we will invoke the same function for all events, and read <code class="language-plaintext highlighter-rouge">evt.type</code> to determine what to do. Instead of only handling mouse events, we will also handle <code class="language-plaintext highlighter-rouge">focus</code> and <code class="language-plaintext highlighter-rouge">blur</code> events, to make our tooltip accessible to keyboard users.</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">mouseenter</span><span class="dl">'</span> <span class="o">||</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">focus</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// dot hovered</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">mouseleave</span><span class="dl">'</span> <span class="o">||</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">blur</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// dot unhovered</span>
<span class="p">}</span>
</code></pre></div></div><p>Move your existing event listener code (modifying <code class="language-plaintext highlighter-rouge">hoveredIndex</code>) within the <code class="language-plaintext highlighter-rouge">dotInteraction()</code> function, and then update your event listeners to call that instead:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- Other attributes/directives not shown for brevity --&gt;</span>
<span class="nt">&lt;circle</span> <span class="na">on:mouseenter=</span><span class="s">{evt</span> <span class="err">=</span><span class="nt">&gt;</span> dotInteraction(index, evt)} on:mouseleave={evt =&gt;
dotInteraction(index, evt)} /&gt;
</code></pre></div></div><p>To fix the accessibility issues, we should also add:</p><ul><li><code class="language-plaintext highlighter-rouge">tabindex="0"</code> to the dots to make them focusable<li><code class="language-plaintext highlighter-rouge">aria-describedby="commit-tooltip"</code> to the dots to link them to the tooltip for assistive technology<li><code class="language-plaintext highlighter-rouge">role="tooltip"</code> to the tooltip to indicate its purpose to assistive technology<li><code class="language-plaintext highlighter-rouge">aria-haspopup="true"</code> to the dots to indicate that they have a tooltip<li><code class="language-plaintext highlighter-rouge">on:focus</code> and <code class="language-plaintext highlighter-rouge">on:blur</code> event listeners (that also call <code class="language-plaintext highlighter-rouge">dotInteraction()</code>)</ul><p>Back to the <code class="language-plaintext highlighter-rouge">dotInvoked()</code> function, we can use <a href="https://developer.mozilla.org/en-US/docs/Web/API/Event/target"><code class="language-plaintext highlighter-rouge">evt.target</code></a> to get the dot that was hovered over:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">hoveredDot</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">target</span><span class="p">;</span>
</code></pre></div></div><p>Now, in the block that handles the <code class="language-plaintext highlighter-rouge">mouseenter</code>/<code class="language-plaintext highlighter-rouge">focus</code> events, let‚Äôs use <a href="https://floating-ui.com/docs/computePosition"><code class="language-plaintext highlighter-rouge">computePosition()</code></a> to compute the position of the tooltip based on the position of the dot.</p><p>Another advantage of moving our code to a separate function is that we can mark this function as <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/async_function"><code class="language-plaintext highlighter-rouge">async</code></a>, which will allow us to use <code class="language-plaintext highlighter-rouge">await</code> inside it. This is helpful because <a href="https://floating-ui.com/docs/computePosition"><code class="language-plaintext highlighter-rouge">computePosition()</code></a> returns a <code class="language-plaintext highlighter-rouge">Promise</code> that resolves to the position of the tooltip.</p><p>This is what it looks like:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">tooltipPosition</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">computePosition</span><span class="p">(</span><span class="nx">hoveredDot</span><span class="p">,</span> <span class="nx">commitTooltip</span><span class="p">,</span> <span class="p">{</span>
  <span class="na">strategy</span><span class="p">:</span> <span class="dl">'</span><span class="s1">fixed</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// because we use position: fixed</span>
  <span class="na">middleware</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">offset</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="c1">// spacing from tooltip to dot</span>
    <span class="nx">autoPlacement</span><span class="p">(),</span> <span class="c1">// see https://floating-ui.com/docs/autoplacement</span>
  <span class="p">],</span>
<span class="p">});</span>
</code></pre></div></div><p>Your function should now look like:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="kd">function</span> <span class="nx">dotInteraction</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// your code</span>
<span class="p">}</span>
</code></pre></div></div><p class="note">We won‚Äôt go into much detail on the API of Floating UI, so it‚Äôs ok to just copy the code above. However, if you want to learn more, their <a href="https://floating-ui.com/docs/getting-started">docs</a> are excellent.</p><p>Lastly, replace <code class="language-plaintext highlighter-rouge">cursor</code> with <code class="language-plaintext highlighter-rouge">tooltipPosition</code> in the <code class="language-plaintext highlighter-rouge">style</code> attribute of the tooltip to actually use this new object.</p><p>If you preview now, you should see that the tooltip is always visible and positioned near the hovered dot, regardless of where it is relative to the viewport.</p><video src="videos/tooltip-final.mp4" loop="" autoplay="" muted="" class="browser" data-url="http://localhost:5173/meta"></video><p>At this point you can also remove the <code class="language-plaintext highlighter-rouge">cursor</code> variable and the code setting it, since we don‚Äôt need it anymore, unless there are other things you want to do where knowing the mouse position is useful.</p><h2 id="step-4-communicating-lines-edited-via-the-size-of-the-dots-optional"> <a href="#step-4-communicating-lines-edited-via-the-size-of-the-dots-optional" class="anchor-heading" aria-labelledby="step-4-communicating-lines-edited-via-the-size-of-the-dots-optional"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 4: Communicating lines edited via the size of the dots (optional)</h2><p>Note that the tiniest of edits are currently represented by the same size of dot as the largest of edits. It is common to use the size of the dots to communicate a third variable, in this case the number of lines each commit edited.</p><h3 id="step-41-calculating-our-scale"> <a href="#step-41-calculating-our-scale" class="anchor-heading" aria-labelledby="step-41-calculating-our-scale"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 4.1: Calculating our scale</h3><p>We will need to define a new scale to map the number of lines edited to the radius of the dots. This means we need to first‚Ä¶</p><ol><li>Decide on the minimum and maximum radii we want to allow. Edit the circle <code class="language-plaintext highlighter-rouge">r</code> attribute and play around with different radii to decide. I settled on <code class="language-plaintext highlighter-rouge">2</code> and <code class="language-plaintext highlighter-rouge">30</code>.<li>Calculate the range of values for number of lines edited by a single commit. As with <a href="#step-41-drawing-the-dots">Step 4.1</a>, we can use <a href="https://d3js.org/d3-array#extent"><code class="language-plaintext highlighter-rouge">d3.extent()</code></a> to find the minimum and maximum value in one go.</ol><p>Then define a new linear scale (I called it <code class="language-plaintext highlighter-rouge">rScale</code>) using <a href="https://d3js.org/d3-scale/linear"><code class="language-plaintext highlighter-rouge">d3.scaleLinear()</code></a> mapping the domain of the number of lines edited to the range of radii we decided on.</p><p>Then, in our HTML, instead of a hardcoded <code class="language-plaintext highlighter-rouge">5</code>, set the circle radius to <code class="language-plaintext highlighter-rouge">rScale(commit.totalLines)</code>.</p><p>If everything went well, you should now see that the dots are now different sizes depending on the number of lines of each!</p><p>As one last tweak, apply <code class="language-plaintext highlighter-rouge">fill-opacity</code> to the dots to make them more transparent, since the larger they are, the more likely to overlap. You can only apply it when the dots are <em>not</em> hovered, as an extra cue.</p><p><img src="/labs/lab07/images/r-var-linear.png" alt="Screenshot" /></p><h3 id="step-42-area-not-radius"> <a href="#step-42-area-not-radius" class="anchor-heading" aria-labelledby="step-42-area-not-radius"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 4.2: Area, not radius</h3><p>Hover over a few circles and pay attention to the number of lines they correspond to. What do you notice? The size of the dots is not very good at communicating the number of lines edited. This is because the area of a circle is proportional to the square of its radius (A = œÄr¬≤), so <strong>a commit with double the edits appears four times as large</strong>!</p><p>To fix this, we will use a different type of scale: a <a href="https://d3js.org/d3-scale/pow#scaleSqrt">square root scale</a>. A square root scale is a type of power scale that uses the square root of the input domain value to calculate the output range value. Thankfully, the API is very similar to the linear scale we used before, so all we need to do to fix the issue is to just change the function name.</p><figure><p><img src="/labs/lab07/images/r-var-linear.png" alt="Screenshot" /> <img src="/labs/lab07/images/r-var.png" alt="Screenshot" /></p><figcaption> Before and after</figcaption></figure><h3 id="step-43-paint-smaller-dots-over-larger-ones"> <a href="#step-43-paint-smaller-dots-over-larger-ones" class="anchor-heading" aria-labelledby="step-43-paint-smaller-dots-over-larger-ones"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 4.3: Paint smaller dots over larger ones</h3><p>You may notice that when dots are overlapping, it‚Äôs sometimes harder to hover over the smaller ones, if they happen to be painted underneath the larger one.</p><p>One way to fix this is to sort commits in descending order of <code class="language-plaintext highlighter-rouge">totalLines</code>, which will ensure the smaller dots are painted last. To do that, we can use the <a href="https://d3js.org/d3-array/sort#sort"><code class="language-plaintext highlighter-rouge">d3.sort()</code></a> method. This would go in your <code class="language-plaintext highlighter-rouge">onMount()</code> callback:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">commits</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">commits</span><span class="p">,</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="nx">d</span><span class="p">.</span><span class="nx">totalLines</span><span class="p">);</span>
</code></pre></div></div><p>Why the minus? Because <code class="language-plaintext highlighter-rouge">d3.sort()</code> sorts in ascending order by default, and we want descending order, and that‚Äôs shorter than writing a custom comparator function.</p><h2 id="step-5-brushing"> <a href="#step-5-brushing" class="anchor-heading" aria-labelledby="step-5-brushing"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 5: Brushing</h2><p>In the <a href="../6/">previous lab</a>, we selected single pie segments by clicking. As discussed in the <a href="../../lectures/interaction-zoo.html">A Tour through the Interaction Zoo</a> lecture, brushing can be an effective interaction technique for selecting <em>multiple</em> data points in a visualization.</p><p>Once points are selected, we can further explore the dataset by displaying more data.</p><h3 id="step-51-setting-up-the-brush"> <a href="#step-51-setting-up-the-brush" class="anchor-heading" aria-labelledby="step-51-setting-up-the-brush"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 5.1: Setting up the brush</h3><p>Exactly because brushing is so fundamental to interactive charts, D3 provides a module called <a href="https://d3js.org/d3-brush"><code class="language-plaintext highlighter-rouge">d3-brush</code></a> to facilitate just that.</p><p>To use it, we need a reference to our <code class="language-plaintext highlighter-rouge">&lt;svg&gt;</code> element, so we use <code class="language-plaintext highlighter-rouge">bind:this</code> as we‚Äôve done several in this lab. Let‚Äôs call the variable <code class="language-plaintext highlighter-rouge">svg</code>.</p><p>We then create the brush via:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">:</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">svg</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">brush</span><span class="p">());</span>
</code></pre></div></div><p>Try it! You should already be able to drag a rectangle around the chart, even though it doesn‚Äôt <em>do</em> anything yet.</p><p><img src="images/brush-noop.gif" alt="" class="outline" /></p><p>Exciting!</p><h3 id="step-52-getting-our-tooltips-back"> <a href="#step-52-getting-our-tooltips-back" class="anchor-heading" aria-labelledby="step-52-getting-our-tooltips-back"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 5.2: Getting our tooltips back</h3><p>Did you notice that now that we can brush, our tooltips disappeared? üò± What happened?!</p><p>If you inspect the chart, you will find the culprit:</p><p><img src="images/brush-overlay.png" alt="" class="browser" /></p><p>So what is happening here? To make the brush work, <strong>D3 adds a rectangle overlay over the entire chart that catches all mouse events</strong>. Because of this, our circles never get hovered, and thus our tooltips never show.</p><p>Since SVG elements are painted in source order, to fix this we need the overlay to come before the dots in the DOM tree. D3 provides a <a href="https://d3js.org/d3-selection/modifying#selection_raise"><code class="language-plaintext highlighter-rouge">selection.raise()</code></a> method that moves one or more elements to the end of their parent, maintaining their relative order.</p><p>Therefore, to move the overlay to be before the dots, we will ‚Äúraise‚Äù the dots and everything that comes <em>after</em> the overlay.</p><p>First, let‚Äôs convert the single-line reactive statement to a reactive block:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">:</span> <span class="p">{</span>
  <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">svg</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">brush</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div><p>Then, inside the reactive block, after the brush is created, we raise the dots and everything after the overlay:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">svg</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="dl">'</span><span class="s1">.dots, .overlay ~ *</span><span class="dl">'</span><span class="p">).</span><span class="nx">raise</span><span class="p">();</span>
</code></pre></div></div><p class="fyi">That‚Äôs a funny looking selector, isn‚Äôt it? The <code class="language-plaintext highlighter-rouge">~</code> is the CSS <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/Subsequent-sibling_combinator"><em>subsequent sibling combinator</em></a> and it selects elements that come <em>after</em> the selector that precedes it (and share the same parent).</p><p>Try it: you should now see that the tooltips are back, and the brush still works!</p><h3 id="step-53-styling-the-selection-rectangle-optional"> <a href="#step-53-styling-the-selection-rectangle-optional" class="anchor-heading" aria-labelledby="step-53-styling-the-selection-rectangle-optional"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 5.3: Styling the selection rectangle (optional)</h3><p>The overlay is not the only element added by <code class="language-plaintext highlighter-rouge">d3.brush()</code>. For example, there is a <code class="language-plaintext highlighter-rouge">&lt;rect class="selection&gt;</code> element that is used to depict the brush selection. This means you can use CSS to style it!</p><p>Just make sure to use the <a href="https://svelte.dev/docs/svelte-components#style">Svelte-specific <code class="language-plaintext highlighter-rouge">:global()</code> pseudo-class</a> around <code class="language-plaintext highlighter-rouge">.selection</code> otherwise Svelte will drop the whole rule, as it thinks it‚Äôs unused CSS.</p><p>Here‚Äôs what I did, but feel free to experiment with your own styles:</p><div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@keyframes</span> <span class="n">marching-ants</span> <span class="p">{</span>
  <span class="nt">to</span> <span class="p">{</span>
    <span class="py">stroke-dashoffset</span><span class="p">:</span> <span class="m">-8</span><span class="p">;</span> <span class="c">/* 5 + 3 */</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nt">svg</span> <span class="nd">:global</span><span class="o">(</span><span class="nc">.selection</span><span class="o">)</span> <span class="p">{</span>
  <span class="py">fill-opacity</span><span class="p">:</span> <span class="m">10%</span><span class="p">;</span>
  <span class="py">stroke</span><span class="p">:</span> <span class="no">black</span><span class="p">;</span>
  <span class="py">stroke-opacity</span><span class="p">:</span> <span class="m">70%</span><span class="p">;</span>
  <span class="py">stroke-dasharray</span><span class="p">:</span> <span class="m">5</span> <span class="m">3</span><span class="p">;</span>
  <span class="nl">animation</span><span class="p">:</span> <span class="n">marching-ants</span> <span class="m">2s</span> <span class="n">linear</span> <span class="n">infinite</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><video src="videos/marching-ants.mp4" loop="" autoplay="" muted=""></video><h3 id="step-54-making-the-brush-actually-select-dots"> <a href="#step-54-making-the-brush-actually-select-dots" class="anchor-heading" aria-labelledby="step-54-making-the-brush-actually-select-dots"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 5.4: Making the brush actually select dots</h3><p>So far we can draw a selection, but it neither does anything, nor does it look like it does anything.</p><p>The first step is to actually figure out what the user has selected, both in terms of visual shapes (dots) so we can style them as selected, as well as in terms of data (commits) so we can do something with it.</p><p><a href="https://d3js.org/d3-brush#brush"><code class="language-plaintext highlighter-rouge">d3.brush()</code></a> returns a brush object, which actually fires <a href="https://d3js.org/d3-brush#brush-events">events</a> when the brush is moved. We can use <a href="https://d3js.org/d3-dispatch#dispatch_on"><code class="language-plaintext highlighter-rouge">.on()</code></a> to listen to these events and do something when they happen.</p><p>Let‚Äôs start by simply logging them to the console. Let‚Äôs define a function called <code class="language-plaintext highlighter-rouge">brushed()</code> that takes an event object as an argument and logs it to the console:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">brushed</span><span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">evt</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div><p>Then, we use <code class="language-plaintext highlighter-rouge">.on()</code> to call this function when the brush is moved:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">svg</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">brush</span><span class="p">().</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">start brush end</span><span class="dl">'</span><span class="p">,</span> <span class="nx">brushed</span><span class="p">));</span>
</code></pre></div></div><p>This line can replace your existing <code class="language-plaintext highlighter-rouge">d3.select(svg).call(d3.brush())</code> code.</p><p>Open your browser console (if it‚Äôs not already open) and try brushing again. You should see a flurry of events logged to the console, a bit like this:</p><video src="videos/brush-events.mp4" loop="" muted="" autoplay="" class="browser" data-url="http://localhost:5173/meta"></video><p>Try exploring these objects by clicking on the ‚ñ∏ next to them.</p><p>You may notice that the <code class="language-plaintext highlighter-rouge">selection</code> property of the event object is an array of two points. These points represent the top-left and bottom-right corners of the brush rectangle. This array is the key to understanding what the user has selected.</p><p>Let‚Äôs create a new reactive variable that stores this selection array. I called it <code class="language-plaintext highlighter-rouge">brushSelection</code>. Then, inside the <code class="language-plaintext highlighter-rouge">brushed()</code> function, we set <code class="language-plaintext highlighter-rouge">brushSelection</code> to <code class="language-plaintext highlighter-rouge">evt.selection</code>.</p><p>If we can implement a function that tells us if a commit is selected:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">isCommitSelected</span><span class="p">(</span><span class="nx">commit</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">brushSelection</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// TODO return true if commit is within brushSelection</span>
  <span class="c1">// and false if not</span>
<span class="p">}</span>
</code></pre></div></div><p>We can then use this function to apply a <code class="language-plaintext highlighter-rouge">selected</code> class to the dots that are selected via a <a href="https://svelte.dev/docs/element-directives#class-name"><code class="language-plaintext highlighter-rouge">class:selected</code> directive</a>.</p><p>The core idea for the logic is to use our existing <code class="language-plaintext highlighter-rouge">xScale</code> and <code class="language-plaintext highlighter-rouge">yScale</code> scales to map the commit data to X and Y coordinates, and then check if these coordinates are within the brush selection bounds.</p><p class="tip">Another way to do it is to use the D3 <a href="https://d3js.org/d3-scale/linear#linear_invert"><code class="language-plaintext highlighter-rouge">scale.invert()</code></a> to map the selection bounds to data, and then compare data values, which can be faster if you have a lot of data, since you only need to convert the bounds once.</p><p>Can you figure out how to do it?</p><details> <summary>Show solution</summary><p>There are many ways to implement this logic, but here‚Äôs one:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">min</span> <span class="o">=</span> <span class="p">{</span> <span class="na">x</span><span class="p">:</span> <span class="nx">brushSelection</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="na">y</span><span class="p">:</span> <span class="nx">brushSelection</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">};</span>
<span class="kd">let</span> <span class="nx">max</span> <span class="o">=</span> <span class="p">{</span> <span class="na">x</span><span class="p">:</span> <span class="nx">brushSelection</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="na">y</span><span class="p">:</span> <span class="nx">brushSelection</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">};</span>
<span class="kd">let</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">xScale</span><span class="p">(</span><span class="nx">commit</span><span class="p">.</span><span class="nx">date</span><span class="p">);</span>
<span class="kd">let</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">yScale</span><span class="p">(</span><span class="nx">commit</span><span class="p">.</span><span class="nx">hourFrac</span><span class="p">);</span>
<span class="k">return</span> <span class="nx">x</span> <span class="o">&gt;=</span> <span class="nx">min</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">x</span> <span class="o">&lt;=</span> <span class="nx">max</span><span class="p">.</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">y</span> <span class="o">&gt;=</span> <span class="nx">min</span><span class="p">.</span><span class="nx">y</span> <span class="o">&amp;&amp;</span> <span class="nx">y</span> <span class="o">&lt;=</span> <span class="nx">max</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
</code></pre></div></div></details><p>The last piece of the puzzle is to add some stylng in your CSS to make the selected dots stand out. I gave them a different fill color, but the sky is the limit!</p><video src="videos/selection.mp4" loop="" autoplay="" muted=""></video><h3 id="step-54-showing-count-of-selected-commits"> <a href="#step-54-showing-count-of-selected-commits" class="anchor-heading" aria-labelledby="step-54-showing-count-of-selected-commits"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 5.4: Showing count of selected commits</h3><p>So far, we have only been visually highlighting the selected commits, but not actually doing anything with it. Brushing is useful because it helps us interactively explore the dataset by isolating selecting different subsets.</p><p>As a first step, let‚Äôs display the number of selected commits.</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">:</span> <span class="nx">selectedCommits</span> <span class="o">=</span> <span class="nx">brushSelection</span> <span class="p">?</span> <span class="nx">commits</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">isCommitSelected</span><span class="p">)</span> <span class="p">:</span> <span class="p">[];</span>
<span class="nl">$</span><span class="p">:</span> <span class="nx">hasSelection</span> <span class="o">=</span> <span class="nx">brushSelection</span> <span class="o">&amp;&amp;</span> <span class="nx">selectedCommits</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
</code></pre></div></div><p>Now let‚Äôs display the number of selected commits in the HTML, under the chart:</p><div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;p&gt;</span>{hasSelection ? selectedCommits.length : "No"} commits selected<span class="nt">&lt;/p&gt;</span>
</code></pre></div></div><p>If it works, it should look a bit like this:</p><video src="videos/selected-commit-count.mp4" muted="" loop="" autoplay=""></video><h3 id="step-55-showing-breakdown-of-languages-across-all-lines-edited-in-selected-commits"> <a href="#step-55-showing-breakdown-of-languages-across-all-lines-edited-in-selected-commits" class="anchor-heading" aria-labelledby="step-55-showing-breakdown-of-languages-across-all-lines-edited-in-selected-commits"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 5.5: Showing breakdown of languages across all lines edited in selected commits</h3><p>Brushing is particularly useful when dealing with connected data, such as our commits and lines of code.</p><p>Let‚Äôs display stats about the proportion of languages in the lines edited in the selected commits.</p><p>We will need to define a new reactive variable (I called it <code class="language-plaintext highlighter-rouge">selectedLines</code>) that holds the lines edited in the selected commits (or all commits if no/empty selection):</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">$</span><span class="p">:</span> <span class="nx">selectedLines</span> <span class="o">=</span> <span class="p">(</span><span class="nx">hasSelection</span> <span class="p">?</span> <span class="nx">selectedCommits</span> <span class="p">:</span> <span class="nx">commits</span><span class="p">).</span><span class="nx">flatMap</span><span class="p">(</span>
  <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">lines</span><span class="p">,</span>
<span class="p">);</span>
</code></pre></div></div><p>Then, we can use it to calculate the number of edited lines per language using <a href="https://d3js.org/d3-array/group#rollup"><code class="language-plaintext highlighter-rouge">d3.rollup()</code></a> (or <a href="https://d3js.org/d3-array/group#rollups"><code class="language-plaintext highlighter-rouge">d3.rollups()</code></a>), which <a href="#grouped-aggregates">we discussed earlier</a>. Assign the result to a new reactive variable called <code class="language-plaintext highlighter-rouge">languageBreakdown</code>.</p><p>Then, we can display the result in the HTML by iterating over <code class="language-plaintext highlighter-rouge">languageBreakdown</code> via an <code class="language-plaintext highlighter-rouge">{#each}</code> block and displaying the language and the proportion of lines edited in it.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{#each languageBreakdown as [language, lines] }
	&lt;!-- Display stats here --&gt;
{/each}
</code></pre></div></div><p>Some pointers:</p><ul><li>Use <code class="language-plaintext highlighter-rouge">lines / selectedLines.length</code> to calculate the proportion of lines edited in each language.<li><a href="https://d3js.org/d3-format"><code class="language-plaintext highlighter-rouge">d3-format</code></a> can be quite helpful for formatting numbers nicely. I used a <code class="language-plaintext highlighter-rouge">".1~%"</code> <a href="https://d3js.org/d3-format#locale_format">format specifier</a> to display the proportion as a percentage with one decimal place.</ul><p>If everything went well, you should see something like this:</p><video src="videos/lang-breakdown.mp4" autoplay="" loop="" muted=""></video><h3 id="step-56-drawing-a-pie-chart-of-the-language-breakdown"> <a href="#step-56-drawing-a-pie-chart-of-the-language-breakdown" class="anchor-heading" aria-labelledby="step-56-drawing-a-pie-chart-of-the-language-breakdown"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Step 5.6: Drawing a pie chart of the language breakdown</h3><p>The language breakdown is useful, but it‚Äôs not very visual. Reading numbers doesn‚Äôt make it easy to gauge the relative proportions of the different languages.</p><p>A pie chart is much better at this, but at this point we are probably way too tired to draw another chart. Thankfully, we already have a pie chart from the previous lab that we can reuse!</p><p>All we need to do is to import it in our JS:</p><div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">Pie</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">$lib/Pie.svelte</span><span class="dl">'</span><span class="p">;</span>
</code></pre></div></div><p>and then we can use it in our HTML to display the language breakdown as a pie chart. All we need to do is transform our data into an array of <code class="language-plaintext highlighter-rouge">{label, value}</code> objects, which we can do using the expression <code class="language-plaintext highlighter-rouge">Array.from(languageBreakdown).map(([language, lines]) =&gt; ({label: language, value: lines}))</code> and pass this array to its <code class="language-plaintext highlighter-rouge">data</code> prop:</p><div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">&lt;</span><span class="nc">Pie</span> <span class="na">data</span><span class="p">=</span><span class="si">{</span><span class="cm">/* array of {label, value} objects */</span><span class="si">}</span> <span class="p">/&gt;</span>
</code></pre></div></div><p class="further">While we‚Äôre at it, we could also write JS to convert <code class="language-plaintext highlighter-rouge">language</code> to a more readable label.</p><p>The final result looks like this:</p><video src="videos/final.mp4" loop="" autoplay="" muted="" class="browser" data-url="http://localhost:5173/meta"></video><p class="further">If you want to go further, you can think about how to make the scatterplot we made in this lab similarly reusable as a separate <code class="language-plaintext highlighter-rouge">&lt;Scatterplot&gt;</code> component.</p><hr /><div class="footnotes" role="doc-endnotes"><ol><li id="fn:eachcommit" role="doc-endnote"><p>Actually, it will only include commits that still have an effect on the codebase, since it‚Äôs based on lines of code that are currently present in the codebase. Therefore if all a commit did was change lines that have since been edited by other commits, that commit will not show up here. If we wanted to include <em>all</em> commits, we‚Äôd need to process the output of <a href="https://git-scm.com/docs/git-log"><code class="language-plaintext highlighter-rouge">git log</code></a> instead, but that is outside the scope of this lab.¬†<a href="#fnref:eachcommit" class="reversefootnote" role="doc-backlink">&#8617;</a></p></ol></div></div></div><div class="search-overlay"></div></div>
